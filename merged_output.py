#==============================================================================
# MERGED PYTHON FILES
# Generated by merge_py_files.py
#
# Source: D:\Projects\DesktopLobby2.0
# Excluded: test_*.py, test.py, __init__.py (可配置)
#==============================================================================

###########################################################################
# File: AI_test.py
# Path: D:\Projects\DesktopLobby2.0\AI_test.py
###########################################################################

#from database.database import *
from AI.AI_control import AI

a=AI('qwen4b', {'NAME': "qwen4b", "PATH": "AI/qwen/qwen1_5-4b-chat-q4_k_m.gguf"})
#db_delete_conversation_record(0, character='mi')
while True:
    x=input()
    if x == 's':
        break
    elif x == 'b':
        a.b = True
    else:
        print('结果', a.generate_result({'user_content': x, 'current_character': 'momoi', 'example': "老师，我要玩游戏！！！！！#smile#"}, debug=True))

###########################################################################
# File: DesktopLobby.py
# Path: D:\Projects\DesktopLobby2.0\DesktopLobby.py
###########################################################################

from PyQt5.QtCore import Qt, QTimer, QObject, pyqtSignal, QThread
from PyQt5.QtWidgets import QLabel, QVBoxLayout, QMainWindow, QComboBox, QCheckBox, QDialog, QSlider, QLineEdit, QApplication, QDesktopWidget, QWidget, QMessageBox, QGraphicsOpacityEffect
from PIL import ImageQt
import sys
import time
import pygame as pg
from random import randrange
from math import sin
import os
import socket
import signal
import importlib.util
from getResources import *
from renderDialogBox import *
from playAnims import PlayAnims
names=getCharacterNames()
perferences=getPerferences()
contrast=getContrast()
pg.init()
pg.mixer.init()

app = QApplication(sys.argv)
app.setQuitOnLastWindowClosed(True)
screen = QDesktopWidget().screenGeometry()
k00=min(screen.width()/1600, screen.height()/900) * 1.1962
class Communicator(QObject):
    # 创建一个信号类，用于传递数据
    data_signal = pyqtSignal(object)

# 创建一个线程类来监听套接字
class SocketListener(QThread):
    def __init__(self, comm):
        super().__init__()
        self.comm = comm
    def run(self, address=10000):
        # 创建套接字服务器
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.bind(('localhost', address))
            sock.listen(1)
            while True:
                conn, addr = sock.accept()
                data = conn.recv(1024)
                if data:
                    message = data.decode().strip()
                    self.comm.data_signal.emit(message)
                    data=None
                time.sleep(0.2)
        except:
            if address < 10009:
                self.run(address=address+1)

def main(name, firstTime=False):
    perferences=getPerferences()

    scriptpath=os.path.join(os.path.dirname(__file__), "characters", name, "getCharacter.py")
    spec=importlib.util.spec_from_file_location("getCharacter", scriptpath)
    moudle=importlib.util.module_from_spec(spec)
    spec.loader.exec_module(moudle)
    
    pictures, settings = moudle.getCharacter(name)
    haloHeight=settings.get('haloHeight', 100)
    emotions=sorted(pictures.keys())
    emotions.remove('halo')
    k0=settings.get('k', 1)*k00
    dialogBoxContent = getDialogBoxContent(name)
    def setopacity(label, opacity):
        effect=QGraphicsOpacityEffect()
        label.setGraphicsEffect(effect)
        effect.setOpacity(opacity)

    class ImageWindow(QMainWindow):
        def __init__(self):
            super().__init__()
            self.layout=QVBoxLayout()
            # 设置无边框和透明背景
            self.setWindowFlags(Qt.FramelessWindowHint)
            self.setAttribute(Qt.WA_TranslucentBackground, True)
            
            self.haloPos=settings['halo']
            self.t=0
            self.k=k0
            self.movable=False
            self.closable=True
            self.canblink=settings['defaultBlinkEyes']
            self.candialog=settings['defaultDialog']
            self.vvolume=perferences["defaultVoiceVolume"]
            self.dialogBoxImages={}
            for key, content in dialogBoxContent.items():
                dialogBoxX, dialogTextX = render_Lobby_balloon(content[0])
                self.dialogBoxImages[key] = [dialogBoxX.resize(tuple(int(x*k00/1.1962) for x in dialogBoxX.size)),
                                            dialogTextX.resize(tuple(int(x*k00/1.1962) for x in dialogTextX.size)), content[1]]
            self.anims={}
            for animName in perferences['animNames']:
                self.anims[animName]=PlayAnims(animName)
            self.playable=False
            self.currentEmotion=emotions[settings['defaultEmotionIndex']]
            self.image0=pictures[self.currentEmotion]
            self.haloImage=pictures['halo']
            
            self.halo=QLabel('halo', self)
            self.halo.setPixmap(ImageQt.toqpixmap(self.haloImage))
            self.halo.setFixedSize(self.haloImage.width, self.haloImage.height)
            self.halo.move(self.haloPos[0], self.haloPos[1])
            self.layout.addWidget(self.halo)
            self.size0=(self.image0.width, self.image0.height+haloHeight)
            self.resize(self.size0[0], self.size0[1])

            self.body=QLabel('body', self)
            self.body.setPixmap(ImageQt.toqpixmap(self.image0))
            self.body.setFixedSize(self.image0.width, self.image0.height)
            self.body.move((self.width() - self.image0.width)/2, (self.height() - self.image0.height+haloHeight)/2)
            self.layout.addWidget(self.body)
            self.setLayout(self.layout)
            
            self.move(settings['characterPos'][0] *k00/1.1962, settings['characterPos'][1] *k00/1.1962)
            self.sizeChange(k00)
            self.fixedupdate = QTimer(self)
            self.fixedupdate.timeout.connect(self.frameUpdate)
            self.t0=0
            self.fixedupdate.start(1000/30)
            
            self.dialogboxwindow = DialogBoxWindow(self.dialogBoxImages)
            self.dialogboxwindow.show()

            self.settingwindow = SettingWindow()
            self.settingwindow.Emotioncommunicator.data_signal.connect(self.update)
            self.settingwindow.Blinkcommunicator.data_signal.connect(self.canblinkchanged)
            self.settingwindow.Dialogcommunicator.data_signal.connect(self.candialogchanged)
            self.settingwindow.Movecommunicator.data_signal.connect(self.movablechanged)
            self.settingwindow.Sizecommunicator.data_signal.connect(self.sizeChange)
            self.settingwindow.Sizecommunicator.data_signal.connect(self.dialogboxwindow.sizeposChange)
            self.settingwindow.Closecommunicator.data_signal.connect(self.closablechanged)
            self.settingwindow.Levelcommunicator.data_signal.connect(self.levelchanged)
            self.settingwindow.VVolumecommunicator.data_signal.connect(self.dialogboxwindow.vvolumeChanged)
            self.settingwindow.VVolumecommunicator.data_signal.connect(self.vvolumeChanged)
            self.settingwindow.Charactercommunicator.data_signal.connect(self.characterChanged)
            self.dialogboxwindow.timeCommunicator.data_signal.connect(self.playingAnim)

            self.DFvsHAFcommunicator=Communicator()
            self.DFvsHAFcommunicator.data_signal.connect(self.signalReceived)
            if firstTime:
                try:
                    self.socketThread=SocketListener(self.DFvsHAFcommunicator)
                    self.socketThread.start()
                except:
                    pass
            if self.candialog:
                self.dialog(settings["login"])
        def canblinkchanged(self, data):
            self.canblink = True if data == 2 else False
        def candialogchanged(self, data):
            self.candialog = True if data == 2 else False
        def movablechanged(self, data):
            self.movable = True if data == 2 else False
            self.settingwindow.dialogCheck.setChecked(False)
            self.settingwindow.dialogCheck.setCheckable(not self.movable)
        def closablechanged(self, data):
            self.closable = True if data == 2 else False
        def levelchanged(self, data):
            if data == 2:
                self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(Qt.FramelessWindowHint|Qt.Tool|Qt.WindowStaysOnTopHint)
                self.show()
            else:
                self.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.show()
        def vvolumeChanged(self, data):
            self.vvolume=data/100
        def update(self, data, changeCurrentEmotion=True):
            if changeCurrentEmotion:
                self.currentEmotion=data
            self.image0=pictures[data]
            self.image1=self.image0.resize(tuple(int(x*self.k) for x in self.image0.size))
            self.body.setPixmap(ImageQt.toqpixmap(self.image1))

        def frameUpdate(self, blinkingtime=settings['blinkingTime'], deltablinktime=settings['deltaBlinkTime']):
            if self.t0 == 0:
                self.t0 = time.time()
                self.sblinktime=0
            t=time.time()-self.t0
            dy=sin(t/2)*5*self.k/1.1962
            self.halo.move(self.haloPos[0]*self.k, self.haloPos[1]*self.k+dy)
            if self.canblink:
                if t-self.sblinktime > blinkingtime:
                    self.update(self.currentEmotion)
                    self.sblinktime=t+blinkingtime+999999
                if t % deltablinktime < 1/30 or t % deltablinktime > deltablinktime-1/30:
                    self.update("eyeclose", changeCurrentEmotion=False)
                    self.sblinktime=t
        def signalReceived(self, message):
            self.candialog=self.canblink=False
            indexType={'fail': "emotionWhenFailingIndex"}[message]
            try:
                self.settingwindow.dialogCheck.setChecked(False)
                self.settingwindow.blinkCheck.setChecked(False)
                if indexType in settings.keys():
                    self.settingwindow.emotionCombo.setCurrentIndex(settings[indexType])
            except Exception as e:
                print(e)
            self.update(emotions[settings[indexType]] if indexType in settings.keys() else self.currentEmotion)

            try:
                namefile=name if name.isupper() else name.capitalize()
                voice = pg.mixer.Sound(f"audios/JP_{namefile}/{name}_battle_retire.ogg")
            except:
                voice = pg.mixer.Sound("audios/mute.ogg")
            voice.set_volume(self.vvolume)
            voice.play()
        def dialog(self, indexes):
            index=indexes[randrange(0, len(indexes))]
            emotion=[next((s for s in emotions if s.startswith(dialogBoxContent[inde.split('|')[0]][1])), None) for inde in index]
            self.dialogboxwindow.showDB(index, emotion)

        def playingAnim(self, data):
            if self.dialogboxwindow.aniName:
                if data == 0 and not self.playable:
                    self.pos0 = (self.frameGeometry().topLeft().x(), self.frameGeometry().topLeft().y())
                result, self.playable = self.anims[self.dialogboxwindow.aniName].play(data, Pratio=(0.5, 0.5))
                if self.playable:
                    deltaPos=result['position']
                    self.move(self.pos0[0]+deltaPos[0]*self.k, self.pos0[1]+deltaPos[1]*self.k)
                else:
                    self.move(self.pos0[0], self.pos0[1])
        def sizeChange(self, data):
            self.k = data*settings.get('k', 1)#1.1962
            fixedBody=self.image0.resize(tuple(int(x*self.k) for x in self.image0.size)) 
            fixedHalo=self.haloImage.resize(tuple(int(x*self.k) for x in self.haloImage.size))
            self.resize(self.size0[0]*self.k, self.size0[1]*self.k)
            self.halo.setPixmap(ImageQt.toqpixmap(fixedHalo))
            self.halo.setFixedSize(fixedHalo.size[0], fixedHalo.size[1])
            self.halo.move(self.haloPos[0]*self.k, self.haloPos[1]*self.k)

            self.body.setPixmap(ImageQt.toqpixmap(fixedBody))
            self.body.setFixedSize(fixedBody.size[0], fixedBody.size[1])
            self.body.move(0, haloHeight*self.k)

        def mousePressEvent(self, event):
            if self.candialog and event.button() == Qt.LeftButton:
                self.dialog(settings["lobby"])
            if self.candialog and event.button() == Qt.RightButton:
                self.dialog(settings["login"])
            if self.movable and event.button() == Qt.LeftButton:
                self.dragging=True
                self.dragPosition=event.globalPos()-self.frameGeometry().topLeft()
                event.accept()
        def mouseMoveEvent(self, event):
            if self.movable and Qt.LeftButton and self.dragging:
                self.move(event.globalPos()-self.dragPosition)
                event.accept()
        def mouseReleaseEvent(self, event):
            if self.movable and event.button() == Qt.LeftButton:
                self.dragging=False
                self.dialogboxwindow.sizeposChange(self.k / settings.get('k', 1))
                event.accept()
        def keyPressEvent(self, event):
            if event.key() == 69:   #E
                self.settingwindow.show()
        def closeEvent(self, event):
            if not self.closable:
                event.ignore()
            else:
                self.dialogboxwindow.fixedupdate.stop()
                self.fixedupdate.stop()
                self.settingwindow.destroy()
                self.dialogboxwindow.destroy()
                self.dialogboxwindow.voice.stop()
                pg.mixer.music.stop()
                pg.mixer.quit()
                pg.quit()
                QApplication.quit()
        def characterChanged(self, data):
            self.dialogboxwindow.fixedupdate.stop()
            self.fixedupdate.stop()
            self.settingwindow.destroy()
            self.dialogboxwindow.destroy()
            self.dialogboxwindow.voice.stop()
            self.destroy()
            del(self.dialogboxwindow, self.settingwindow, self)
            setCurrentCharacter(data.lower())
            main(name=data.lower())
    class SettingWindow(QDialog):
        def __init__(self):
            super().__init__()
            self.setWindowTitle('Settings')
            self.setGeometry(100, 100, 200, 150)
            #self.setWindowFlags(Qt.Tool)

            self.Emotioncommunicator = Communicator()
            self.Blinkcommunicator = Communicator()
            self.Dialogcommunicator = Communicator()
            self.Movecommunicator = Communicator()
            self.Sizecommunicator = Communicator()
            self.Closecommunicator = Communicator()
            self.Levelcommunicator = Communicator()
            self.VVolumecommunicator = Communicator()
            self.Charactercommunicator = Communicator()

            layout=QVBoxLayout()

            self.emotionCombo = QComboBox()
            self.emotionCombo.addItems(emotions)
            self.emotionCombo.setCurrentIndex(settings['defaultEmotionIndex'])
            layout.addWidget(self.emotionCombo)

            self.blinkCheck = QCheckBox("Blinking eyes", self)
            self.blinkCheck.setChecked(settings['defaultBlinkEyes'])
            layout.addWidget(self.blinkCheck)

            self.dialogCheck = QCheckBox("Dialog", self)
            self.dialogCheck.setChecked(settings['defaultDialog'])
            layout.addWidget(self.dialogCheck)

            moveCheck = QCheckBox("Movable", self)
            moveCheck.setChecked(False)
            layout.addWidget(moveCheck)

            layout.addStretch(1)
            
            sizemessage = QLabel('Size')
            layout.addWidget(sizemessage)

            self.Sslider = QSlider(Qt.Horizontal)
            self.Sslider.setMinimum(1000)
            self.Sslider.setMaximum(30000)
            self.Sslider.setSingleStep(1)
            self.Sslider.setValue(int(k00 *10000))
            layout.addWidget(self.Sslider)

            self.numbox = QLineEdit()
            self.numbox.setText(str(k00))
            layout.addWidget(self.numbox)

            closeCheck = QCheckBox("Closable", self)
            closeCheck.setChecked(True)
            layout.addWidget(closeCheck)

            levelCheck = QCheckBox("Always at the Top Level", self)
            levelCheck.setChecked(False)
            layout.addWidget(levelCheck)

            layout.addStretch(1)
            
            message1 = QLabel('BGM volume')
            layout.addWidget(message1)

            self.Bslider = QSlider(Qt.Horizontal)
            self.Bslider.setMinimum(0)
            self.Bslider.setMaximum(100)
            self.Bslider.setSingleStep(1)
            self.Bslider.setValue(perferences["defaultBGMVolume"]*100)
            layout.addWidget(self.Bslider)
            pg.mixer.music.set_volume(perferences["defaultBGMVolume"])

            message2 = QLabel('Voice volume')
            layout.addWidget(message2)

            self.Vslider = QSlider(Qt.Horizontal)
            self.Vslider.setMinimum(0)
            self.Vslider.setMaximum(100)
            self.Vslider.setSingleStep(1)
            self.Vslider.setValue(perferences["defaultVoiceVolume"]*100)
            layout.addWidget(self.Vslider)

            characterCombo = QComboBox()
            fixedNames=[contrast.get(x, x) if contrast.get(x, x).isupper() else contrast.get(x, x).capitalize() for x in names]
            characterCombo.addItems(fixedNames)
            currentcharacter=getCurrentCharacter()
            characterCombo.setCurrentText(contrast.get(currentcharacter, currentcharacter).capitalize())
            layout.addWidget(characterCombo)

            self.setLayout(layout)
            self.emotionCombo.currentIndexChanged.connect(lambda: self.Emotioncommunicator.data_signal.emit(self.emotionCombo.currentText()))
            self.blinkCheck.stateChanged.connect(lambda state: self.Blinkcommunicator.data_signal.emit(state))
            self.dialogCheck.stateChanged.connect(lambda state: self.Dialogcommunicator.data_signal.emit(state))
            moveCheck.stateChanged.connect(lambda state: self.Movecommunicator.data_signal.emit(state))
            closeCheck.stateChanged.connect(lambda state: self.Closecommunicator.data_signal.emit(state))
            levelCheck.stateChanged.connect(lambda state: self.Levelcommunicator.data_signal.emit(state))

            self.Sslider.valueChanged.connect(self.update_numbox)
            self.numbox.textChanged.connect(self.update_Sslider)

            self.Bslider.valueChanged.connect(lambda value: pg.mixer.music.set_volume(value/100))
            self.Vslider.valueChanged.connect(lambda value: self.VVolumecommunicator.data_signal.emit(value))

            characterCombo.currentIndexChanged.connect(lambda: self.Charactercommunicator.data_signal.emit(names[characterCombo.currentIndex()]))
        def update_numbox(self, value):
            double_value = value / 10000.0
            self.numbox.setText(str(double_value))
            self.Sizecommunicator.data_signal.emit(double_value)

        def update_Sslider(self, value):
            try:
                fvalue=min(max(float(value), 0.1), 3.0)
                int_value = int(fvalue * 10000)
                self.Sslider.setValue(int_value)
                self.numbox.setText(str(fvalue))
                self.Sizecommunicator.data_signal.emit(fvalue)
            except ValueError:
                pass

    class DialogBoxWindow(QWidget):
        def __init__(self, dialogBoxImages):
            super().__init__()
            self.k=k00
            self.dialogBoxImages=dialogBoxImages
            self.voiceVolume=perferences["defaultVoiceVolume"]
            self.timeCommunicator=Communicator()
            self.aniName=None

            layout=QVBoxLayout()
            # 设置无边框和透明背景
            self.setWindowModality(Qt.NonModal)
            self.setWindowFlags(Qt.FramelessWindowHint|Qt.ToolTip)
            self.setAttribute(Qt.WA_TranslucentBackground, True)
            self.setGeometry(settings["dialogBoxPos"][0]*self.k/1.1962, settings["dialogBoxPos"][1]*self.k/1.1962, 1, 1)
            self.boxlabel=QLabel(self)
            self.boxlabel.setGeometry(0, 0, 1, 1)
            layout.addWidget(self.boxlabel)

            self.textlabel=QLabel(self)
            self.textlabel.setGeometry(0, 0, 1, 1)
            layout.addWidget(self.textlabel)
        def vvolumeChanged(self, data):
            self.voiceVolume=data/100
        def showDB(self, indexes, emotions, order=0):
            self.indexes=indexes
            self.emotions=emotions
            self.order=order
            index=self.indexes[self.order]
            if '|' in index:
                index, self.aniName = index.split('|')
            else:
                self.aniName = None
            self.emotion=self.emotions[self.order]
            self.dialogBox0=self.dialogBoxImages[index][0]
            dialogBox=self.dialogBox0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogBox0.size))
            self.dialogText0=self.dialogBoxImages[index][1]
            dialogText=self.dialogText0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogText0.size))
            PdialogBox=ImageQt.toqpixmap(dialogBox)
            PdialogText=ImageQt.toqpixmap(dialogText)
            self.order += 1
            if self.order == len(self.indexes):
                self.end=True
            else:
                self.end=False
            self.boxlabel.setPixmap(PdialogBox)
            self.boxlabel.setGeometry(0, 0, dialogBox.width, dialogBox.height)
            self.textlabel.setPixmap(PdialogText)
            self.textlabel.setGeometry(0, 0, dialogText.width, dialogText.height)
            if self.order == 1:
                setopacity(self.boxlabel, 0)
                setopacity(self.textlabel, 0)

            self.dialoging=self.emotionchange=True
            self.t0=0
            pg.mixer.stop()
            try:
                namefile=name if name.isupper() else name.capitalize()
                self.voice = pg.mixer.Sound(f"audios/JP_{namefile}/{name}_{index}.ogg")
            except:
                self.voice = pg.mixer.Sound("audios/mute.ogg")
            self.voice.set_volume(self.voiceVolume)
            self.length=max(self.voice.get_length(), 1)
            self.fixedupdate = QTimer(self)
            self.fixedupdate.timeout.connect(self.frameUpdate)
            self.voice.play()
            #self.hide()
            self.show()
            self.fixedupdate.start(1000/30)
        def frameUpdate(self, fadeIn=0.6, fadeOut=0.6):
            self.voice.set_volume(self.voiceVolume)
            if self.t0 == 0:
                self.t0 = time.time()
                t=0
                self.sizeposChange(self.k)
                self.tempCanblink=imagewindow.canblink
                imagewindow.canblink=False
                imagewindow.update(self.emotion)
            else:
                t = time.time()-self.t0
            if self.dialoging and imagewindow.candialog:
                self.timeCommunicator.data_signal.emit(t)
                if 0 <= t and t <= fadeIn:
                    if self.order == 1:
                        setopacity(self.boxlabel, t/fadeIn)
                    else:
                        setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, t/fadeIn)
                elif fadeIn < t and t <= self.length:
                    setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, 1)
                elif self.length < t and t <= self.length+fadeOut:
                    if self.emotionchange and self.end:
                        imagewindow.update(emotions[settings['defaultEmotionIndex']])
                        imagewindow.canblink=self.tempCanblink
                        self.emotionchange=False
                    if self.end:
                        setopacity(self.boxlabel, (self.length+fadeOut - t)/fadeOut)
                    else:
                        setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, (self.length+fadeOut - t)/fadeOut)
                else:
                    setopacity(self.boxlabel, 0)
                    setopacity(self.textlabel, 0)
                    t = self.length+fadeOut+1
                    self.hide()
                    self.dialoging=False
            elif not self.end:
                self.showDB(self.indexes, self.emotions, self.order)
            elif self.emotionchange:
                self.voice.stop()
                self.hide()
                setopacity(self.boxlabel, 0)
                setopacity(self.textlabel, 0)
                imagewindow.update(emotions[settings['defaultEmotionIndex']])
                imagewindow.canblink=self.tempCanblink
                self.emotionchange=self.dialoging=False
        def sizeposChange(self, data):
            self.k=data
            dialogBox=self.dialogBox0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogBox0.size))
            dialogText=self.dialogText0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogText0.size))
            PdialogBox=ImageQt.toqpixmap(dialogBox)
            PdialogText=ImageQt.toqpixmap(dialogText)
            self.boxlabel.setPixmap(PdialogBox)
            self.textlabel.setPixmap(PdialogText)

            self.boxlabel.setFixedSize(dialogBox.width, dialogBox.height)
            self.textlabel.setFixedSize(dialogText.width, dialogText.height)

            charactercenter=imagewindow.frameGeometry().center()
            self.setGeometry(charactercenter.x()+(settings["dialogBoxPos"][0]-settings['characterPos'][0])*self.k/1.1962-imagewindow.size0[0]/2*imagewindow.k,
                    charactercenter.y()+(settings["dialogBoxPos"][1]-settings['characterPos'][1])*self.k/1.1962-imagewindow.size0[1]/2*imagewindow.k, 
                    dialogBox.width, dialogBox.height)
        def closeEvent(self, event):
            event.ignore()
        
    imagewindow = ImageWindow()
    imagewindow.show()
    signal.signal(signal.SIGINT, lambda: imagewindow.signalReceived())
    if firstTime:
        pg.mixer.music.load("audios/theme_14.ogg")
        pg.mixer.music.play(-1)

if __name__ == "__main__":
    if screen.width()/1600 != screen.height()/900:
        msg=QMessageBox.question(None, "提示", "屏幕比例不符合16:9，角色初始位置会歪，是否继续?", QMessageBox.Yes|QMessageBox.No)
        if msg == QMessageBox.Yes:
            main(getCurrentCharacter(), firstTime=True)
            sys.exit(app.exec_())
    else:
        main(getCurrentCharacter(), firstTime=True)
        sys.exit(app.exec_())

###########################################################################
# File: __init__.py
# Path: D:\Projects\DesktopLobby2.0\__init__.py
###########################################################################



###########################################################################
# File: actions_brfore_start.py
# Path: D:\Projects\DesktopLobby2.0\actions_brfore_start.py
###########################################################################

def ask_if_start(screen):
    from getResources import GLOBAL_CONFIG
    from PySide6.QtWidgets import QMessageBox
    
    if GLOBAL_CONFIG.PREFERENCES["repeatConfirm"] != 0:
        from windows.repeat_confirm_window import repeat_confirm
        if repeat_confirm(GLOBAL_CONFIG.PREFERENCES["repeatConfirm"]):
            ###
            if screen.geometry().width()/1600 != screen.geometry().height()/900:
                print(f"[DEBUG]Screen Size: {screen.geometry().width(),screen.geometry().height()}")
                msg=QMessageBox.warning(None, "提示", "屏幕比例不符合16:9，角色初始位置会歪，是否继续?", QMessageBox.Yes|QMessageBox.No)
                if msg == QMessageBox.Yes:
                    return True
    else:
        return True

###########################################################################
# File: communicator.py
# Path: D:\Projects\DesktopLobby2.0\communicator.py
###########################################################################

from PySide6.QtCore import QObject, Signal

class Communicator(QObject):
    # 创建一个信号类，用于传递数据
    data_signal = Signal(object)

###########################################################################
# File: custom_QDialog.py
# Path: D:\Projects\DesktopLobby2.0\custom_QDialog.py
###########################################################################

from PySide6.QtWidgets import QDialog
from signal_bus import signal_bus


class CustomQDialog(QDialog):
    def __init__(self):
        super().__init__()
        signal_bus.close_signal.connect(lambda: self.hide())

###########################################################################
# File: dataclasses_.py
# Path: D:\Projects\DesktopLobby2.0\dataclasses_.py
###########################################################################

from dataclasses import dataclass
from typing import Any, Dict, List

@dataclass
class GlobalConfig:
    CODE_NAMES: List[str] = None
    AI_SAVES: List[str] = None
    AI_TEMPLATES: List[str] = None
    PREFERENCES: Dict = None
    CONTRAST: Dict = None
    DIALOGBOX_INF: Dict = None
    LANGUAGE: Dict = None

    JOB_OBJECT: Any = None

    ANIMS: List[Any] = None

    k00: float = 1
    ZOOM_SCALE: float = 1.1962



@dataclass
class GlobalVariables:
    socket_thread: Any = None

    current_AI: Any = None
    AI_thread: Any = None

@dataclass
class CharacterConfig:
    name: str
    k0: float
    pictures: Dict
    settings: Dict
    emotions: Any
    halo_height: int
    dialogBoxImages: Any
    dialogBoxContent: Dict
    firstTime: bool
    today_is_birthday_sensei: bool
    screen: Any

@dataclass
class SettingsParameters:
    emotion: str = ''
    blink: bool = True #blinkable
    dialog: bool = True
    move: bool = False#movable
    size: float = 1.0
    close: bool = True#closable
    top_level: bool = False
    voice_volume: float = 1.0
    character: str = ''

    AI_open_new_topic: int = 0


###########################################################################
# File: getResources.py
# Path: D:\Projects\DesktopLobby2.0\getResources.py
###########################################################################

﻿from PIL import Image
import os
from functions.json_ import load_json
from loadingWindow.loading import LoadingWindowControl
from dataclasses_ import GlobalConfig, GlobalVariables
from resource_loader import get_folder_resources
from job_object import create_job_object

def loadFont(path, size, type=None, italic=False):
    from PySide6.QtGui import QFont, QFontDatabase
    if not type:
        type = QFont.Normal
    fontid = QFontDatabase.addApplicationFont(path)
    if fontid == -1:
        return None
    families = QFontDatabase.applicationFontFamilies(fontid)
    if not families:
        return None
    font = QFont()
    font.setFamily(families[0])
    font.setPointSize(size)
    font.setWeight(type)
    font.setItalic(italic)
    return font


CODE_NAMES = get_folder_resources('characters', ['dialogBoxContent.json', 'introduction.json', 'getCharacter.py'])
print(f"[DEBUG]Characters: {CODE_NAMES}")
AI_NAMES = get_folder_resources('AI', ['AI.py', 'config.json'])
print(f"[DEBUG]AI Saves: {AI_NAMES}")
AI_TEMPLATES = get_folder_resources('AI/TEMPLATES', ['AI.py', 'config.json'])
print(f"[DEBUG]AI Templates: {AI_TEMPLATES}")
PREFERENCES = load_json("preferences.json")
CONTRAST = load_json("contrast.json")
DIALOGBOX_INF = load_json("images/Lobby_balloon.json")
LANGUAGE = load_json(f"lang/{PREFERENCES['language']}.lang")

JOB_OBJECT = create_job_object()

GLOBAL_CONFIG = GlobalConfig(CODE_NAMES, AI_NAMES, AI_TEMPLATES, PREFERENCES, CONTRAST, DIALOGBOX_INF, LANGUAGE, JOB_OBJECT,
                             ZOOM_SCALE=PREFERENCES["zoomScale"])
global_variables = GlobalVariables()

LoadingWindowControl.messageLoadingWindow("Global configuration loading completed.")

tempfolderPath = os.path.join(os.getenv('TEMP'), 'DesktopLobby')
os.makedirs(tempfolderPath, exist_ok=True)
tempCharacterPath = os.path.join(tempfolderPath, "currentCharacter.json")
LoadingWindowControl.messageLoadingWindow("File creation completed.")


def setCurrentCharacter(characterName):
    with open(tempCharacterPath, 'w') as txt:
        txt.write(characterName)


def getCurrentCharacter():
    if not os.path.exists(tempCharacterPath):
        setCurrentCharacter(PREFERENCES['initialCharacter'])
    with open(tempCharacterPath, 'r') as txt:
        characterName = txt.read()
    return characterName


def getImageGroup(name):
    with open(f"images/{name}.asset", 'r') as txt:
        content = txt.readlines()
    mPixelSize = float(content[-2][(content[-2].find(':') + 2): -1])

    orimage = Image.open(f"images/{name}.png").convert("RGBA")
    images = {}
    for a in range(16, len(content) - 13, 13):
        x = int(content[a + 1][(content[a + 1].find(':') + 2): -1])
        y = int(content[a + 2][(content[a + 2].find(':') + 2): -1])
        w = int(content[a + 3][(content[a + 3].find(':') + 2): -1])
        h = int(content[a + 4][(content[a + 4].find(':') + 2): -1])
        region = orimage.crop((x, y, x + w, y + h))
        if mPixelSize != 1.0:
            region = region.resize((w * a, h * a))
        name = content[a][(content[a].find(':') + 2): -1]
        images[name] = region
    return images


def getImage(gname, iname):
    with open(f"images/{gname}.asset", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"images/{gname}.png").convert("RGBA")
    for a in range(16, len(content) - 13, 13):
        if content[a][(content[a].find(':') + 2): -1] == iname:
            x = int(content[a + 1][(content[a + 1].find(':') + 2):])
            y = int(content[a + 2][(content[a + 2].find(':') + 2):])
            w = int(content[a + 3][(content[a + 3].find(':') + 2):])
            h = int(content[a + 4][(content[a + 4].find(':') + 2):])
            image = orimage.crop((x, y, x + w, y + h))
            break
    return image


def getDialogBoxContent(name):
    return load_json(f"characters/{name}/dialogBoxContent.json")

###########################################################################
# File: job_object.py
# Path: D:\Projects\DesktopLobby2.0\job_object.py
###########################################################################

import win32job
import ctypes
from ctypes import wintypes

PROCESS_ALL_ACCESS = 0x1F0FFF
PROCESS_TERMINATE = 0x0001

def get_process_handle(pid):
    handle = ctypes.windll.kernel32.OpenProcess(PROCESS_ALL_ACCESS, False, pid)
    if not handle:
        return ctypes.WinError()
    return handle


def create_job_object():
    job = win32job.CreateJobObject(None, "DesktopLobbyJob")
    extended_info = win32job.QueryInformationJobObject(job, win32job.JobObjectExtendedLimitInformation)

    extended_info['BasicLimitInformation']['LimitFlags'] = win32job.JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE
    win32job.SetInformationJobObject(job, win32job.JobObjectExtendedLimitInformation, extended_info)
    return job

def assign_process_to_job(job, process):
    process_handle = get_process_handle(process.pid)
    win32job.AssignProcessToJobObject(job, process_handle)

###########################################################################
# File: main.py
# Path: D:\Projects\DesktopLobby2.0\main.py
###########################################################################

from multiprocessing import Process, current_process, freeze_support
import sys

if getattr(sys, 'frozen', False):
    freeze_support()
    
if current_process().name == 'MainProcess' and __name__ == '__main__':
    from actions_brfore_start import ask_if_start
    from PySide6.QtWidgets import QApplication
    from PySide6.QtGui import QGuiApplication

    app = QApplication(sys.argv)
    app.setQuitOnLastWindowClosed(True)

    screens = QGuiApplication.screens()
    screen = screens[0]

    if ask_if_start(screen):
        from loadingWindow.loading import LoadingWindowControl

        LoadingWindowControl.createLoadingWindow()
        from windows.image_window import ImageWindow, CharacterConfig
        from PySide6.QtCore import QThread

        import signal

        from getResources import GLOBAL_CONFIG, global_variables, getCurrentCharacter, getDialogBoxContent, loadFont, setCurrentCharacter
        from resource_loader import getCharacterInf
        from renderDialogBox import *
        from animation.animation_player import AnimationPlayer
        from windows.background_window import load_background_window
        from signal_bus import signal_bus
        from AI.AI_control import AI

        default_font = app.font()

        if GLOBAL_CONFIG.PREFERENCES["debugWindow"]:
            from windows.debug_window import DebugWindow
            debug_window = DebugWindow(default_font)

        LoadingWindowControl.messageLoadingWindow("Module import completed.")

        overFont = loadFont(*GLOBAL_CONFIG.PREFERENCES["font"])
        if overFont:
            app.setFont(overFont)

        LoadingWindowControl.messageLoadingWindow("Font loading completed.")

        if GLOBAL_CONFIG.PREFERENCES["defaultOverallCharacterSize"]:
            GLOBAL_CONFIG.k00 = GLOBAL_CONFIG.PREFERENCES["defaultOverallCharacterSize"]
        else:
            GLOBAL_CONFIG.k00 = round(
                min(screen.geometry().width() / 1600, screen.geometry().height() / 900) * GLOBAL_CONFIG.ZOOM_SCALE, 3)

        anims = {}
        for animName in GLOBAL_CONFIG.PREFERENCES['animNames']:
            anims[animName] = AnimationPlayer(animName)
            LoadingWindowControl.messageLoadingWindow(f"Animation:{animName}")
        GLOBAL_CONFIG.ANIMS = anims
        LoadingWindowControl.messageLoadingWindow("Animation initialization completed.")
        current_AI = AI_thread = None


        def init_AI(AI_name, inf_dict):
            if not GLOBAL_CONFIG.PREFERENCES["defaultInitAI"] or AI_name in GLOBAL_CONFIG.AI_SAVES:
                try:
                    if not global_variables.current_AI:
                        global_variables.current_AI = AI(AI_name, inf_dict)
                        global_variables.AI_thread = QThread()
                        global_variables.current_AI.moveToThread(global_variables.AI_thread)
                    else:
                        global_variables.AI_thread.quit()
                        global_variables.AI_thread.wait()
                        global_variables.current_AI = AI(AI_name, inf_dict)
                        global_variables.AI_thread = QThread()
                        global_variables.current_AI.moveToThread(AI_thread)
                except Exception as e:
                    print(f"[ERROR]AI Error: {e}")

        signal_bus.AI_start_signal.connect(init_AI)


        def mainChar(name, firstTime=False):
            LoadingWindowControl.messageLoadingWindow("Start loading character...")
            pictures, settings = getCharacterInf(name)
            LoadingWindowControl.messageLoadingWindow("Character loading completed.")
            haloHeight = settings.get('haloHeight', 100)
            emotions = list(pictures.keys())
            emotions.remove('halo')
            k0 = settings.get('k', 1) * GLOBAL_CONFIG.k00
            dialogBoxContent = getDialogBoxContent(name)
            dialogBoxImages = {}
            for key, content in dialogBoxContent.items():
                dialogBoxX, dialogTextX = render_Lobby_balloon(content[0])
                dialogBoxImages[key] = [dialogBoxX.resize(
                    tuple(int(x * GLOBAL_CONFIG.k00 / GLOBAL_CONFIG.ZOOM_SCALE) for x in dialogBoxX.size)),
                                        dialogTextX.resize(tuple(
                                            int(x * GLOBAL_CONFIG.k00 / GLOBAL_CONFIG.ZOOM_SCALE) for x in
                                            dialogTextX.size)), content[1]]
                LoadingWindowControl.messageLoadingWindow(f"Dialog:{key}")
            LoadingWindowControl.messageLoadingWindow("Dialog box rendering completed.")
            if firstTime:
                LoadingWindowControl.messageLoadingWindow("complete")
                global today_is_birthday_sensei
                from functions.birthday import getIftodayIsSenseiBirthday
                today_is_birthday_sensei = getIftodayIsSenseiBirthday(app, screen)

            character_config = CharacterConfig(name,
                                               k0,
                                               pictures,
                                               settings,
                                               emotions,
                                               haloHeight,
                                               dialogBoxImages,
                                               dialogBoxContent,
                                               firstTime,
                                               today_is_birthday_sensei,
                                               screen
                                               )
            imagewindow = ImageWindow(character_config)
            imagewindow.functions_init(character_changed, init_AI)
            imagewindow.show()
            signal.signal(signal.SIGINT, lambda: imagewindow.signalReceived())
            if firstTime:
                from audios.sound import play_background_music
                play_background_music("audios/theme_14.ogg")


        def character_changed(name):
            setCurrentCharacter(name)
            mainChar(name=name)


        def process_loading():
            background_window_process = Process(target=load_background_window,
                                                args=(GLOBAL_CONFIG.PREFERENCES.get("dynamicBackgroundOffset", (0, 0)),))
            background_window_process.daemon = True
            background_window_process.start()

            from job_object import assign_process_to_job
            assign_process_to_job(GLOBAL_CONFIG.JOB_OBJECT, background_window_process)

        if GLOBAL_CONFIG.PREFERENCES["dynamicBackground"]:
            process_loading()
        
        try:
            from socket_ import SocketListener
            socketThread = SocketListener(signal_bus.settings_signal)
            socketThread.start()
            global_variables.socket_thread = socketThread
        except Exception as e:
            print(f"[ERROR]Create Socket Error: {e}")
            global_variables.socketThread = None
            
        mainChar(getCurrentCharacter(), firstTime=True)
        sys.exit(app.exec())

###########################################################################
# File: merged_output.py
# Path: D:\Projects\DesktopLobby2.0\merged_output.py
###########################################################################

#==============================================================================
# MERGED PYTHON FILES
# Generated by merge_py_files.py
#
# Source: D:\Projects\DesktopLobby2.0
# Excluded: test_*.py, test.py, __init__.py (可配置)
#==============================================================================

###########################################################################
# File: AI_test.py
# Path: D:\Projects\DesktopLobby2.0\AI_test.py
###########################################################################

#from database.database import *
from AI.AI_control import AI

a=AI('qwen4b', {'NAME': "qwen4b", "PATH": "AI/qwen/qwen1_5-4b-chat-q4_k_m.gguf"})
#db_delete_conversation_record(0, character='mi')
while True:
    x=input()
    if x == 's':
        break
    elif x == 'b':
        a.b = True
    else:
        print('结果', a.generate_result({'user_content': x, 'current_character': 'momoi', 'example': "老师，我要玩游戏！！！！！#smile#"}, debug=True))

###########################################################################
# File: DesktopLobby.py
# Path: D:\Projects\DesktopLobby2.0\DesktopLobby.py
###########################################################################

from PyQt5.QtCore import Qt, QTimer, QObject, pyqtSignal, QThread
from PyQt5.QtWidgets import QLabel, QVBoxLayout, QMainWindow, QComboBox, QCheckBox, QDialog, QSlider, QLineEdit, QApplication, QDesktopWidget, QWidget, QMessageBox, QGraphicsOpacityEffect
from PIL import ImageQt
import sys
import time
import pygame as pg
from random import randrange
from math import sin
import os
import socket
import signal
import importlib.util
from getResources import *
from renderDialogBox import *
from playAnims import PlayAnims
names=getCharacterNames()
perferences=getPerferences()
contrast=getContrast()
pg.init()
pg.mixer.init()

app = QApplication(sys.argv)
app.setQuitOnLastWindowClosed(True)
screen = QDesktopWidget().screenGeometry()
k00=min(screen.width()/1600, screen.height()/900) * 1.1962
class Communicator(QObject):
    # 创建一个信号类，用于传递数据
    data_signal = pyqtSignal(object)

# 创建一个线程类来监听套接字
class SocketListener(QThread):
    def __init__(self, comm):
        super().__init__()
        self.comm = comm
    def run(self, address=10000):
        # 创建套接字服务器
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.bind(('localhost', address))
            sock.listen(1)
            while True:
                conn, addr = sock.accept()
                data = conn.recv(1024)
                if data:
                    message = data.decode().strip()
                    self.comm.data_signal.emit(message)
                    data=None
                time.sleep(0.2)
        except:
            if address < 10009:
                self.run(address=address+1)

def main(name, firstTime=False):
    perferences=getPerferences()

    scriptpath=os.path.join(os.path.dirname(__file__), "characters", name, "getCharacter.py")
    spec=importlib.util.spec_from_file_location("getCharacter", scriptpath)
    moudle=importlib.util.module_from_spec(spec)
    spec.loader.exec_module(moudle)
    
    pictures, settings = moudle.getCharacter(name)
    haloHeight=settings.get('haloHeight', 100)
    emotions=sorted(pictures.keys())
    emotions.remove('halo')
    k0=settings.get('k', 1)*k00
    dialogBoxContent = getDialogBoxContent(name)
    def setopacity(label, opacity):
        effect=QGraphicsOpacityEffect()
        label.setGraphicsEffect(effect)
        effect.setOpacity(opacity)

    class ImageWindow(QMainWindow):
        def __init__(self):
            super().__init__()
            self.layout=QVBoxLayout()
            # 设置无边框和透明背景
            self.setWindowFlags(Qt.FramelessWindowHint)
            self.setAttribute(Qt.WA_TranslucentBackground, True)
            
            self.haloPos=settings['halo']
            self.t=0
            self.k=k0
            self.movable=False
            self.closable=True
            self.canblink=settings['defaultBlinkEyes']
            self.candialog=settings['defaultDialog']
            self.vvolume=perferences["defaultVoiceVolume"]
            self.dialogBoxImages={}
            for key, content in dialogBoxContent.items():
                dialogBoxX, dialogTextX = render_Lobby_balloon(content[0])
                self.dialogBoxImages[key] = [dialogBoxX.resize(tuple(int(x*k00/1.1962) for x in dialogBoxX.size)),
                                            dialogTextX.resize(tuple(int(x*k00/1.1962) for x in dialogTextX.size)), content[1]]
            self.anims={}
            for animName in perferences['animNames']:
                self.anims[animName]=PlayAnims(animName)
            self.playable=False
            self.currentEmotion=emotions[settings['defaultEmotionIndex']]
            self.image0=pictures[self.currentEmotion]
            self.haloImage=pictures['halo']
            
            self.halo=QLabel('halo', self)
            self.halo.setPixmap(ImageQt.toqpixmap(self.haloImage))
            self.halo.setFixedSize(self.haloImage.width, self.haloImage.height)
            self.halo.move(self.haloPos[0], self.haloPos[1])
            self.layout.addWidget(self.halo)
            self.size0=(self.image0.width, self.image0.height+haloHeight)
            self.resize(self.size0[0], self.size0[1])

            self.body=QLabel('body', self)
            self.body.setPixmap(ImageQt.toqpixmap(self.image0))
            self.body.setFixedSize(self.image0.width, self.image0.height)
            self.body.move((self.width() - self.image0.width)/2, (self.height() - self.image0.height+haloHeight)/2)
            self.layout.addWidget(self.body)
            self.setLayout(self.layout)
            
            self.move(settings['characterPos'][0] *k00/1.1962, settings['characterPos'][1] *k00/1.1962)
            self.sizeChange(k00)
            self.fixedupdate = QTimer(self)
            self.fixedupdate.timeout.connect(self.frameUpdate)
            self.t0=0
            self.fixedupdate.start(1000/30)
            
            self.dialogboxwindow = DialogBoxWindow(self.dialogBoxImages)
            self.dialogboxwindow.show()

            self.settingwindow = SettingWindow()
            self.settingwindow.Emotioncommunicator.data_signal.connect(self.update)
            self.settingwindow.Blinkcommunicator.data_signal.connect(self.canblinkchanged)
            self.settingwindow.Dialogcommunicator.data_signal.connect(self.candialogchanged)
            self.settingwindow.Movecommunicator.data_signal.connect(self.movablechanged)
            self.settingwindow.Sizecommunicator.data_signal.connect(self.sizeChange)
            self.settingwindow.Sizecommunicator.data_signal.connect(self.dialogboxwindow.sizeposChange)
            self.settingwindow.Closecommunicator.data_signal.connect(self.closablechanged)
            self.settingwindow.Levelcommunicator.data_signal.connect(self.levelchanged)
            self.settingwindow.VVolumecommunicator.data_signal.connect(self.dialogboxwindow.vvolumeChanged)
            self.settingwindow.VVolumecommunicator.data_signal.connect(self.vvolumeChanged)
            self.settingwindow.Charactercommunicator.data_signal.connect(self.characterChanged)
            self.dialogboxwindow.timeCommunicator.data_signal.connect(self.playingAnim)

            self.DFvsHAFcommunicator=Communicator()
            self.DFvsHAFcommunicator.data_signal.connect(self.signalReceived)
            if firstTime:
                try:
                    self.socketThread=SocketListener(self.DFvsHAFcommunicator)
                    self.socketThread.start()
                except:
                    pass
            if self.candialog:
                self.dialog(settings["login"])
        def canblinkchanged(self, data):
            self.canblink = True if data == 2 else False
        def candialogchanged(self, data):
            self.candialog = True if data == 2 else False
        def movablechanged(self, data):
            self.movable = True if data == 2 else False
            self.settingwindow.dialogCheck.setChecked(False)
            self.settingwindow.dialogCheck.setCheckable(not self.movable)
        def closablechanged(self, data):
            self.closable = True if data == 2 else False
        def levelchanged(self, data):
            if data == 2:
                self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(Qt.FramelessWindowHint|Qt.Tool|Qt.WindowStaysOnTopHint)
                self.show()
            else:
                self.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.show()
        def vvolumeChanged(self, data):
            self.vvolume=data/100
        def update(self, data, changeCurrentEmotion=True):
            if changeCurrentEmotion:
                self.currentEmotion=data
            self.image0=pictures[data]
            self.image1=self.image0.resize(tuple(int(x*self.k) for x in self.image0.size))
            self.body.setPixmap(ImageQt.toqpixmap(self.image1))

        def frameUpdate(self, blinkingtime=settings['blinkingTime'], deltablinktime=settings['deltaBlinkTime']):
            if self.t0 == 0:
                self.t0 = time.time()
                self.sblinktime=0
            t=time.time()-self.t0
            dy=sin(t/2)*5*self.k/1.1962
            self.halo.move(self.haloPos[0]*self.k, self.haloPos[1]*self.k+dy)
            if self.canblink:
                if t-self.sblinktime > blinkingtime:
                    self.update(self.currentEmotion)
                    self.sblinktime=t+blinkingtime+999999
                if t % deltablinktime < 1/30 or t % deltablinktime > deltablinktime-1/30:
                    self.update("eyeclose", changeCurrentEmotion=False)
                    self.sblinktime=t
        def signalReceived(self, message):
            self.candialog=self.canblink=False
            indexType={'fail': "emotionWhenFailingIndex"}[message]
            try:
                self.settingwindow.dialogCheck.setChecked(False)
                self.settingwindow.blinkCheck.setChecked(False)
                if indexType in settings.keys():
                    self.settingwindow.emotionCombo.setCurrentIndex(settings[indexType])
            except Exception as e:
                print(e)
            self.update(emotions[settings[indexType]] if indexType in settings.keys() else self.currentEmotion)

            try:
                namefile=name if name.isupper() else name.capitalize()
                voice = pg.mixer.Sound(f"audios/JP_{namefile}/{name}_battle_retire.ogg")
            except:
                voice = pg.mixer.Sound("audios/mute.ogg")
            voice.set_volume(self.vvolume)
            voice.play()
        def dialog(self, indexes):
            index=indexes[randrange(0, len(indexes))]
            emotion=[next((s for s in emotions if s.startswith(dialogBoxContent[inde.split('|')[0]][1])), None) for inde in index]
            self.dialogboxwindow.showDB(index, emotion)

        def playingAnim(self, data):
            if self.dialogboxwindow.aniName:
                if data == 0 and not self.playable:
                    self.pos0 = (self.frameGeometry().topLeft().x(), self.frameGeometry().topLeft().y())
                result, self.playable = self.anims[self.dialogboxwindow.aniName].play(data, Pratio=(0.5, 0.5))
                if self.playable:
                    deltaPos=result['position']
                    self.move(self.pos0[0]+deltaPos[0]*self.k, self.pos0[1]+deltaPos[1]*self.k)
                else:
                    self.move(self.pos0[0], self.pos0[1])
        def sizeChange(self, data):
            self.k = data*settings.get('k', 1)#1.1962
            fixedBody=self.image0.resize(tuple(int(x*self.k) for x in self.image0.size)) 
            fixedHalo=self.haloImage.resize(tuple(int(x*self.k) for x in self.haloImage.size))
            self.resize(self.size0[0]*self.k, self.size0[1]*self.k)
            self.halo.setPixmap(ImageQt.toqpixmap(fixedHalo))
            self.halo.setFixedSize(fixedHalo.size[0], fixedHalo.size[1])
            self.halo.move(self.haloPos[0]*self.k, self.haloPos[1]*self.k)

            self.body.setPixmap(ImageQt.toqpixmap(fixedBody))
            self.body.setFixedSize(fixedBody.size[0], fixedBody.size[1])
            self.body.move(0, haloHeight*self.k)

        def mousePressEvent(self, event):
            if self.candialog and event.button() == Qt.LeftButton:
                self.dialog(settings["lobby"])
            if self.candialog and event.button() == Qt.RightButton:
                self.dialog(settings["login"])
            if self.movable and event.button() == Qt.LeftButton:
                self.dragging=True
                self.dragPosition=event.globalPos()-self.frameGeometry().topLeft()
                event.accept()
        def mouseMoveEvent(self, event):
            if self.movable and Qt.LeftButton and self.dragging:
                self.move(event.globalPos()-self.dragPosition)
                event.accept()
        def mouseReleaseEvent(self, event):
            if self.movable and event.button() == Qt.LeftButton:
                self.dragging=False
                self.dialogboxwindow.sizeposChange(self.k / settings.get('k', 1))
                event.accept()
        def keyPressEvent(self, event):
            if event.key() == 69:   #E
                self.settingwindow.show()
        def closeEvent(self, event):
            if not self.closable:
                event.ignore()
            else:
                self.dialogboxwindow.fixedupdate.stop()
                self.fixedupdate.stop()
                self.settingwindow.destroy()
                self.dialogboxwindow.destroy()
                self.dialogboxwindow.voice.stop()
                pg.mixer.music.stop()
                pg.mixer.quit()
                pg.quit()
                QApplication.quit()
        def characterChanged(self, data):
            self.dialogboxwindow.fixedupdate.stop()
            self.fixedupdate.stop()
            self.settingwindow.destroy()
            self.dialogboxwindow.destroy()
            self.dialogboxwindow.voice.stop()
            self.destroy()
            del(self.dialogboxwindow, self.settingwindow, self)
            setCurrentCharacter(data.lower())
            main(name=data.lower())
    class SettingWindow(QDialog):
        def __init__(self):
            super().__init__()
            self.setWindowTitle('Settings')
            self.setGeometry(100, 100, 200, 150)
            #self.setWindowFlags(Qt.Tool)

            self.Emotioncommunicator = Communicator()
            self.Blinkcommunicator = Communicator()
            self.Dialogcommunicator = Communicator()
            self.Movecommunicator = Communicator()
            self.Sizecommunicator = Communicator()
            self.Closecommunicator = Communicator()
            self.Levelcommunicator = Communicator()
            self.VVolumecommunicator = Communicator()
            self.Charactercommunicator = Communicator()

            layout=QVBoxLayout()

            self.emotionCombo = QComboBox()
            self.emotionCombo.addItems(emotions)
            self.emotionCombo.setCurrentIndex(settings['defaultEmotionIndex'])
            layout.addWidget(self.emotionCombo)

            self.blinkCheck = QCheckBox("Blinking eyes", self)
            self.blinkCheck.setChecked(settings['defaultBlinkEyes'])
            layout.addWidget(self.blinkCheck)

            self.dialogCheck = QCheckBox("Dialog", self)
            self.dialogCheck.setChecked(settings['defaultDialog'])
            layout.addWidget(self.dialogCheck)

            moveCheck = QCheckBox("Movable", self)
            moveCheck.setChecked(False)
            layout.addWidget(moveCheck)

            layout.addStretch(1)
            
            sizemessage = QLabel('Size')
            layout.addWidget(sizemessage)

            self.Sslider = QSlider(Qt.Horizontal)
            self.Sslider.setMinimum(1000)
            self.Sslider.setMaximum(30000)
            self.Sslider.setSingleStep(1)
            self.Sslider.setValue(int(k00 *10000))
            layout.addWidget(self.Sslider)

            self.numbox = QLineEdit()
            self.numbox.setText(str(k00))
            layout.addWidget(self.numbox)

            closeCheck = QCheckBox("Closable", self)
            closeCheck.setChecked(True)
            layout.addWidget(closeCheck)

            levelCheck = QCheckBox("Always at the Top Level", self)
            levelCheck.setChecked(False)
            layout.addWidget(levelCheck)

            layout.addStretch(1)
            
            message1 = QLabel('BGM volume')
            layout.addWidget(message1)

            self.Bslider = QSlider(Qt.Horizontal)
            self.Bslider.setMinimum(0)
            self.Bslider.setMaximum(100)
            self.Bslider.setSingleStep(1)
            self.Bslider.setValue(perferences["defaultBGMVolume"]*100)
            layout.addWidget(self.Bslider)
            pg.mixer.music.set_volume(perferences["defaultBGMVolume"])

            message2 = QLabel('Voice volume')
            layout.addWidget(message2)

            self.Vslider = QSlider(Qt.Horizontal)
            self.Vslider.setMinimum(0)
            self.Vslider.setMaximum(100)
            self.Vslider.setSingleStep(1)
            self.Vslider.setValue(perferences["defaultVoiceVolume"]*100)
            layout.addWidget(self.Vslider)

            characterCombo = QComboBox()
            fixedNames=[contrast.get(x, x) if contrast.get(x, x).isupper() else contrast.get(x, x).capitalize() for x in names]
            characterCombo.addItems(fixedNames)
            currentcharacter=getCurrentCharacter()
            characterCombo.setCurrentText(contrast.get(currentcharacter, currentcharacter).capitalize())
            layout.addWidget(characterCombo)

            self.setLayout(layout)
            self.emotionCombo.currentIndexChanged.connect(lambda: self.Emotioncommunicator.data_signal.emit(self.emotionCombo.currentText()))
            self.blinkCheck.stateChanged.connect(lambda state: self.Blinkcommunicator.data_signal.emit(state))
            self.dialogCheck.stateChanged.connect(lambda state: self.Dialogcommunicator.data_signal.emit(state))
            moveCheck.stateChanged.connect(lambda state: self.Movecommunicator.data_signal.emit(state))
            closeCheck.stateChanged.connect(lambda state: self.Closecommunicator.data_signal.emit(state))
            levelCheck.stateChanged.connect(lambda state: self.Levelcommunicator.data_signal.emit(state))

            self.Sslider.valueChanged.connect(self.update_numbox)
            self.numbox.textChanged.connect(self.update_Sslider)

            self.Bslider.valueChanged.connect(lambda value: pg.mixer.music.set_volume(value/100))
            self.Vslider.valueChanged.connect(lambda value: self.VVolumecommunicator.data_signal.emit(value))

            characterCombo.currentIndexChanged.connect(lambda: self.Charactercommunicator.data_signal.emit(names[characterCombo.currentIndex()]))
        def update_numbox(self, value):
            double_value = value / 10000.0
            self.numbox.setText(str(double_value))
            self.Sizecommunicator.data_signal.emit(double_value)

        def update_Sslider(self, value):
            try:
                fvalue=min(max(float(value), 0.1), 3.0)
                int_value = int(fvalue * 10000)
                self.Sslider.setValue(int_value)
                self.numbox.setText(str(fvalue))
                self.Sizecommunicator.data_signal.emit(fvalue)
            except ValueError:
                pass

    class DialogBoxWindow(QWidget):
        def __init__(self, dialogBoxImages):
            super().__init__()
            self.k=k00
            self.dialogBoxImages=dialogBoxImages
            self.voiceVolume=perferences["defaultVoiceVolume"]
            self.timeCommunicator=Communicator()
            self.aniName=None

            layout=QVBoxLayout()
            # 设置无边框和透明背景
            self.setWindowModality(Qt.NonModal)
            self.setWindowFlags(Qt.FramelessWindowHint|Qt.ToolTip)
            self.setAttribute(Qt.WA_TranslucentBackground, True)
            self.setGeometry(settings["dialogBoxPos"][0]*self.k/1.1962, settings["dialogBoxPos"][1]*self.k/1.1962, 1, 1)
            self.boxlabel=QLabel(self)
            self.boxlabel.setGeometry(0, 0, 1, 1)
            layout.addWidget(self.boxlabel)

            self.textlabel=QLabel(self)
            self.textlabel.setGeometry(0, 0, 1, 1)
            layout.addWidget(self.textlabel)
        def vvolumeChanged(self, data):
            self.voiceVolume=data/100
        def showDB(self, indexes, emotions, order=0):
            self.indexes=indexes
            self.emotions=emotions
            self.order=order
            index=self.indexes[self.order]
            if '|' in index:
                index, self.aniName = index.split('|')
            else:
                self.aniName = None
            self.emotion=self.emotions[self.order]
            self.dialogBox0=self.dialogBoxImages[index][0]
            dialogBox=self.dialogBox0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogBox0.size))
            self.dialogText0=self.dialogBoxImages[index][1]
            dialogText=self.dialogText0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogText0.size))
            PdialogBox=ImageQt.toqpixmap(dialogBox)
            PdialogText=ImageQt.toqpixmap(dialogText)
            self.order += 1
            if self.order == len(self.indexes):
                self.end=True
            else:
                self.end=False
            self.boxlabel.setPixmap(PdialogBox)
            self.boxlabel.setGeometry(0, 0, dialogBox.width, dialogBox.height)
            self.textlabel.setPixmap(PdialogText)
            self.textlabel.setGeometry(0, 0, dialogText.width, dialogText.height)
            if self.order == 1:
                setopacity(self.boxlabel, 0)
                setopacity(self.textlabel, 0)

            self.dialoging=self.emotionchange=True
            self.t0=0
            pg.mixer.stop()
            try:
                namefile=name if name.isupper() else name.capitalize()
                self.voice = pg.mixer.Sound(f"audios/JP_{namefile}/{name}_{index}.ogg")
            except:
                self.voice = pg.mixer.Sound("audios/mute.ogg")
            self.voice.set_volume(self.voiceVolume)
            self.length=max(self.voice.get_length(), 1)
            self.fixedupdate = QTimer(self)
            self.fixedupdate.timeout.connect(self.frameUpdate)
            self.voice.play()
            #self.hide()
            self.show()
            self.fixedupdate.start(1000/30)
        def frameUpdate(self, fadeIn=0.6, fadeOut=0.6):
            self.voice.set_volume(self.voiceVolume)
            if self.t0 == 0:
                self.t0 = time.time()
                t=0
                self.sizeposChange(self.k)
                self.tempCanblink=imagewindow.canblink
                imagewindow.canblink=False
                imagewindow.update(self.emotion)
            else:
                t = time.time()-self.t0
            if self.dialoging and imagewindow.candialog:
                self.timeCommunicator.data_signal.emit(t)
                if 0 <= t and t <= fadeIn:
                    if self.order == 1:
                        setopacity(self.boxlabel, t/fadeIn)
                    else:
                        setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, t/fadeIn)
                elif fadeIn < t and t <= self.length:
                    setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, 1)
                elif self.length < t and t <= self.length+fadeOut:
                    if self.emotionchange and self.end:
                        imagewindow.update(emotions[settings['defaultEmotionIndex']])
                        imagewindow.canblink=self.tempCanblink
                        self.emotionchange=False
                    if self.end:
                        setopacity(self.boxlabel, (self.length+fadeOut - t)/fadeOut)
                    else:
                        setopacity(self.boxlabel, 1)
                    setopacity(self.textlabel, (self.length+fadeOut - t)/fadeOut)
                else:
                    setopacity(self.boxlabel, 0)
                    setopacity(self.textlabel, 0)
                    t = self.length+fadeOut+1
                    self.hide()
                    self.dialoging=False
            elif not self.end:
                self.showDB(self.indexes, self.emotions, self.order)
            elif self.emotionchange:
                self.voice.stop()
                self.hide()
                setopacity(self.boxlabel, 0)
                setopacity(self.textlabel, 0)
                imagewindow.update(emotions[settings['defaultEmotionIndex']])
                imagewindow.canblink=self.tempCanblink
                self.emotionchange=self.dialoging=False
        def sizeposChange(self, data):
            self.k=data
            dialogBox=self.dialogBox0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogBox0.size))
            dialogText=self.dialogText0.resize(tuple(int(x*self.k/1.1962) for x in self.dialogText0.size))
            PdialogBox=ImageQt.toqpixmap(dialogBox)
            PdialogText=ImageQt.toqpixmap(dialogText)
            self.boxlabel.setPixmap(PdialogBox)
            self.textlabel.setPixmap(PdialogText)

            self.boxlabel.setFixedSize(dialogBox.width, dialogBox.height)
            self.textlabel.setFixedSize(dialogText.width, dialogText.height)

            charactercenter=imagewindow.frameGeometry().center()
            self.setGeometry(charactercenter.x()+(settings["dialogBoxPos"][0]-settings['characterPos'][0])*self.k/1.1962-imagewindow.size0[0]/2*imagewindow.k,
                    charactercenter.y()+(settings["dialogBoxPos"][1]-settings['characterPos'][1])*self.k/1.1962-imagewindow.size0[1]/2*imagewindow.k, 
                    dialogBox.width, dialogBox.height)
        def closeEvent(self, event):
            event.ignore()
        
    imagewindow = ImageWindow()
    imagewindow.show()
    signal.signal(signal.SIGINT, lambda: imagewindow.signalReceived())
    if firstTime:
        pg.mixer.music.load("audios/theme_14.ogg")
        pg.mixer.music.play(-1)

if __name__ == "__main__":
    if screen.width()/1600 != screen.height()/900:
        msg=QMessageBox.question(None, "提示", "屏幕比例不符合16:9，角色初始位置会歪，是否继续?", QMessageBox.Yes|QMessageBox.No)
        if msg == QMessageBox.Yes:
            main(getCurrentCharacter(), firstTime=True)
            sys.exit(app.exec_())
    else:
        main(getCurrentCharacter(), firstTime=True)
        sys.exit(app.exec_())

###########################################################################
# File: __init__.py
# Path: D:\Projects\DesktopLobby2.0\__init__.py
###########################################################################



###########################################################################
# File: actions_brfore_start.py
# Path: D:\Projects\DesktopLobby2.0\actions_brfore_start.py
###########################################################################

def ask_if_start(screen):
    from getResources import GLOBAL_CONFIG
    from PySide6.QtWidgets import QMessageBox
    
    if GLOBAL_CONFIG.PREFERENCES["repeatConfirm"] != 0:
        from windows.repeat_confirm_window import repeat_confirm
        if repeat_confirm(GLOBAL_CONFIG.PREFERENCES["repeatConfirm"]):
            ###
            if screen.geometry().width()/1600 != screen.geometry().height()/900:
                print(f"[DEBUG]Screen Size: {screen.geometry().width(),screen.geometry().height()}")
                msg=QMessageBox.warning(None, "提示", "屏幕比例不符合16:9，角色初始位置会歪，是否继续?", QMessageBox.Yes|QMessageBox.No)
                if msg == QMessageBox.Yes:
                    return True
    else:
        return True

###########################################################################
# File: communicator.py
# Path: D:\Projects\DesktopLobby2.0\communicator.py
###########################################################################

from PySide6.QtCore import QObject, Signal

class Communicator(QObject):
    # 创建一个信号类，用于传递数据
    data_signal = Signal(object)

###########################################################################
# File: custom_QDialog.py
# Path: D:\Projects\DesktopLobby2.0\custom_QDialog.py
###########################################################################

from PySide6.QtWidgets import QDialog
from signal_bus import signal_bus


class CustomQDialog(QDialog):
    def __init__(self):
        super().__init__()
        signal_bus.close_signal.connect(lambda: self.hide())

###########################################################################
# File: dataclasses_.py
# Path: D:\Projects\DesktopLobby2.0\dataclasses_.py
###########################################################################

from dataclasses import dataclass
from typing import Any, Dict, List

@dataclass
class GlobalConfig:
    CODE_NAMES: List[str] = None
    AI_SAVES: List[str] = None
    AI_TEMPLATES: List[str] = None
    PREFERENCES: Dict = None
    CONTRAST: Dict = None
    DIALOGBOX_INF: Dict = None
    LANGUAGE: Dict = None

    JOB_OBJECT: Any = None

    ANIMS: List[Any] = None

    k00: float = 1
    ZOOM_SCALE: float = 1.1962



@dataclass
class GlobalVariables:
    socket_thread: Any = None

    current_AI: Any = None
    AI_thread: Any = None

@dataclass
class CharacterConfig:
    name: str
    k0: float
    pictures: Dict
    settings: Dict
    emotions: Any
    halo_height: int
    dialogBoxImages: Any
    dialogBoxContent: Dict
    firstTime: bool
    today_is_birthday_sensei: bool
    screen: Any

@dataclass
class SettingsParameters:
    emotion: str = ''
    blink: bool = True #blinkable
    dialog: bool = True
    move: bool = False#movable
    size: float = 1.0
    close: bool = True#closable
    top_level: bool = False
    voice_volume: float = 1.0
    character: str = ''

    AI_open_new_topic: int = 0


###########################################################################
# File: getResources.py
# Path: D:\Projects\DesktopLobby2.0\getResources.py
###########################################################################

﻿from PIL import Image
import os
from functions.json_ import load_json
from loadingWindow.loading import LoadingWindowControl
from dataclasses_ import GlobalConfig, GlobalVariables
from resource_loader import get_folder_resources
from job_object import create_job_object

def loadFont(path, size, type=None, italic=False):
    from PySide6.QtGui import QFont, QFontDatabase
    if not type:
        type = QFont.Normal
    fontid = QFontDatabase.addApplicationFont(path)
    if fontid == -1:
        return None
    families = QFontDatabase.applicationFontFamilies(fontid)
    if not families:
        return None
    font = QFont()
    font.setFamily(families[0])
    font.setPointSize(size)
    font.setWeight(type)
    font.setItalic(italic)
    return font


CODE_NAMES = get_folder_resources('characters', ['dialogBoxContent.json', 'introduction.json', 'getCharacter.py'])
print(f"[DEBUG]Characters: {CODE_NAMES}")
AI_NAMES = get_folder_resources('AI', ['AI.py', 'config.json'])
print(f"[DEBUG]AI Saves: {AI_NAMES}")
AI_TEMPLATES = get_folder_resources('AI/TEMPLATES', ['AI.py', 'config.json'])
print(f"[DEBUG]AI Templates: {AI_TEMPLATES}")
PREFERENCES = load_json("preferences.json")
CONTRAST = load_json("contrast.json")
DIALOGBOX_INF = load_json("images/Lobby_balloon.json")
LANGUAGE = load_json(f"lang/{PREFERENCES['language']}.lang")

JOB_OBJECT = create_job_object()

GLOBAL_CONFIG = GlobalConfig(CODE_NAMES, AI_NAMES, AI_TEMPLATES, PREFERENCES, CONTRAST, DIALOGBOX_INF, LANGUAGE, JOB_OBJECT,
                             ZOOM_SCALE=PREFERENCES["zoomScale"])
global_variables = GlobalVariables()

LoadingWindowControl.messageLoadingWindow("Global configuration loading completed.")

tempfolderPath = os.path.join(os.getenv('TEMP'), 'DesktopLobby')
os.makedirs(tempfolderPath, exist_ok=True)
tempCharacterPath = os.path.join(tempfolderPath, "currentCharacter.json")
LoadingWindowControl.messageLoadingWindow("File creation completed.")


def setCurrentCharacter(characterName):
    with open(tempCharacterPath, 'w') as txt:
        txt.write(characterName)


def getCurrentCharacter():
    if not os.path.exists(tempCharacterPath):
        setCurrentCharacter(PREFERENCES['initialCharacter'])
    with open(tempCharacterPath, 'r') as txt:
        characterName = txt.read()
    return characterName


def getImageGroup(name):
    with open(f"images/{name}.asset", 'r') as txt:
        content = txt.readlines()
    mPixelSize = float(content[-2][(content[-2].find(':') + 2): -1])

    orimage = Image.open(f"images/{name}.png").convert("RGBA")
    images = {}
    for a in range(16, len(content) - 13, 13):
        x = int(content[a + 1][(content[a + 1].find(':') + 2): -1])
        y = int(content[a + 2][(content[a + 2].find(':') + 2): -1])
        w = int(content[a + 3][(content[a + 3].find(':') + 2): -1])
        h = int(content[a + 4][(content[a + 4].find(':') + 2): -1])
        region = orimage.crop((x, y, x + w, y + h))
        if mPixelSize != 1.0:
            region = region.resize((w * a, h * a))
        name = content[a][(content[a].find(':') + 2): -1]
        images[name] = region
    return images


def getImage(gname, iname):
    with open(f"images/{gname}.asset", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"images/{gname}.png").convert("RGBA")
    for a in range(16, len(content) - 13, 13):
        if content[a][(content[a].find(':') + 2): -1] == iname:
            x = int(content[a + 1][(content[a + 1].find(':') + 2):])
            y = int(content[a + 2][(content[a + 2].find(':') + 2):])
            w = int(content[a + 3][(content[a + 3].find(':') + 2):])
            h = int(content[a + 4][(content[a + 4].find(':') + 2):])
            image = orimage.crop((x, y, x + w, y + h))
            break
    return image


def getDialogBoxContent(name):
    return load_json(f"characters/{name}/dialogBoxContent.json")

###########################################################################
# File: job_object.py
# Path: D:\Projects\DesktopLobby2.0\job_object.py
###########################################################################


###########################################################################
# File: removeRemoteImage.py
# Path: D:\Projects\DesktopLobby2.0\removeRemoteImage.py
###########################################################################

from PIL import Image
import numpy as np
from scipy import ndimage

def removeRemoteImage(image0, startx, starty, minAlpha=5):
    if image0.mode != 'RGBA':
        image0 = image0.convert('RGBA')
    
    alpha = np.array(image0)[:, :, 3]
    mask = alpha >= minAlpha
    
    # 标记所有连通区域
    labels, num_labels = ndimage.label(mask)
    target_label = labels[starty, startx]
    
    if target_label == 0:  # 起点 Alpha 不足
        return Image.new('RGBA', image0.size, (0,0,0,0))
    
    # 提取该区域
    region_mask = (labels == target_label)
    new_array = np.zeros((*image0.size[::-1], 4), dtype=np.uint8)
    new_array[region_mask] = np.array(image0)[region_mask]
    
    return Image.fromarray(new_array, 'RGBA')

if __name__  == '__main__':
    from PIL import Image
    import time
    i = Image.open('CH0069_spr.png')
    t = time.perf_counter()
    r = removeRemoteImage(i, 512, 1024)
    t1 = time.perf_counter()
    print(t1-t)
    r.save('r.png')

###########################################################################
# File: renderDialogBox.py
# Path: D:\Projects\DesktopLobby2.0\renderDialogBox.py
###########################################################################

from getResources import getImage
from functions.json_ import load_json
from PIL import Image, ImageDraw, ImageFont
import numpy as np
from itertools import chain
DBInf=load_json("images/Lobby_balloon.json")

font=ImageFont.truetype("fonts/有爱魔兽圆体-R.ttf", 45)
image0 = getImage('Common', 'Lobby_balloon')
def textsize(draw, text, font=None):
    bbox=draw.textbbox((0,0), text, font=font)
    return bbox[2] - bbox[0], bbox[3] - bbox[1]

def render_Lobby_balloonCombined(textlines, line_spacing=4):
    textlines = list(chain(*[line.split('\n') for line in textlines]))
    orimage = image0.copy()
    draw=ImageDraw.Draw(orimage)
    standardSize = textsize(draw, "羊", font)
    standardSize = (standardSize[0], standardSize[1] + line_spacing)

    dbPlusW = max(textsize(draw, a, font)[0] for a in textlines)
    dbPlusH = (len(textlines) -1) * standardSize[1]
    newimage = Image.new(orimage.mode, (orimage.size[0]+dbPlusW, orimage.size[1]+dbPlusH))
    newimage.paste(orimage.crop((0, 0, 82, orimage.size[0])), (0, 0))
    newimage.paste(orimage.crop((82, 0, orimage.size[0], orimage.size[1])), (82+dbPlusW, 0))

    verticalLine = orimage.crop((82, 0, 83, orimage.size[1]))
    for a in range(0, dbPlusW):
        newimage.paste(verticalLine, (82+a, 0))
    
    if dbPlusH != 0:
        orimage = newimage
        newimage.paste(orimage.crop((0, 0, orimage.size[1], 86)), (0, 0))
        newimage.paste(orimage.crop((0, 86, orimage.size[0], orimage.size[1])), (0, 86+dbPlusH))
        horizontalLine = orimage.crop((0, 86, orimage.size[0], 87))
        for a in range(0, dbPlusH):
            newimage.paste(horizontalLine, (0, 86+a))
    alpha=newimage.split()[-1]
    draw=ImageDraw.Draw(newimage)
    for a, text in enumerate(textlines):
        draw.text((78, 34 + a*standardSize[1]), text, font=font, fill=(0, 0, 0))
    newimage=Image.merge('RGBA', newimage.split()[:3] + tuple([alpha]))
    newimage=newimage.resize(tuple(int(x*DBInf['k']) for x in newimage.size))
    print("[DEBUG]Dialog Content:", textlines)
    return newimage
def render_Lobby_balloon(textlines, line_spacing=4):
    textlines = list(chain(*[line.split('\n') for line in textlines]))

    orimage = image0.copy()
    draw=ImageDraw.Draw(orimage)
    standardSize = textsize(draw, "羊", font)
    standardSize = (standardSize[0], standardSize[1] + line_spacing)

    dbPlusW = max(textsize(draw, a, font)[0] for a in textlines)
    dbPlusH = (len(textlines) -1) * standardSize[1]
    newimage = Image.new(orimage.mode, (orimage.size[0]+dbPlusW, orimage.size[1]+dbPlusH))
    newimage.paste(orimage.crop((0, 0, 82, orimage.size[0])), (0, 0))
    newimage.paste(orimage.crop((82, 0, orimage.size[0], orimage.size[1])), (82+dbPlusW, 0))

    verticalLine = orimage.crop((82, 0, 83, orimage.size[1]))
    for a in range(0, dbPlusW):
        newimage.paste(verticalLine, (82+a, 0))
    
    if dbPlusH != 0:
        orimage = newimage
        newimage.paste(orimage.crop((0, 0, orimage.size[1], 86)), (0, 0))
        newimage.paste(orimage.crop((0, 86, orimage.size[0], orimage.size[1])), (0, 86+dbPlusH))
        horizontalLine = orimage.crop((0, 86, orimage.size[0], 87))
        for a in range(0, dbPlusH):
            newimage.paste(horizontalLine, (0, 86+a))
    textimage=Image.new(newimage.mode, newimage.size)
    draw=ImageDraw.Draw(textimage)
    for a, text in enumerate(textlines):
        draw.text((78, 34 + a*standardSize[1]), text, font=font, fill=(0, 0, 0))
    alphan=np.array(newimage)[:, :, 3]
    arrt=np.array(textimage)
    alphat=arrt[:, :, 3]
    mask=alphat != 0
    alphat[mask]=alphan[mask]
    textimage=Image.fromarray(arrt)

    newimage=newimage.resize(tuple(int(x*DBInf['k']) for x in newimage.size))
    textimage=textimage.resize(tuple(int(x*DBInf['k']) for x in textimage.size))
    print(f"[DEBUG]Dialog Content: {textlines}")
    return newimage, textimage
if __name__ == "__main__":
    i = render_Lobby_balloonCombined(['计划客户端结婚登记\n计划几号放假', '很简单较好的\n寒假\nfd'])
    i.save(f'1.png')

###########################################################################
# File: resource_loader.py
# Path: D:\Projects\DesktopLobby2.0\resource_loader.py
###########################################################################

import importlib.util
from functions.json_ import load_json
import os


def getCharacterInf(name):
    spec = importlib.util.spec_from_file_location("getCharacter", f"characters/{name}/getCharacter.py")
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module.getCharacter(name)


def getCharacterIntroduction(name):
    content = load_json(f"characters/{name}/introduction.json", to_json=False).replace('\n', '')
    intro, hoem = content.split("[hobby]")
    hobby, emotion = hoem.split("[emotion]")
    return intro, hobby, emotion


def get_folder_resources(path: str, required: list, excluded: list = []):
    required = set(required)
    floder_names = []
    for ch in os.listdir(path):
        if os.path.isdir(os.path.join(path, ch)) and not ch in excluded:
            # 确认所需文件在文件夹里均存在
            found = set(os.listdir(os.path.join(path, ch)))
            if required <= found:  # 子集
                floder_names.append(ch)
    return floder_names


if __name__ == '__main__':
    print(get_folder_resources('characters', ['dialogBoxContent.json', 'introduction.json', 'getCharacter.py']))
    print(get_folder_resources('AI/TEMPLATES', ['AI.py', 'config.json']))
    print(get_folder_resources('AI', ['AI.py']))

###########################################################################
# File: signal_bus.py
# Path: D:\Projects\DesktopLobby2.0\signal_bus.py
###########################################################################

from PySide6.QtCore import QObject, Signal


class SignalBus(QObject):
    settings_signal = Signal(str, object)  # key, value
    UI_windows_signal = Signal(str, object)  # key, value
    AI_settings_signal = Signal(str, str, object)  # ori_name, new_name, inf_dict
    dialog_anim_signal = Signal(str)  # ani_name

    AI_start_signal = Signal(str, object)  # name, inf_dict
    AI_generate_send_signal = Signal(object)  # dict
    AI_generate_get_signal = Signal(object)  # dict
    AI_dialog_input_signal = Signal(str)  # content

    debug_show_signal = Signal(bool)

    print_signal = Signal(str)
    close_signal = Signal()

    def __init__(self):
        super().__init__()


signal_bus = SignalBus()

###########################################################################
# File: socket_.py
# Path: D:\Projects\DesktopLobby2.0\socket_.py
###########################################################################

from PySide6.QtCore import QThread, Signal
import socket
import time

class SocketListener(QThread):
    def __init__(self, comm):
        super().__init__()
        self.comm = comm
        self.address = 10000
        self.running = True

    def run(self):
        sock = None
        while self.running and self.address <= 10009:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(0.1)  # 设置超时，避免无限阻塞
                sock.bind(('localhost', self.address))
                sock.listen(1)
                print(f"[DEBUG]Listening on port {self.address}")

                while self.running:
                    try:
                        conn, addr = sock.accept()  # 这个 accept 也会受 timeout 控制
                        data = conn.recv(1024)
                        if data:
                            message = data.decode().strip()
                            self.comm.data_signal.emit(message)
                        conn.close()
                    except socket.timeout:
                        continue  # 超时，继续检查 self.running
                    except Exception as e:
                        print("[ERROR]Socket Accept Error: {e}")
                        break  # 出错跳出内层循环，尝试下一个端口

            except Exception as e:
                print(f"[ERROR]Failed to bind on port {self.address}: {e}")
                sock = None
                self.address += 1
                time.sleep(0.1)  # 稍微等待再试

        if not self.running:
            print("[WARNING]Socket listener stopped by user.")
        else:
            print("[ERROR]All ports from 10000 to 10009 failed.")

###########################################################################
# File: AI\AI_control.py
# Path: D:\Projects\DesktopLobby2.0\AI\AI_control.py
###########################################################################

import importlib.util
from database.database import *
from signal_bus import signal_bus
from PySide6.QtCore import QObject
import time


class AI(QObject):
    def __init__(self, AI_name, inf_dict):
        super().__init__()
        spec = importlib.util.spec_from_file_location("getCharacter", f"AI/{AI_name}/AI.py")
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
        self.AI_class = module.AI(inf_dict)
        self.current_character = ''
        self.records = []
        self.character_inf = {}
        self.b = False
        self.save = True

        signal_bus.AI_generate_send_signal.connect(self.generate_result)
    def generate_result(self, data: dict, debug=False):
        """
        data.keys: current_character, user_content, example(alternative)
        """
        self.user_content = data['user_content']
        example = data.get('example', '')

        # 更换角色
        if self.current_character != data['current_character'] or not self.character_inf:
            self.current_character = data['current_character']
            self.character_inf = db_get_character_intro(name=self.current_character)
            self.records = db_get_conversation_record(self.current_character)
        if self.b:
            self.records = []
        if self.save:
            self.records.append({'role': 'user', 'content': self.user_content})
            db_add_conversation_record(name=self.current_character,
                                       role='user',
                                       content=self.user_content,
                                       emotion='0',
                                       beginning=self.b,
                                       dateF=time.time(),
                                       total_tokens=0)
        self.b = False
        prompt = self.AI_class.generate_AI_prompt(self.current_character, **self.character_inf, example=example)
        try:
            content_list, emotion, total_tokens = self.AI_class.get_answer_from_AI(self.records, prompt)
        except Exception as e:
            print(f"[ERROR]AI Error: {e}")
            content_list, emotion, total_tokens = ["出错了呢", str(e)], 'default', -1
        else:
            if self.save:
                self.records.append({'role': 'assistant', 'content': ''.join(content_list) + f'#{emotion}#'})
                db_add_conversation_record(name=self.current_character,
                                           role='assistant',
                                           content=''.join(content_list),
                                           emotion=emotion,
                                           beginning=False,
                                           dateF=time.time(),
                                           total_tokens=total_tokens)
        print(f"[DEBUG]Dialog Records: {self.records}")

        if debug:
            return f"{content_list}#{emotion}#"
        else:
            signal_bus.AI_generate_get_signal.emit({'content_list': content_list, 'emotion': emotion})

###########################################################################
# File: AI\4\AI.py
# Path: D:\Projects\DesktopLobby2.0\AI\4\AI.py
###########################################################################

try:
    from llama_cpp import Llama
except ImportError:
    print("ERROR: llama_cpp doesn't exist")
    
else:
    import time
    import os.path

    class AI:
        NAME="llama_cpp"
        PATH=""
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'llama_cpp')
            AI.PATH = inf_dict.get('PATH', f"AI/{AI.NAME}/qwen1_5-4b-chat-q4_k_m.gguf")
            try:  
                self.llm = Llama(
                    model_path=self.PATH,
                    n_ctx=4096,  # 上下文长度
                    n_threads=3,
                    seed=int(time.time()),
                    f16_kv=True,  # 使用半精度加速
                    verbose=False,
                )
            except Exception as e:
                self.llm=None
                print(f"[ERROR]AI Error: {e}")
        def init_char_prompt(self, system_prompt):
            self.llm.cache_prompt(self.llm.tokenize(system_prompt.encode('utf-8')))
        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            history: role, content
            cache=True -> cache prompt
            """
            output = self.llm.create_chat_completion(
                messages=[
                    {"role": "system","content": system_prompt},
                    *history
                ],
                max_tokens=1024,
                temperature=0.8,
                stop=["<|im_end|>"],
                repeat_penalty=1.1
            )
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: AI\TEMPLATES\llama_cpp\AI.py
# Path: D:\Projects\DesktopLobby2.0\AI\TEMPLATES\llama_cpp\AI.py
###########################################################################

try:
    from llama_cpp import Llama
except ImportError:
    print("ERROR: llama_cpp doesn't exist")
    
else:
    import time
    import os.path

    class AI:
        NAME="llama_cpp"
        PATH=""
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'llama_cpp')
            AI.PATH = inf_dict.get('PATH', f"AI/{AI.NAME}/qwen1_5-4b-chat-q4_k_m.gguf")
            try:  
                self.llm = Llama(
                    model_path=self.PATH,
                    n_ctx=4096,  # 上下文长度
                    n_threads=3,
                    seed=int(time.time()),
                    f16_kv=True,  # 使用半精度加速
                    verbose=False,
                )
            except Exception as e:
                self.llm=None
                print(f"[ERROR]AI Error: {e}")
        def init_char_prompt(self, system_prompt):
            self.llm.cache_prompt(self.llm.tokenize(system_prompt.encode('utf-8')))
        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            history: role, content
            cache=True -> cache prompt
            """
            output = self.llm.create_chat_completion(
                messages=[
                    {"role": "system","content": system_prompt},
                    *history
                ],
                max_tokens=1024,
                temperature=0.8,
                stop=["<|im_end|>"],
                repeat_penalty=1.1
            )
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: AI\TEMPLATES\pollinations\AI.py
# Path: D:\Projects\DesktopLobby2.0\AI\TEMPLATES\pollinations\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='pollinations'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        BASE_URL = "https://text.pollinations.ai/openai"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()

        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'pollinations')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            try:  
                self.client = OpenAI(api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            model="openai",
            messages=[
                {"role": "system","content": system_prompt},
                *history]
            )
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: AI\TEMPLATES\qwen\AI.py
# Path: D:\Projects\DesktopLobby2.0\AI\TEMPLATES\qwen\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='qwen'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        MODEL = "qwen-plus"
        BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'qwen')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            AI.MODEL = inf_dict.get('MODEL', "qwen-plus")
            try:  
                self.client = OpenAI(
                # 若没有配置环境变量，请用百炼API Key将下行替换为：api_key="sk-xxx",
                api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
            model=AI.MODEL,
            messages=[
                {"role": "system","content": system_prompt},
                *history],
            # Qwen3模型通过enable_thinking参数控制思考过程（开源版默认True，商业版默认False）
            # 使用Qwen3开源版模型时，若未启用流式输出，请将下行取消注释，否则会报错
            extra_body={"enable_thinking": False})
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: animation\animation_player.py
# Path: D:\Projects\DesktopLobby2.0\animation\animation_player.py
###########################################################################

from functools import lru_cache

from animation.parse_yaml import parse_anim
from animation.cache_yaml import load_yaml


@lru_cache(maxsize=64)
def load_anim(path):
    anim_json = load_yaml(path)
    anim, stop_time = parse_anim(anim_json)
    return anim, stop_time


class AnimationPlayer:
    def __init__(self, anim_name, stop_time=None):
        path = f"AnimationClip/{anim_name}.anim"
        self.anim, self.stop_time = load_anim(path)
        if stop_time:
            self.stop_time = stop_time

    def play_frame(self,
             nowtime,
             path='general',
             timeReverse=False,
             Eunit='x',
             Runit='w',
             Punit=('x', 'y'),
             Preverse=(False, False),
             Pratio=(1, 1)):

        nowtime1 = nowtime
        if timeReverse:
            nowtime = self.stop_time - nowtime
        if nowtime1 <= self.stop_time:
            dic = {}
            ani = self.anim[path]
            if 'Euler' in ani:
                e = ani.get('Euler')
                euler = self._get_seg_result(e[Eunit], nowtime)
                dic['euler'] = euler

            if 'Rotation' in ani:
                r = ani.get('Rotation')
                rotation = self._get_seg_result(r[Runit], nowtime)
                dic['rotation'] = rotation

            if 'Position' in ani:
                p = ani.get('Position')
                position = (self._get_seg_result(p[Punit[0]], nowtime) / 1 * Pratio[0],
                            self._get_seg_result(p[Punit[1]], nowtime) / 1 * Pratio[1])
                position = tuple(-position[x] if Preverse[x] else position[x] for x in (0, 1))
                dic['position'] = position

            if 'Scale' in ani:
                s = ani.get('Scale')
                scale = (self._get_seg_result(s['x'], nowtime), self._get_seg_result(s['y'], nowtime))
                dic['scale'] = scale

            if 'Float' in ani:
                f = ani.get('Float')
                if isinstance(f, list):
                    float = self._get_seg_result(f, nowtime)
                    dic['float'] = float
            else:
                float = 0.0
            return dic, True
        else:
            return {}, False

    def _get_seg_result(self, segments, t):
        """二分法查找分段插值结果"""
        if not segments:
            return 0

        left, right = 0, len(segments) - 1
        while left <= right:
            mid = (left + right) // 2
            seg = segments[mid]
            if t < seg.x[0]:
                right = mid - 1
            elif t > seg.x[-1]:
                left = mid + 1
            else:
                return seg(t)

        return segments[-1](t)  # 边界情况

    def return_default(self,
                   default_value = 0.0,
                   path='general',
                   timeReverse=False,
                   Eunit='x',
                   Runit='w',
                   Punit=('x', 'y'),
                   Preverse=(False, False),
                   Pratio=(1, 1)):

        dic = {}
        ani = self.anim[path]
        if 'Euler' in ani:
            dic['euler'] = default_value

        if 'Rotation' in ani:
            dic['rotation'] = default_value

        if 'Position' in ani:
            dic['position'] = (default_value, default_value)

        if 'Scale' in ani:
            dic['scale'] = (default_value, default_value)

        if 'Float' in ani:
            dic['float'] = default_value
        else:
            float = 0.0

        return dic, False

if __name__ == '__main__':
    import os

    os.chdir(r'D:\Projects\DesktopLobby')
    an = AnimationPlayer('UIAni_SC_Char_Shake_2')
    dic = an.play_frame(0.2)
    print(dic)

###########################################################################
# File: animation\cache_yaml.py
# Path: D:\Projects\DesktopLobby2.0\animation\cache_yaml.py
###########################################################################

import os
import json
import tempfile
import hashlib
from ruamel.yaml import YAML

yaml = YAML()
yaml.preserve_quotes = True
yaml.constructor.ignore_aliases = True


def _str_constructor(loader, node):
    if node.tag == 'tag:yaml.org,2002:bool' and node.value == 'y':
        return 'y'
    return loader.construct_scalar(node)


# 防止yaml把"y"解析成True
yaml.constructor.add_constructor('tag:yaml.org,2002:bool', _str_constructor)

temp_folder_path = os.path.join(tempfile.gettempdir(), 'DesktopLobby')
os.makedirs(temp_folder_path, exist_ok=True)


def _get_file_sha256(file_path):
    """计算文件的SHA256哈希值"""
    sha256_hash = hashlib.sha256()
    try:
        with open(file_path, "rb") as f:
            # 逐块读取文件以避免大文件内存问题
            for chunk in iter(lambda: f.read(4096), b""):
                sha256_hash.update(chunk)
        return sha256_hash.hexdigest()
    except FileNotFoundError:
        return None


def _save_cache_metadata(json_path, sha256_hash):
    """保存缓存元数据（SHA256哈希）"""
    metadata_path = json_path + '.metadata'
    try:
        with open(metadata_path, 'w') as f:
            json.dump({'sha256': sha256_hash}, f)
    except Exception as e:
        print(f"[Warning]Failed to save cache metadata: {e}")


def _load_cache_metadata(json_path):
    """加载缓存元数据"""
    metadata_path = json_path + '.metadata'
    try:
        with open(metadata_path, 'r') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return None


def load_yaml(path: str, cache=True):
    """加载并缓存yaml，使用SHA256验证文件一致性"""
    # 构建缓存json路径
    json_path = os.path.join(temp_folder_path, path.rsplit('.', 1)[0] + '.json')

    # 计算源文件的SHA256
    source_sha256 = _get_file_sha256(path)
    if source_sha256 is None:
        raise FileNotFoundError(f"Source file not found: {path}")

    try:
        # 检查缓存是否存在且有效
        metadata = _load_cache_metadata(json_path)

        if (metadata and
                metadata.get('sha256') == source_sha256 and
                os.path.exists(json_path)):

            # 缓存有效，直接读取
            with open(json_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            print(f"[DEBUG]Loaded cached data for: {path}")
            return data
        else:
            # 缓存无效或不存在，重新生成
            print(f"[WARNING]Cache invalid or missing, regenerating for: {path}")
            raise FileNotFoundError("Cache needs regeneration")

    except (FileNotFoundError, json.JSONDecodeError):
        # 缓存文件不存在或损坏，重新生成
        with open(path, 'r', encoding='utf-8') as y:
            data = yaml.load(y)

        if cache:
            # 确保目录存在
            os.makedirs(os.path.dirname(json_path), exist_ok=True)

            # 保存JSON缓存
            with open(json_path, 'w', encoding='utf-8') as j:
                json_data = json.dumps(data, ensure_ascii=False, indent=2)
                j.write(json_data)

            # 保存元数据（SHA256）
            _save_cache_metadata(json_path, source_sha256)
            print(f"[DEBUG]Cached data regenerated for: {path}")

        return json.loads(json.dumps(data))


def clear_yaml_cache(path: str = None):
    """清除YAML缓存文件"""
    if path:
        # 清除特定文件的缓存
        json_path = os.path.join(temp_folder_path, path.rsplit('.', 1)[0] + '.json')
        metadata_path = json_path + '.metadata'

        for cache_path in [json_path, metadata_path]:
            try:
                if os.path.exists(cache_path):
                    os.remove(cache_path)
                    print(f"[DEBUG]Removed cache: {cache_path}")
            except Exception as e:
                print(f"[ERROR]Error removing cache {cache_path}: {e}")
    else:
        # 清除所有缓存
        import shutil
        try:
            if os.path.exists(temp_folder_path):
                shutil.rmtree(temp_folder_path)
                os.makedirs(temp_folder_path, exist_ok=True)
                print("[DEBUG]Cleared all YAML cache")
        except Exception as e:
            print(f"[ERROR]Error clearing cache: {e}")


def get_cache_info(path: str):
    """获取缓存信息"""
    json_path = os.path.join(temp_folder_path, path.rsplit('.', 1)[0] + '.json')
    metadata = _load_cache_metadata(json_path)
    source_sha256 = _get_file_sha256(path)

    cache_exists = os.path.exists(json_path)
    metadata_exists = metadata is not None
    is_valid = metadata and metadata.get('sha256') == source_sha256

    return {
        'source_sha256': source_sha256,
        'cached_sha256': metadata.get('sha256') if metadata else None,
        'cache_exists': cache_exists,
        'metadata_exists': metadata_exists,
        'is_valid': is_valid,
        'json_path': json_path
    }

###########################################################################
# File: animation\parse_yaml.py
# Path: D:\Projects\DesktopLobby2.0\animation\parse_yaml.py
###########################################################################

from scipy.interpolate import CubicHermiteSpline
import numpy as np

def piecewise_hermite(x_points, y_points, in_slopes, out_slopes, in_weights, out_weights, tangentMode, weightedMode):
    # 转为 numpy 数组
    x_points = np.array(x_points)
    y_points = np.array(y_points)
    in_slopes = np.array(in_slopes)
    out_slopes = np.array(out_slopes)
    in_weights = np.array(in_weights)
    out_weights = np.array(out_weights)
    tangentMode = np.array(tangentMode)
    weightedMode = np.array(weightedMode)

    # 加权模式处理
    if np.all(weightedMode == 0.0):
        in_slopes = np.clip(in_slopes, -1e8, 1e8)
        out_slopes = np.clip(out_slopes, -1e8, 1e8)
        in_slopes *= in_weights
        out_slopes *= out_weights

    segments = []

    # 判断是否分段（tangentMode == 1 表示该点是“可连接”的内部点）
    # 我们按“断点”分段：tangentMode != 1 的点作为分段边界
    break_points = np.where(tangentMode != 1.0)[0]  # 不连续的点
    indices = [0] + list(break_points) + [len(x_points)-1]
    indices = sorted(set(indices))

    for i in range(len(indices) - 1):
        start = indices[i]
        end = indices[i+1] + 1  # 包含 end 点
        x_seg = x_points[start:end]
        y_seg = y_points[start:end]
        if len(x_seg) < 2:
            continue

        # 使用平均斜率（或选择 in/out）
        slopes_seg = (in_slopes[start:end] + out_slopes[start:end]) / 2

        try:
            cs = CubicHermiteSpline(x_seg, y_seg, slopes_seg)
            segments.append(cs)
        except Exception as e:
            segments.append(None)

    return segments

def _parse_m_Curve(m_Curve_list):
    """解析一个m_Curve块，并进行插值处理"""
    #m_Curve内的所有参数
    parameter_keys = list(m_Curve_list[0].keys())
    parameter_keys.remove("serializedVersion")
    parameter_dict = {}
    for key in parameter_keys:
        if type(m_Curve_list[0][key]) == dict:
            parameter_dict [key] = {x: tuple(0 if curve[key][x] in ('Infinity', '-Infinity') else curve[key][x] for curve in m_Curve_list) for x in m_Curve_list[0][key].keys()}
        else:
            parameter_dict [key] = tuple(0 if curve[key] in ('Infinity', '-Infinity') else curve[key] for curve in m_Curve_list)
    #把parameter_dict中的数据进行插值，x: time, y: values
    if type(parameter_dict["value"]) == dict:
        #依次传入参数进行插值
        interpolation_list = {x: piecewise_hermite(parameter_dict["time"], *tuple(parameter_dict[para][x] for para in ("value", "inSlope", "outSlope", "inWeight", "outWeight")), parameter_dict["tangentMode"], parameter_dict["weightedMode"]) for x in parameter_dict["value"].keys()}
    else:
        #依次传入参数进行插值
        interpolation_list = piecewise_hermite(parameter_dict["time"], *tuple(parameter_dict[para] for para in ("value", "inSlope", "outSlope", "inWeight", "outWeight")), parameter_dict["tangentMode"], parameter_dict["weightedMode"])
    max_time = max(parameter_dict["time"])
    return interpolation_list, max_time

def _parse_curve(m_XCurves):
    """
    解析一个m_XCurve块
    输出：{"path": "m_Curve_interpolation", ...}
    """
    output = {}
    general_times = 0
    max_times=[]
    for m_XCurve in m_XCurves:
        path = m_XCurve["path"]
        if path == None:
            path = 'general' if general_times == 0 else f"general({general_times})"
            general_times += 1
        parse_output, max_time = _parse_m_Curve(m_XCurve["curve"]["m_Curve"])
        output [path] = parse_output
        max_times.append(max_time)
    max_time_ = max(max_times)
    return output, max_time


def parse_anim(anim_dict):
    anim_dict = anim_dict["AnimationClip"]
    stop_time = anim_dict["m_AnimationClipSettings"]["m_StopTime"]
    m_XCurveses = ("m_RotationCurves", "m_CompressedRotationCurves", "m_EulerCurves", "m_PositionCurves", "m_ScaleCurves")
    paths = {}
    for m_XCurves in m_XCurveses:
        m_XCurves_list = anim_dict[m_XCurves]
        if m_XCurves_list:
            m_XCurves_dict, max_time = _parse_curve(m_XCurves_list)
            for path_key, m_Curve_interpolation in m_XCurves_dict.items():
                if not path_key in paths.keys():
                    paths[path_key] = {}
                paths[path_key][m_XCurves[2:-6]] = m_Curve_interpolation
            if stop_time == 1 and type(stop_time) == int:
                stop_time = max_time
    return paths, stop_time

###########################################################################
# File: animation\pyside_animation_player.py
# Path: D:\Projects\DesktopLobby2.0\animation\pyside_animation_player.py
###########################################################################

from typing import TypedDict, Tuple, Literal
from PySide6.QtCore import QTimer, Signal
from animation.animation_player import AnimationPlayer
from dacite import from_dict
from dataclasses import dataclass, asdict
@dataclass
class PlayKwargs:
    """
    描述 play 方法的可选关键字参数。
    total=False 表示所有字段都是可选的，这符合 **kwargs 的特性。
    """
    path: str = 'general'
    timeReverse: bool = False
    Eunit: Literal['x', 'y', 'z', 'w'] = 'x'  # 使用 Literal 限制字符串的取值范围
    Runit: Literal['x', 'y', 'z', 'w'] = 'w'
    Punit: Tuple[Literal['x', 'y', 'z', 'w'], Literal['x', 'y', 'z', 'w']] = ('x', 'y')
    Preverse: Tuple[bool, bool] = (False, False)
    Pratio: Tuple[float, float] = (1, 1)  # 假设 Pratio 是浮点数比例


class PysideAnimationPlayer(AnimationPlayer):
    def __init__(self, signal: Signal, anim_name: str, stop_time: float = None,
                 **kwargs):
        super().__init__(anim_name, stop_time)
        self.signal = signal
        self.parameters = asdict(from_dict(PlayKwargs, kwargs))
        self.mode = 0  # 0: stop, 1: forward_play, -1: backward_play
        self.t = 0
        self.delta_t = 1/60
        self.timer = QTimer()
        self.timer.timeout.connect(self._pyside_play_frame)

    def _pyside_play_frame(self):
        result, self.playable = self.play_frame(self.t, **self.parameters)
        if self.playable:
            self.signal.emit(result)
        else:
            self.signal.emit(self.return_default(path=self.parameters['path'])[0])
            self.mode = 0
            self.timer.stop()
        if self.mode > 0:
            self.t += self.delta_t * self.mode
        elif self.mode < 0:
            self.t += self.delta_t * self.mode
    def play(self):
        self.mode = 1
        self.timer.start(self.delta_t * 1000)


###########################################################################
# File: audios\sound.py
# Path: D:\Projects\DesktopLobby2.0\audios\sound.py
###########################################################################

from pygame import mixer, sndarray
from functools import lru_cache

mixer.init()

def _create_silent_sound(duration_ms=1000):
    """
    纯代码创建一个无声音频的 Sound 对象。

    Args:
        duration_ms (int): 静音的时长，单位为毫秒。默认为 1000ms (1秒)。

    Returns:
        pygame.mixer.Sound: 一个代表静音的 Sound 对象。
    """
    import numpy as np
    # 1. 获取当前混音器的设置
    # 这些设置必须与 pygame.mixer.init() 时的设置一致。
    # 如果你没有显式初始化，pygame会使用默认设置。
    freq, size, channels = mixer.get_init()
    # `size` 是位深度，如 -16 表示 16 位有符号整数。

    # 2. 计算需要多少个样本点
    # 采样率 (freq) 表示每秒的样本数。
    # duration_ms / 1000.0 将毫秒转换为秒。
    num_samples = int((duration_ms / 1000.0) * freq)

    # 3. 根据声道数创建静音数组
    if channels == 1:
        # 单声道: 创建一个一维数组
        silent_array = np.zeros(num_samples, dtype=np.int16)
    else:
        # 立体声: 创建一个二维数组，形状为 (num_samples, channels)
        silent_array = np.zeros((num_samples, channels), dtype=np.int16)
        # 注意：对于立体声，我们也可以用 `np.zeros((num_samples, 2))`

    # 4. 将 NumPy 数组转换为 Pygame Sound 对象
    silent_sound = sndarray.make_sound(silent_array)

    return silent_sound

def play_background_music(path):
    mixer.music.stop()
    mixer.music.load(path)
    mixer.music.play(-1)

@lru_cache(maxsize=128)
def load_audio_file(path):
    try:
        print(f"[DEBUG]Sound '{path}' loaded")
        sound = mixer.Sound(path)
    except Exception as e:
        print(f"[ERROR]Sound '{path}' Loading Failed: {e}")
        sound = _create_silent_sound()
    return sound

###########################################################################
# File: characters\CH0069\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\characters\CH0069\getCharacter.py
###########################################################################

import re
from json import loads
import ast
import os
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    regionRRIstart={'CH0069': (600, 136), 'CH00691': (590, 93), 'CH00692': (310, 30)}
    sources={}
    for a in range(6, len(content) - 6, 7):
        partname=content[a][:-1]
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))

        if partname == 'Halo':
            partname=partname.lower()
            region.paste(Image.new("RGBA", (145, 58)), (0, 0))
        elif partname in regionRRIstart.keys():
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name.upper())
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{partname}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, regionRRIstart[partname][0], regionRRIstart[partname][1])
                region.save(path)
        sources[partname]=region
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    image0=Image.new("RGBA", (1013, 1490))
    image0.paste(sources['CH0069'], (0, 0))
    image0.paste(sources['CH00691'], (0, 642), sources['CH00691'])
    image0.paste(sources['CH00692'], (282, 1001), sources['CH00692'])
    pictures={}
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            emotionpos=settings.get(key, settings['emotions'])
            image.paste(sources[key], (emotionpos[0]-sources[key].width, emotionpos[1]-sources[key].height), sources[key])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    pictures['halo']=sources['halo']
    
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('CH0069')

###########################################################################
# File: characters\h\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\characters\h\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: characters\hoshino\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\characters\hoshino\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: characters\momoi\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\characters\momoi\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast
import os.path
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[1][(content[1].find(':') + 1) :])

    sources={}
    nameindex=[]
    for a in range(4, len(content)):
        if not any(content[a].startswith(x) for x in ['bounds', 'offsets', 'rotate']):
            nameindex.append(a)
    nameindex.append(len(content))
    for b in range(0, len(nameindex)-1):
        rotate=0
        for c in range(nameindex[b]+1, nameindex[b+1]):
            if content[c].startswith('bounds'):
                x, y, w, h = ast.literal_eval(content[c][(content[c].find(':') + 1) :])
            elif content[c].startswith('rotate'):
                rotate = int(content[c][(content[c].find(':') + 1) :])
        if rotate==90:
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        if content[nameindex[b]].replace('\n', '') == name:
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name)
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{name}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, 25, 289)
                region.save(path)
        sources[content[nameindex[b]].replace('\n', '')]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose' or key == 'default':
            image=image0.copy()
            image.paste(sources[key], settings[key[:2]], sources[key])
            image.paste(sources['Hair_Cover_01'], settings["Hair_Cover_01"], sources['Hair_Cover_01'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    #for k, i in sources.items():
    #    i.save(f"{k}.png")
    pictures['halo']=sources['halo']
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('momoi')

###########################################################################
# File: database\database.py
# Path: D:\Projects\DesktopLobby2.0\database\database.py
###########################################################################

from peewee import (SqliteDatabase, Model,
                    CharField, IntegerField, BooleanField, FloatField)
from getResources import GLOBAL_CONFIG
from functions.json_ import load_json
from resource_loader import getCharacterIntroduction
from loadingWindow.loading import LoadingWindowControl
import time

db = SqliteDatabase('database/database.db')
db.connect()


class Character(Model):
    code_name = CharField()
    name = CharField()
    introduction = CharField()
    emotion = CharField()
    birthday = IntegerField()
    hobby = CharField()

    class Meta:
        database = db


class Conversation(Model):
    name = CharField()
    role = CharField()
    content = CharField()
    emotion = CharField()
    beginning = BooleanField()
    date = CharField()
    dateF = FloatField()
    total_tokens = IntegerField()

    class Meta:
        database = db


class AI_Saves(Model):
    name = CharField()
    inf_dict = CharField()
    config_dict = CharField()
    dateF = FloatField()

    class Meta:
        database = db


class AI_Templates(Model):
    name = CharField()
    config_dict = CharField()

    class Meta:
        database = db


# print(Character.select().where(Character.name=='Mika').get())
def db_reload_character_intro(code_name):
    introduction, hobby, emotion = getCharacterIntroduction(code_name)
    name = GLOBAL_CONFIG.CONTRAST.get(code_name, code_name)
    Character.create(code_name=code_name, name=name, introduction=introduction, emotion=emotion, hobby=hobby,
                     birthday='01-01')


def db_load_character_intro(force_reload=False):
    if force_reload:
        Character.delete().execute()
    db_character_code_names = [x.code_name for x in Character.select()]
    for code_name in GLOBAL_CONFIG.CODE_NAMES:
        if code_name not in db_character_code_names:
            LoadingWindowControl.messageLoadingWindow(f"[database] character:{code_name}")
            db_reload_character_intro(code_name)


def db_get_character_intro(code_name=None, name=None):
    """
    return: introduction, hobby, emotions
    """
    if code_name:
        cha = Character.select().where(Character.code_name == code_name).first()

    elif name:
        cha = Character.select().where(Character.name == name).first()
    return {"introduction": cha.introduction, "hobby": cha.hobby, "emotions": cha.emotion}


def db_reload_AI_template(ai_name):
    config = load_json(f"AI/TEMPLATES/{ai_name}/config.json", to_string=True)
    AI_Templates.create(name=ai_name, config_dict=config)


def db_load_AI_templates(force_reload=False):
    if force_reload:
        AI_Templates.delete().execute()
    db_ai_names = [x.name for x in AI_Templates.select()]
    for ai_name in GLOBAL_CONFIG.AI_TEMPLATES:
        if ai_name not in db_ai_names:
            LoadingWindowControl.messageLoadingWindow(f"[database] AI:{ai_name}")
            db_reload_AI_template(ai_name)


def db_get_AI_templates_config(name: str) -> dict:
    from json import loads
    line_config = AI_Templates.select().where(AI_Templates.name == name).first()
    return loads(line_config.config_dict)


def db_create_AI_save(name: str, parameters, config_dict):
    from json import dumps
    from functions.cipher import encrypt_api_key

    # 加密
    parameters_copy = parameters.copy()
    for key, value in parameters.items():
        if type(config_dict['parameters'][key]) == dict:
            if config_dict['parameters'][key]['secret']:
                parameters_copy[key] = encrypt_api_key(value, parameters['NAME'])

    AI_Saves.create(name=name, inf_dict=dumps(parameters_copy), config_dict=dumps(config_dict), dateF=time.time())


def db_modify_AI_save(ori_name: str, new_name: str, parameters, config_dict):
    db_delete_AI_save(ori_name)
    db_create_AI_save(new_name, parameters, config_dict)

def db_delete_AI_save(name: str):
    AI_Saves.delete().where(AI_Saves.name == name).execute()

def db_get_AI_save_config(name: str) -> (dict, dict):
    from json import loads
    from functions.cipher import decrypt_api_key

    line_config = AI_Saves.select().where(AI_Saves.name == name).first()
    parameters = loads(line_config.inf_dict)
    config_dict = loads(line_config.config_dict)

    # 解密
    parameters_copy = parameters.copy()
    for key, value in parameters.items():
        if type(config_dict['parameters'][key]) == dict:
            if config_dict['parameters'][key]['secret']:
                parameters_copy[key] = decrypt_api_key(value, parameters['NAME'])

    return parameters_copy, config_dict


def db_add_conversation_record(**kwargs):
    """
    name, role, content, emotion, beginning, dateF, total_tokens
    """
    date = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(kwargs['dateF']))
    Conversation.create(**kwargs, date=date)


def db_get_conversation_record(character):
    records = []
    query = Conversation.select().where(Conversation.name == character).order_by(Conversation.dateF.desc())
    for record in query:
        if record.beginning:
            break
        content = f"{record.content}#{record.emotion}#" if record.emotion != '0' else record.content
        records.append({'role': record.role, 'content': content})

    records.reverse()
    return records


def db_delete_conversation_record(day, character='all'):
    Ddate = time.time() - day * 24 * 60 * 60
    if character == 'all':
        Conversation.delete().where(Conversation.dateF < Ddate).execute()
    else:
        Conversation.delete().where(Conversation.name == character, Conversation.dateF < Ddate).execute()


if not db.get_tables():
    # 创建表
    db.create_tables([Character, Conversation, AI_Saves, AI_Templates])
    db_load_character_intro()
    db_load_AI_templates()

if __name__ == "__main__":
    db_load_character_intro()
    db_load_AI_templates(True)
    db_load_AI_saves(True)
    db_delete_conversation_record(0)
    # for a in range(100):
    #    db_add_conversation_record(name='mika', role='assistant', content=f"就开始多少{a}", emotion='Happy', beginning=False, dateF=time.time(), total_tokens=123)
    r = db_get_conversation_record('mika')
    print(r)

###########################################################################
# File: dist\DesktopLobby\AI\TEMPLATES\llama_cpp\AI.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\AI\TEMPLATES\llama_cpp\AI.py
###########################################################################

try:
    from llama_cpp import Llama
except ImportError:
    print("ERROR: llama_cpp doesn't exist")
    
else:
    import time
    import os.path

    class AI:
        NAME="llama_cpp"
        PATH=""
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'llama_cpp')
            AI.PATH = inf_dict.get('PATH', f"AI/{AI.NAME}/qwen1_5-4b-chat-q4_k_m.gguf")
            try:  
                self.llm = Llama(
                    model_path=self.PATH,
                    n_ctx=4096,  # 上下文长度
                    n_threads=3,
                    seed=int(time.time()),
                    f16_kv=True,  # 使用半精度加速
                    verbose=False,
                )
            except Exception as e:
                self.llm=None
                print(f"[ERROR]AI Error: {e}")
        def init_char_prompt(self, system_prompt):
            self.llm.cache_prompt(self.llm.tokenize(system_prompt.encode('utf-8')))
        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            history: role, content
            cache=True -> cache prompt
            """
            output = self.llm.create_chat_completion(
                messages=[
                    {"role": "system","content": system_prompt},
                    *history
                ],
                max_tokens=1024,
                temperature=0.8,
                stop=["<|im_end|>"],
                repeat_penalty=1.1
            )
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: dist\DesktopLobby\AI\TEMPLATES\pollinations\AI.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\AI\TEMPLATES\pollinations\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='pollinations'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        BASE_URL = "https://text.pollinations.ai/openai"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()

        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'pollinations')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            try:  
                self.client = OpenAI(api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            model="openai",
            messages=[
                {"role": "system","content": system_prompt},
                *history]
            )
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: dist\DesktopLobby\AI\TEMPLATES\qwen\AI.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\AI\TEMPLATES\qwen\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='qwen'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        MODEL = "qwen-plus"
        BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'qwen')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            AI.MODEL = inf_dict.get('MODEL', "qwen-plus")
            try:  
                self.client = OpenAI(
                # 若没有配置环境变量，请用百炼API Key将下行替换为：api_key="sk-xxx",
                api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
            model=AI.MODEL,
            messages=[
                {"role": "system","content": system_prompt},
                *history],
            # Qwen3模型通过enable_thinking参数控制思考过程（开源版默认True，商业版默认False）
            # 使用Qwen3开源版模型时，若未启用流式输出，请将下行取消注释，否则会报错
            extra_body={"enable_thinking": False})
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: dist\DesktopLobby\characters\CH0069\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\CH0069\getCharacter.py
###########################################################################

import re
from json import loads
import ast
import os
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    regionRRIstart={'CH0069': (600, 136), 'CH00691': (590, 93), 'CH00692': (310, 30)}
    sources={}
    for a in range(6, len(content) - 6, 7):
        partname=content[a][:-1]
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))

        if partname == 'Halo':
            partname=partname.lower()
            region.paste(Image.new("RGBA", (145, 58)), (0, 0))
        elif partname in regionRRIstart.keys():
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name.upper())
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{partname}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, regionRRIstart[partname][0], regionRRIstart[partname][1])
                region.save(path)
        sources[partname]=region
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    image0=Image.new("RGBA", (1013, 1490))
    image0.paste(sources['CH0069'], (0, 0))
    image0.paste(sources['CH00691'], (0, 642), sources['CH00691'])
    image0.paste(sources['CH00692'], (282, 1001), sources['CH00692'])
    pictures={}
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            emotionpos=settings.get(key, settings['emotions'])
            image.paste(sources[key], (emotionpos[0]-sources[key].width, emotionpos[1]-sources[key].height), sources[key])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    pictures['halo']=sources['halo']
    
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('CH0069')

###########################################################################
# File: dist\DesktopLobby\characters\CH0069\removeRemoteImage.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\CH0069\removeRemoteImage.py
###########################################################################

from PIL import Image
import numpy as np
from scipy import ndimage

def removeRemoteImage(image0, startx, starty, minAlpha=5):
    if image0.mode != 'RGBA':
        image0 = image0.convert('RGBA')
    
    alpha = np.array(image0)[:, :, 3]
    mask = alpha >= minAlpha
    
    # 标记所有连通区域
    labels, num_labels = ndimage.label(mask)
    target_label = labels[starty, startx]
    
    if target_label == 0:  # 起点 Alpha 不足
        return Image.new('RGBA', image0.size, (0,0,0,0))
    
    # 提取该区域
    region_mask = (labels == target_label)
    new_array = np.zeros((*image0.size[::-1], 4), dtype=np.uint8)
    new_array[region_mask] = np.array(image0)[region_mask]
    
    return Image.fromarray(new_array, 'RGBA')

if __name__  == '__main__':
    from PIL import Image
    import time
    i = Image.open('CH0069_spr.png')
    t = time.perf_counter()
    r = removeRemoteImage(i, 512, 1024)
    t1 = time.perf_counter()
    print(t1-t)
    r.save('r.png')

###########################################################################
# File: dist\DesktopLobby\characters\h\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\h\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: dist\DesktopLobby\characters\hoshino\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\hoshino\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: dist\DesktopLobby\characters\momoi\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\momoi\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast
import os.path
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[1][(content[1].find(':') + 1) :])

    sources={}
    nameindex=[]
    for a in range(4, len(content)):
        if not any(content[a].startswith(x) for x in ['bounds', 'offsets', 'rotate']):
            nameindex.append(a)
    nameindex.append(len(content))
    for b in range(0, len(nameindex)-1):
        rotate=0
        for c in range(nameindex[b]+1, nameindex[b+1]):
            if content[c].startswith('bounds'):
                x, y, w, h = ast.literal_eval(content[c][(content[c].find(':') + 1) :])
            elif content[c].startswith('rotate'):
                rotate = int(content[c][(content[c].find(':') + 1) :])
        if rotate==90:
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        if content[nameindex[b]].replace('\n', '') == name:
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name)
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{name}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, 25, 289)
                region.save(path)
        sources[content[nameindex[b]].replace('\n', '')]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose' or key == 'default':
            image=image0.copy()
            image.paste(sources[key], settings[key[:2]], sources[key])
            image.paste(sources['Hair_Cover_01'], settings["Hair_Cover_01"], sources['Hair_Cover_01'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    #for k, i in sources.items():
    #    i.save(f"{k}.png")
    pictures['halo']=sources['halo']
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('momoi')

###########################################################################
# File: dist\DesktopLobby\characters\momoi\removeRemoteImage.py
# Path: D:\Projects\DesktopLobby2.0\dist\DesktopLobby\characters\momoi\removeRemoteImage.py
###########################################################################

from PIL import Image
import numpy as np
from scipy import ndimage

def removeRemoteImage(image0, startx, starty, minAlpha=5):
    if image0.mode != 'RGBA':
        image0 = image0.convert('RGBA')
    
    alpha = np.array(image0)[:, :, 3]
    mask = alpha >= minAlpha
    
    # 标记所有连通区域
    labels, num_labels = ndimage.label(mask)
    target_label = labels[starty, startx]
    
    if target_label == 0:  # 起点 Alpha 不足
        return Image.new('RGBA', image0.size, (0,0,0,0))
    
    # 提取该区域
    region_mask = (labels == target_label)
    new_array = np.zeros((*image0.size[::-1], 4), dtype=np.uint8)
    new_array[region_mask] = np.array(image0)[region_mask]
    
    return Image.fromarray(new_array, 'RGBA')

if __name__  == '__main__':
    from PIL import Image
    import time
    i = Image.open('CH0069_spr.png')
    t = time.perf_counter()
    r = removeRemoteImage(i, 512, 1024)
    t1 = time.perf_counter()
    print(t1-t)
    r.save('r.png')

###########################################################################
# File: functions\ImageQt.py
# Path: D:\Projects\DesktopLobby2.0\functions\ImageQt.py
###########################################################################

import numpy as np
from PIL import Image
from PySide6.QtGui import QImage, QPixmap
def toqpixmap(pil_image: Image.Image) -> QPixmap:

    if pil_image.mode != 'RGBA':
        pil_image = pil_image.convert('RGBA')
    
    data = np.array(pil_image)
    h, w, c = data.shape
    qimage = QImage(data.data, w, h, c*w, QImage.Format_RGBA8888)
    return QPixmap.fromImage(qimage)

###########################################################################
# File: functions\__init__.py
# Path: D:\Projects\DesktopLobby2.0\functions\__init__.py
###########################################################################



###########################################################################
# File: functions\birthday.py
# Path: D:\Projects\DesktopLobby2.0\functions\birthday.py
###########################################################################

def _judgeBirthdayPlayer(birthdayDate, date_format="%m-%d"):
    import time
    try:
    # 获取当前时间的月日部分
        current_month_day = time.strftime(date_format)
    
    # 将给定日期字符串解析为时间元组
        given_time_tuple = time.strptime(birthdayDate, date_format)
        given_month_day = time.strftime(date_format, given_time_tuple)
    
    # 比较两个日期字符串
        if given_month_day == current_month_day:return True
        else:return False
    except ValueError as e:
        print(f"[ERROR]Date Format Error: {e}")
        return False

import os
from getResources import tempfolderPath
tempBirthdayPath=os.path.join(tempfolderPath, "senseiBirthday.data")

def setBirthdayDate(date: str):
    """在临时文件目录储存sensei生日"""
    from functions.cipher import encrypt_api_key
    result=encrypt_api_key(date, 'birthday')

    with open(tempBirthdayPath, 'w') as txt:
        txt.write(str(result))
def getBirthdayDate():
    """从临时文件目录获取sensei生日"""
    try:
        from functions.cipher import decrypt_api_key
        with open(tempBirthdayPath, 'r') as txt:
            data=txt.read()
        senseiBirthday = decrypt_api_key(data, 'birthday')
    except (FileNotFoundError, PermissionError, RuntimeError) as e:
        senseiBirthday = None
    return senseiBirthday
 
def getIftodayIsSenseiBirthday(app, screen, force_show=False):
    birthday_sensei=getBirthdayDate()
    if not birthday_sensei or force_show:
        from windows.UI_enter_birthday_date_window import UI_EnterBirthdayDateWindow
        EBDWindow=UI_EnterBirthdayDateWindow((screen.size().width(), screen.size().height()))
        app.exec()
        birthday_sensei=getBirthdayDate()
    if birthday_sensei:
        return _judgeBirthdayPlayer(birthday_sensei)
    else:
        return False

###########################################################################
# File: functions\cipher.py
# Path: D:\Projects\DesktopLobby2.0\functions\cipher.py
###########################################################################

import keyring
import secrets
from cryptography.fernet import Fernet
from base64 import urlsafe_b64encode

SERVICE_NAME = "DesktopLobby"

def get_or_create_master_key(MASTER_KEY_ID):
    # 尝试从系统钥匙串获取主密钥
    master_key = keyring.get_password(SERVICE_NAME, MASTER_KEY_ID)
    if master_key is None:
        # 第一次运行：生成主密钥并保存
        raw_key = secrets.token_bytes(32)  # 256位
        master_key = urlsafe_b64encode(raw_key).decode()
        keyring.set_password(SERVICE_NAME, MASTER_KEY_ID, master_key)
    return master_key


def encrypt_api_key(api_key: str, MASTER_KEY_ID) -> str:
    master_key = get_or_create_master_key(MASTER_KEY_ID)
    f = Fernet(master_key.encode())
    token = f.encrypt(api_key.encode())
    return str(token, encoding='utf-8')


def decrypt_api_key(token: str, MASTER_KEY_ID) -> str:
    try:
        master_key = keyring.get_password(SERVICE_NAME, MASTER_KEY_ID)
        if not master_key:
            raise RuntimeError("主密钥未找到，请先设置 API Key")

        f = Fernet(master_key.encode())
        return f.decrypt(bytes(token, encoding='utf-8')).decode()
    except Exception as e:
        raise RuntimeError(f"解密失败：可能是文件损坏或系统账户变更") from e

###########################################################################
# File: functions\counter.py
# Path: D:\Projects\DesktopLobby2.0\functions\counter.py
###########################################################################

from typing import Literal

def counter(amount, n0=0):
    n = n0

    def count(type: Literal['last', 'next', 'get']):
        nonlocal n
        if type == 'last':
            n -= 1
        elif type == 'next':
            n += 1
        return n % amount
    return count

###########################################################################
# File: functions\generateUIImages.py
# Path: D:\Projects\DesktopLobby2.0\functions\generateUIImages.py
###########################################################################

from PIL import Image, ImageDraw, ImageFont
import numpy as np
from getResources import getImage

def generateImage(type, num=2):
    if type== "HideDesktopIcons":
        shell0=getImage('Common', 'Common_BGDeco')
        cores=[getImage('Common', 'Common_UIHide_Icon'),getImage('Common', 'Common_UIHide_Icon2')]

        shell=Image.new("RGBA", (shell0.width*2-10, shell0.height), (0, 0, 0, 0))
        shell.paste(shell0, (0, 0))
        shell.paste(shell0.rotate(180), (shell0.width-10, 0))
        draw=ImageDraw.Draw(shell)
        draw.rectangle([(25, 0), (152, 99)], fill=(255, 255, 255, 255))
        outputs=[]
        for core in cores:
            array=np.array(core)
            array[:,:,:3]=[69,99,151]
            array=array.astype(np.uint8)
            core=Image.fromarray(array)
            output=shell.copy()
            output.paste(core, tuple(int((x-y)/2) for x, y in zip(shell.size, core.size)), mask=core)
            outputs.append(output)
        return outputs
    elif type == "ChangeCharacterMode":
        shell0=getImage('Common', 'Common_BGDeco')
        core=getImage('Common', 'Common_Icon_Change')
        core=core.resize(tuple(int(1.6*x) for x in core.size))

        shell=Image.new("RGBA", (shell0.width*2-10, shell0.height), (0, 0, 0, 0))
        shell.paste(shell0, (0, 0))
        shell.paste(shell0.rotate(180), (shell0.width-10, 0))
        draw=ImageDraw.Draw(shell)
        draw.rectangle([(25, 0), (152, 99)], fill=(255, 255, 255, 255))

        array=np.array(core)
        array[:,:,:3]=[69,99,151]
        array=array.astype(np.uint8)
        core=Image.fromarray(array)
        shell.paste(core, tuple(int((x-y)/2) for x, y in zip(shell.size, core.size)), mask=core)

        font=ImageFont.truetype("fonts/有爱魔兽圆体-R.ttf", 30)
        outputs=[]
        for n in range(1, num+1):
            output=shell.copy()
            draw=ImageDraw.Draw(output)
            text=f"{n}/{num}"
            textsize=draw.textsize(text, font)
            draw.text(tuple(int((x-y)/2) for x, y in zip(output.size, textsize)), text, fill=(69,99,151), font=font)
            outputs.append(output)
        return outputs

###########################################################################
# File: functions\json_.py
# Path: D:\Projects\DesktopLobby2.0\functions\json_.py
###########################################################################

from json import loads, dumps, JSONDecodeError

def load_json(path, encoding='UTF-8-sig', startWords=['#'], joinWord='', to_string=False, to_json=True):
     try:
          with open(path, 'r', encoding=encoding) as txt:
               content = joinWord.join([s for s in txt.readlines() if not any(s.startswith(startWord) for startWord in startWords)])
          if to_json:
               content = loads(content)
          if to_string:
               content=dumps(content)
          return content
     except (FileNotFoundError, JSONDecodeError):
          return {} if to_json else ""

###########################################################################
# File: functions\set_background_layer.py
# Path: D:\Projects\DesktopLobby2.0\functions\set_background_layer.py
###########################################################################

import ctypes
from ctypes import wintypes
import time

user32 = ctypes.windll.user32

# 窗口枚举回调函数（用于查找所有 WorkerW）
def _enum_windows_proc(hwnd, lParam):
    class_name = ctypes.create_unicode_buffer(256)
    user32.GetClassNameW(hwnd, class_name, 256)
    if class_name.value == "WorkerW":
        # 将找到的 WorkerW 句柄添加到列表
        workerw_list.append(hwnd)
    return True

# 获取屏幕分辨率
def _get_screen_size():
    return user32.GetSystemMetrics(0), user32.GetSystemMetrics(1)

# 主函数：将指定窗口嵌入桌面图标下层
def _embed_window_as_wallpaper(target_hwnd):
    # 1. Validate target window handle
    if not user32.IsWindow(target_hwnd):
        print("[ERROR]Target window handle is invalid or no longer exists.")
        return False

    # 2. Get Progman window handle
    progman = user32.FindWindowW("Progman", "Program Manager")
    if not progman:
        print("[ERROR]Failed to find Progman window.")
        return False
    print(f"[DEBUG]Found Progman: 0x{progman:X}")

    # 3. Send 0x052C message to trigger WorkerW creation
    user32.SendMessageW(progman, 0x052C, 0, 0)
    print("[DEBUG]Sent 0x052C message to trigger desktop structure update")

    # Wait briefly for system to create windows
    time.sleep(0.1)

    # 4. Enumerate all WorkerW windows
    global workerw_list
    workerw_list = []
    ENUMWNDPROC = ctypes.WINFUNCTYPE(wintypes.BOOL, wintypes.HWND, wintypes.LPARAM)
    user32.EnumWindows(ENUMWNDPROC(_enum_windows_proc), 0)

    if len(workerw_list) < 2:
        print("[ERROR]Insufficient WorkerW windows found; expected at least 2.")
        return False
    print(f"[DEBUG]Found {len(workerw_list)} WorkerW window(s)")

    # 5. Locate the WorkerW that contains SHELLDLL_DefView (desktop icons container)
    shell_defview_container = None
    for workerw in workerw_list:
        if not user32.IsWindow(workerw):
            continue  # Skip invalid handles
        defview = user32.FindWindowExW(workerw, None, "SHELLDLL_DefView", None)
        if defview:
            shell_defview_container = workerw
            print(f"[DEBUG]Found icon container WorkerW: 0x{workerw:X}")
            break

    if not shell_defview_container:
        print("[ERROR]Could not locate WorkerW containing SHELLDLL_DefView.")
        return False

    # 6. Find the next WorkerW after the icon container (this one overlays the wallpaper)
    try:
        idx = workerw_list.index(shell_defview_container)
        if idx + 1 >= len(workerw_list):
            print("[DEBUG]Subsequent WorkerW has been removed.")
        else:
            candidate_workerw = workerw_list[idx + 1]

            if not user32.IsWindow(candidate_workerw):
                print("[WARNING]Candidate overlay WorkerW is no longer valid.")
                # Proceed anyway; it might have been destroyed by system
            else:
                print(f"[DEBUG]Candidate overlay WorkerW: 0x{candidate_workerw:X}")

                # Optional verification: next window after candidate should be Progman
                next_after_candidate = user32.GetWindow(candidate_workerw, 2)  # GW_HWNDNEXT
                if next_after_candidate != progman:
                    print("[WARNING]Candidate WorkerW is not followed by Progman; topology may have changed.")
                else:
                    print("[DEBUG]Topology verified: candidate WorkerW is correctly positioned.")

                # Close the overlay WorkerW
                print(f"[DEBUG]Closing overlay WorkerW: 0x{candidate_workerw:X}")
                user32.SendMessageW(candidate_workerw, 0x0010, 0, 0)  # WM_CLOSE

    except (ValueError, IndexError):
        print("[ERROR]Unexpected error locating candidate WorkerW.")
        return False

    # 7. Reparent target window under Progman
    if user32.SetParent(target_hwnd, progman):
        print(f"[DEBUG]Successfully reparented window 0x{target_hwnd:X} under Progman")

        screen_size = _get_screen_size()
        # Adjust position and size (optional)
        user32.SetWindowPos(
            target_hwnd,
            -1,          # HWND_BOTTOM
            0, 0,        # x, y
            *screen_size,  # width, height (adjust per monitor if needed)
            0x0040 | 0x0001  # SWP_NOZORDER | SWP_NOREDRAW
        )
        return True
    else:
        print("[ERROR]SetParent failed; could not embed window under desktop.")
        return False

# ================== 使用示例 ==================

# 示例：查找一个已知窗口并嵌入
def set_background_layer(window_title):
    target = user32.FindWindowW(None, window_title)
    if not target:
        print(f"[ERROR]Window with title '{window_title}' not found")
    else:
        print(f"[DEBUG]Found target window: 0x{target:X}")
        success = _embed_window_as_wallpaper(target)
        if success:
            print("[DEBUG]Embedding succeeded! Window is now displayed as desktop wallpaper below icons.")
        else:
            print("[ERROR]Embedding failed.")

def cancel_background_layer(window_title):
    progman = user32.FindWindowW("Progman", "Program Manager")
    target = user32.FindWindowExW(progman, None, 'SDL_app', window_title)
    if not target:
        print(f"[ERROR]Window with title '{window_title}' not found under Progman")
    else:
        print(f"[DEBUG]Found target window: 0x{target:X}")
        if user32.SetParent(target, None):
            print("[DEBUG]Successfully canceled background layer (window detached from Progman).")
        else:
            print("[ERROR]Failed to cancel background layer (SetParent failed).")

if __name__ == '__main__':
    cancel_background_layer('The Powder Toy')

###########################################################################
# File: loadingWindow\loading.py
# Path: D:\Projects\DesktopLobby2.0\loadingWindow\loading.py
###########################################################################

import multiprocessing
from loadingWindow.loadingwindow import loading_window_init
import time

class LoadingWindowControl:
    @staticmethod
    def createLoadingWindow():
        if multiprocessing.current_process().name == 'MainProcess':
            try:
                LoadingWindowControl.quene = multiprocessing.Queue()
                
                multiprocessing.set_start_method('spawn', force=True)
                LoadingWindowControl.process = multiprocessing.Process(target=loading_window_init, args=(LoadingWindowControl.quene,))
                LoadingWindowControl.process.daemon = True
                LoadingWindowControl.process.start()
                #time.sleep(3)
            except Exception as e:
                print(e)
    @staticmethod
    def messageLoadingWindow(message):
        try:
            LoadingWindowControl.quene.put(message)
        except Exception as e:
            print(e)

###########################################################################
# File: loadingWindow\loadingwindow.py
# Path: D:\Projects\DesktopLobby2.0\loadingWindow\loadingwindow.py
###########################################################################

import time
def loading_window_init(quene):
    import tkinter as tk
    import threading

    complete=False
    messages=[]
    def receiveSocket(quene):
        nonlocal complete, messages
        complete=False
        while not complete:
            try:
                data: str = quene.get()
                if data == "complete":
                    complete=True
                else:
                    messages.append(data)
                    if len(messages) > 8:
                        messages.pop(0)
            except:pass
    class LoadingWindow:
        def __init__(self, fontname):

            self.root = tk.Tk()
            self.root.overrideredirect(True)
            screenSize=(self.root.winfo_screenwidth(), self.root.winfo_screenheight())

            self.bgi=tk.PhotoImage(file="images/loading_window_background.png")
            size=(400,281)

            self.root.geometry("{}x{}+{}+{}".format(*size, *[int((x-y)/2) for x,y in zip(screenSize, size)]))
            self.canvas=tk.Canvas(self.root, width=size[0], height=size[1], highlightthickness=0)
            self.canvas.pack(fill="both", expand=True)
            self.canvas.create_image(0,0, anchor="nw", image=self.bgi)
            # 创建加载标签
            self.canvas.create_text(size[0]//2,
                                    size[1]//4.5,
                                    text="Desktop Lobby",
                                    font=(fontname, 40),
                                    fill='white',
                                    anchor='center')
            self.loadingTextID = self.canvas.create_text(size[0]//5,
                                                         size[1]//2.4,
                                                         text="Now Loading...",
                                                         font=(fontname, 15),
                                                         fill='white',
                                                         anchor='center')
            self.canvas.create_text(size[0]//1.25,
                                    size[1]//2.4,
                                    text="By LjcYounger",
                                    font=(fontname, 15),
                                    fill='white',
                                    anchor='center')
            self.canvas.create_text(size[0] // 1.25,
                                    size[1] // 3,
                                    text="Ver 2.0",
                                    font=(fontname, 12),
                                    fill='white',
                                    anchor='center')

            self.messageTextID = self.canvas.create_text(size[0]*0.06, size[1]*0.475, text="", font=(fontname, 10), fill='white', anchor='nw')
            self.a = self.t = 0
            self.dots=['...', '...', '...', '...', '·..', '.·.', '..·']
            self.update_dots()

        def update_dots(self):
            if self.t % 5 == 0:
                self.canvas.itemconfig(self.loadingTextID, text=f"Now Loading{self.dots[self.a % len(self.dots)]}")
                self.a += 1
            self.canvas.itemconfig(self.messageTextID, text="\n".join(messages))
            if complete:
                self.root.destroy()
            else:
                self.root.after(40, self.update_dots)
                self.t+=1
    th=threading.Thread(target=receiveSocket, args=(quene,))
    th.daemon=True
    th.start()
    t=time.time()
    loadingwindow=LoadingWindow("Arial")
    print(time.time()-t)
    loadingwindow.root.mainloop()

if __name__ == '__main__':
    loading_window_init(None)

###########################################################################
# File: main.dist\AI\AI_control.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\AI\AI_control.py
###########################################################################

import importlib.util
from database.database import *
from signal_bus import signal_bus
from PySide6.QtCore import QObject
import time


class AI(QObject):
    def __init__(self, AI_name, inf_dict):
        super().__init__()
        spec = importlib.util.spec_from_file_location("getCharacter", f"AI/{AI_name}/AI.py")
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
        self.AI_class = module.AI(inf_dict)
        self.current_character = ''
        self.records = []
        self.character_inf = {}
        self.b = False
        self.save = True

        signal_bus.AI_generate_send_signal.connect(self.generate_result)
    def generate_result(self, data: dict, debug=False):
        """
        data.keys: current_character, user_content, example(alternative)
        """
        self.user_content = data['user_content']
        example = data.get('example', '')

        # 更换角色
        if self.current_character != data['current_character'] or not self.character_inf:
            self.current_character = data['current_character']
            self.character_inf = db_get_character_intro(name=self.current_character)
            self.records = db_get_conversation_record(self.current_character)
        if self.b:
            self.records = []
        if self.save:
            self.records.append({'role': 'user', 'content': self.user_content})
            db_add_conversation_record(name=self.current_character,
                                       role='user',
                                       content=self.user_content,
                                       emotion='0',
                                       beginning=self.b,
                                       dateF=time.time(),
                                       total_tokens=0)
        self.b = False
        prompt = self.AI_class.generate_AI_prompt(self.current_character, **self.character_inf, example=example)
        try:
            content_list, emotion, total_tokens = self.AI_class.get_answer_from_AI(self.records, prompt)
        except Exception as e:
            print(f"[ERROR]AI Error: {e}")
            content_list, emotion, total_tokens = ["出错了呢", str(e)], 'default', -1
        else:
            if self.save:
                self.records.append({'role': 'assistant', 'content': ''.join(content_list) + f'#{emotion}#'})
                db_add_conversation_record(name=self.current_character,
                                           role='assistant',
                                           content=''.join(content_list),
                                           emotion=emotion,
                                           beginning=False,
                                           dateF=time.time(),
                                           total_tokens=total_tokens)
        print(f"[DEBUG]Dialog Records: {self.records}")

        if debug:
            return f"{content_list}#{emotion}#"
        else:
            signal_bus.AI_generate_get_signal.emit({'content_list': content_list, 'emotion': emotion})

###########################################################################
# File: main.dist\AI\qw\AI.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\AI\qw\AI.py
###########################################################################

try:
    from llama_cpp import Llama
except ImportError:
    print("ERROR: llama_cpp doesn't exist")
    
else:
    import time
    import os.path

    class AI:
        NAME="llama_cpp"
        PATH=""
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'llama_cpp')
            AI.PATH = inf_dict.get('PATH', f"AI/{AI.NAME}/qwen1_5-4b-chat-q4_k_m.gguf")
            try:  
                self.llm = Llama(
                    model_path=self.PATH,
                    n_ctx=4096,  # 上下文长度
                    n_threads=3,
                    seed=int(time.time()),
                    f16_kv=True,  # 使用半精度加速
                    verbose=False,
                )
            except Exception as e:
                self.llm=None
                print(f"[ERROR]AI Error: {e}")
        def init_char_prompt(self, system_prompt):
            self.llm.cache_prompt(self.llm.tokenize(system_prompt.encode('utf-8')))
        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            history: role, content
            cache=True -> cache prompt
            """
            output = self.llm.create_chat_completion(
                messages=[
                    {"role": "system","content": system_prompt},
                    *history
                ],
                max_tokens=1024,
                temperature=0.8,
                stop=["<|im_end|>"],
                repeat_penalty=1.1
            )
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: main.dist\AI\TEMPLATES\llama_cpp\AI.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\AI\TEMPLATES\llama_cpp\AI.py
###########################################################################

try:
    from llama_cpp import Llama
except ImportError:
    print("ERROR: llama_cpp doesn't exist")
    
else:
    import time
    import os.path

    class AI:
        NAME="llama_cpp"
        PATH=""
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'llama_cpp')
            AI.PATH = inf_dict.get('PATH', f"AI/{AI.NAME}/qwen1_5-4b-chat-q4_k_m.gguf")
            try:  
                self.llm = Llama(
                    model_path=self.PATH,
                    n_ctx=4096,  # 上下文长度
                    n_threads=3,
                    seed=int(time.time()),
                    f16_kv=True,  # 使用半精度加速
                    verbose=False,
                )
            except Exception as e:
                self.llm=None
                print(f"[ERROR]AI Error: {e}")
        def init_char_prompt(self, system_prompt):
            self.llm.cache_prompt(self.llm.tokenize(system_prompt.encode('utf-8')))
        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            history: role, content
            cache=True -> cache prompt
            """
            output = self.llm.create_chat_completion(
                messages=[
                    {"role": "system","content": system_prompt},
                    *history
                ],
                max_tokens=1024,
                temperature=0.8,
                stop=["<|im_end|>"],
                repeat_penalty=1.1
            )
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: main.dist\AI\TEMPLATES\pollinations\AI.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\AI\TEMPLATES\pollinations\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='pollinations'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        BASE_URL = "https://text.pollinations.ai/openai"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()

        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'pollinations')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            try:  
                self.client = OpenAI(api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            model="openai",
            messages=[
                {"role": "system","content": system_prompt},
                *history]
            )
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: main.dist\AI\TEMPLATES\qwen\AI.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\AI\TEMPLATES\qwen\AI.py
###########################################################################

try:
    from openai import OpenAI
except ImportError:
    print("ERROR: openai doesn't exist")
else:
    import time
    import os.path
    class AI:
        NAME='qwen'
        PUNCTUATIONS="!#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~！￥……（）【】、’‘”“；：。，？"

        API_KEY = ''
        MODEL = "qwen-plus"
        BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1"

        prompt_path = os.path.join(os.path.dirname(__file__), 'prompt.json')
        with open(prompt_path, 'r', encoding='utf-8') as pj:
            PROMPT = pj.read()
        def __init__(self, inf_dict: dict):
            AI.NAME = inf_dict.get('NAME', 'qwen')
            AI.API_KEY = inf_dict.get('API_KEY', '')
            AI.MODEL = inf_dict.get('MODEL', "qwen-plus")
            try:  
                self.client = OpenAI(
                # 若没有配置环境变量，请用百炼API Key将下行替换为：api_key="sk-xxx",
                api_key=AI.API_KEY,
                base_url=AI.BASE_URL)
            except Exception as e:
                self.client=None
                print(f"[ERROR]AI Error: {e}")

        @staticmethod
        def generate_AI_prompt(name, introduction, hobby, emotions, example=""):
            prompt = AI.PROMPT.format(name=name, introduction=introduction, hobby=hobby, emotions=emotions, example=example)
            return prompt
        
        def _handle_answer(self, con0):
            chars=list(con0)
            if all(char in AI.PUNCTUATIONS for char in chars):
                return [con0]
            while chars and chars[0] in AI.PUNCTUATIONS:
                chars.pop(0)
            result=[]
            current_word=""

            for char in chars:
                if char in AI.PUNCTUATIONS:
                    current_word += char
                else:
                    if current_word:
                        result.append(current_word)
                    current_word=char
            if current_word:
                result.append(current_word)
            
            if len(result) < 8:
                return [''.join(result)]
            elif 8 <= len(result) < 16:
                part_len = len(result) // 2
                return [''.join(result[ :part_len]), ''.join(result[part_len: ])]
            else:
                con_len= len(result)
                part_len = con_len // 3
                return [''.join(result[ :part_len]),
                        ''.join(result[part_len: con_len-part_len]),
                        ''.join(result[con_len-part_len: ])]

        def get_answer_from_AI(self, history, system_prompt):
            """
            histroy: role, content
            """
            completion = self.client.chat.completions.create(
            # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
            model=AI.MODEL,
            messages=[
                {"role": "system","content": system_prompt},
                *history],
            # Qwen3模型通过enable_thinking参数控制思考过程（开源版默认True，商业版默认False）
            # 使用Qwen3开源版模型时，若未启用流式输出，请将下行取消注释，否则会报错
            extra_body={"enable_thinking": False})
            output=completion.model_dump()
            total_tokens=output['usage']["total_tokens"]
            if output['choices']:
                choice=output["choices"][0]
                
                if 'message' in choice and 'content' in choice["message"]:
                    reply0=choice["message"]["content"]
                    print(f"[DEBUG]Reply: {reply0}")
                    try:
                        reply=reply0.split('#')
                        if reply0.startswith('#'):
                            emotion, content = reply[1], reply[2]
                        else:
                            content, emotion=reply[0], reply[1]
                        content_list=self._handle_answer(content)
                    except Exception:
                        content_list, emotion, total_tokens=self.get_answer_from_AI(history, system_prompt)
            return content_list, emotion, total_tokens

###########################################################################
# File: main.dist\audios\sound.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\audios\sound.py
###########################################################################

from pygame import mixer, sndarray
from functools import lru_cache

mixer.init()

def _create_silent_sound(duration_ms=1000):
    """
    纯代码创建一个无声音频的 Sound 对象。

    Args:
        duration_ms (int): 静音的时长，单位为毫秒。默认为 1000ms (1秒)。

    Returns:
        pygame.mixer.Sound: 一个代表静音的 Sound 对象。
    """
    import numpy as np
    # 1. 获取当前混音器的设置
    # 这些设置必须与 pygame.mixer.init() 时的设置一致。
    # 如果你没有显式初始化，pygame会使用默认设置。
    freq, size, channels = mixer.get_init()
    # `size` 是位深度，如 -16 表示 16 位有符号整数。

    # 2. 计算需要多少个样本点
    # 采样率 (freq) 表示每秒的样本数。
    # duration_ms / 1000.0 将毫秒转换为秒。
    num_samples = int((duration_ms / 1000.0) * freq)

    # 3. 根据声道数创建静音数组
    if channels == 1:
        # 单声道: 创建一个一维数组
        silent_array = np.zeros(num_samples, dtype=np.int16)
    else:
        # 立体声: 创建一个二维数组，形状为 (num_samples, channels)
        silent_array = np.zeros((num_samples, channels), dtype=np.int16)
        # 注意：对于立体声，我们也可以用 `np.zeros((num_samples, 2))`

    # 4. 将 NumPy 数组转换为 Pygame Sound 对象
    silent_sound = sndarray.make_sound(silent_array)

    return silent_sound

def play_background_music(path):
    mixer.music.stop()
    mixer.music.load(path)
    mixer.music.play(-1)

@lru_cache(maxsize=128)
def load_audio_file(path):
    try:
        print(f"[DEBUG]Sound '{path}' loaded")
        sound = mixer.Sound(path)
    except Exception as e:
        print(f"[ERROR]Sound '{path}' Loading Failed: {e}")
        sound = _create_silent_sound()
    return sound

###########################################################################
# File: main.dist\characters\CH0069\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\CH0069\getCharacter.py
###########################################################################

import re
from json import loads
import ast
import os
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    regionRRIstart={'CH0069': (600, 136), 'CH00691': (590, 93), 'CH00692': (310, 30)}
    sources={}
    for a in range(6, len(content) - 6, 7):
        partname=content[a][:-1]
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))

        if partname == 'Halo':
            partname=partname.lower()
            region.paste(Image.new("RGBA", (145, 58)), (0, 0))
        elif partname in regionRRIstart.keys():
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name.upper())
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{partname}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, regionRRIstart[partname][0], regionRRIstart[partname][1])
                region.save(path)
        sources[partname]=region
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    image0=Image.new("RGBA", (1013, 1490))
    image0.paste(sources['CH0069'], (0, 0))
    image0.paste(sources['CH00691'], (0, 642), sources['CH00691'])
    image0.paste(sources['CH00692'], (282, 1001), sources['CH00692'])
    pictures={}
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            emotionpos=settings.get(key, settings['emotions'])
            image.paste(sources[key], (emotionpos[0]-sources[key].width, emotionpos[1]-sources[key].height), sources[key])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    pictures['halo']=sources['halo']
    
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('CH0069')

###########################################################################
# File: main.dist\characters\CH0069\removeRemoteImage.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\CH0069\removeRemoteImage.py
###########################################################################

from PIL import Image
import numpy as np
from scipy import ndimage

def removeRemoteImage(image0, startx, starty, minAlpha=5):
    if image0.mode != 'RGBA':
        image0 = image0.convert('RGBA')
    
    alpha = np.array(image0)[:, :, 3]
    mask = alpha >= minAlpha
    
    # 标记所有连通区域
    labels, num_labels = ndimage.label(mask)
    target_label = labels[starty, startx]
    
    if target_label == 0:  # 起点 Alpha 不足
        return Image.new('RGBA', image0.size, (0,0,0,0))
    
    # 提取该区域
    region_mask = (labels == target_label)
    new_array = np.zeros((*image0.size[::-1], 4), dtype=np.uint8)
    new_array[region_mask] = np.array(image0)[region_mask]
    
    return Image.fromarray(new_array, 'RGBA')

if __name__  == '__main__':
    from PIL import Image
    import time
    i = Image.open('CH0069_spr.png')
    t = time.perf_counter()
    r = removeRemoteImage(i, 512, 1024)
    t1 = time.perf_counter()
    print(t1-t)
    r.save('r.png')

###########################################################################
# File: main.dist\characters\h\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\h\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: main.dist\characters\hoshino\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\hoshino\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast

def getCharacter(name):
    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[2][(content[2].find(':') + 2) :])

    sources={}
    for a in range(6, len(content) - 6, 7):
        xy = ast.literal_eval(content[a + 2][(content[a + 2].find(':') + 2) :])
        size = ast.literal_eval(content[a + 3][(content[a + 3].find(':') + 2) :])
        x, y, w, h = xy[0], xy[1], size[0], size[1]
        if content[a + 1][content[a + 1].find(':') + 2 :] == 'true\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '180\n':
            region = orimage.crop((x, y, x + w, y + h))
            region = region.rotate(-180, expand=True)
        elif content[a + 1][content[a + 1].find(':') + 2 :] == '270\n':
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-270, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        sources[content[a][:-1]]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    emotionpos=settings['emotions']
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose':
            image=image0.copy()
            image.paste(sources[key], (emotionpos[0], emotionpos[1]-sources[key].size[1]), sources[key])
            image.paste(sources['object_fronthair'], settings['object_fronthair'], sources['object_fronthair'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    halo=sources['halo 1']
    halo.paste(sources['halo 2'], settings['halo 2'], sources['halo 2'])
    halo.paste(sources['halo 3'], settings['halo 3'], sources['halo 3'])
    pictures['halo']=halo
    return pictures, settings

###########################################################################
# File: main.dist\characters\momoi\getCharacter.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\momoi\getCharacter.py
###########################################################################

import re
from PIL import Image
from json import loads
import ast
import os.path
from removeRemoteImage import *

def getCharacter(name):

    with open(f"characters/{name}/{name}_spr.atlas.txt", 'r') as txt:
        content = txt.readlines()
    orimage = Image.open(f"characters/{name}/{name}_spr.png").convert("RGBA")
    orisize = ast.literal_eval(content[1][(content[1].find(':') + 1) :])

    sources={}
    nameindex=[]
    for a in range(4, len(content)):
        if not any(content[a].startswith(x) for x in ['bounds', 'offsets', 'rotate']):
            nameindex.append(a)
    nameindex.append(len(content))
    for b in range(0, len(nameindex)-1):
        rotate=0
        for c in range(nameindex[b]+1, nameindex[b+1]):
            if content[c].startswith('bounds'):
                x, y, w, h = ast.literal_eval(content[c][(content[c].find(':') + 1) :])
            elif content[c].startswith('rotate'):
                rotate = int(content[c][(content[c].find(':') + 1) :])
        if rotate==90:
            region = orimage.crop((x, y, x + h, y + w))
            region = region.rotate(-90, expand=True)
        else:
            region = orimage.crop((x, y, x + w, y + h))
        if content[nameindex[b]].replace('\n', '') == name:
            tempfolderPath=os.path.join(os.getenv('TEMP'), 'DesktopLobby', name)
            os.makedirs(tempfolderPath, exist_ok=True)
            path=os.path.join(tempfolderPath, f"{name}.png")
            if os.path.exists(path):
                region=Image.open(path)
            else:
                region=removeRemoteImage(region, 25, 289)
                region.save(path)
        sources[content[nameindex[b]].replace('\n', '')]=region
    
    with open(f"characters/{name}/settings.json", 'r') as txt:
        content = ''.join([s for s in txt.readlines() if not s.startswith('#')])
        settings=loads(content)

    pictures={}
    image0=sources[name]
    targetalpha=image0.split()[-1]
    for key in sources.keys():
        if re.match(r'^\d\d', key) or key == 'eyeclose' or key == 'default':
            image=image0.copy()
            image.paste(sources[key], settings[key[:2]], sources[key])
            image.paste(sources['Hair_Cover_01'], settings["Hair_Cover_01"], sources['Hair_Cover_01'])
            image=Image.merge('RGBA', image.split()[:3] + tuple([targetalpha]))
            pictures[key]=image
    
    #for k, i in sources.items():
    #    i.save(f"{k}.png")
    pictures['halo']=sources['halo']
    return pictures, settings

if __name__=='__main__':
    p, s =getCharacter('momoi')

###########################################################################
# File: main.dist\characters\momoi\removeRemoteImage.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\characters\momoi\removeRemoteImage.py
###########################################################################

from PIL import Image
import numpy as np
from scipy import ndimage

def removeRemoteImage(image0, startx, starty, minAlpha=5):
    if image0.mode != 'RGBA':
        image0 = image0.convert('RGBA')
    
    alpha = np.array(image0)[:, :, 3]
    mask = alpha >= minAlpha
    
    # 标记所有连通区域
    labels, num_labels = ndimage.label(mask)
    target_label = labels[starty, startx]
    
    if target_label == 0:  # 起点 Alpha 不足
        return Image.new('RGBA', image0.size, (0,0,0,0))
    
    # 提取该区域
    region_mask = (labels == target_label)
    new_array = np.zeros((*image0.size[::-1], 4), dtype=np.uint8)
    new_array[region_mask] = np.array(image0)[region_mask]
    
    return Image.fromarray(new_array, 'RGBA')

if __name__  == '__main__':
    from PIL import Image
    import time
    i = Image.open('CH0069_spr.png')
    t = time.perf_counter()
    r = removeRemoteImage(i, 512, 1024)
    t1 = time.perf_counter()
    print(t1-t)
    r.save('r.png')

###########################################################################
# File: main.dist\database\database.py
# Path: D:\Projects\DesktopLobby2.0\main.dist\database\database.py
###########################################################################

from peewee import (SqliteDatabase, Model,
                    CharField, IntegerField, BooleanField, FloatField)
from getResources import GLOBAL_CONFIG
from functions.json_ import load_json
from resource_loader import getCharacterIntroduction
from loadingWindow.loading import LoadingWindowControl
import time

db = SqliteDatabase('database/database.db')
db.connect()


class Character(Model):
    code_name = CharField()
    name = CharField()
    introduction = CharField()
    emotion = CharField()
    birthday = IntegerField()
    hobby = CharField()

    class Meta:
        database = db


class Conversation(Model):
    name = CharField()
    role = CharField()
    content = CharField()
    emotion = CharField()
    beginning = BooleanField()
    date = CharField()
    dateF = FloatField()
    total_tokens = IntegerField()

    class Meta:
        database = db


class AI_Saves(Model):
    name = CharField()
    inf_dict = CharField()
    config_dict = CharField()
    dateF = FloatField()

    class Meta:
        database = db


class AI_Templates(Model):
    name = CharField()
    config_dict = CharField()

    class Meta:
        database = db


# print(Character.select().where(Character.name=='Mika').get())
def db_reload_character_intro(code_name):
    introduction, hobby, emotion = getCharacterIntroduction(code_name)
    name = GLOBAL_CONFIG.CONTRAST.get(code_name, code_name)
    Character.create(code_name=code_name, name=name, introduction=introduction, emotion=emotion, hobby=hobby,
                     birthday='01-01')


def db_load_character_intro(force_reload=False):
    if force_reload:
        Character.delete().execute()
    db_character_code_names = [x.code_name for x in Character.select()]
    for code_name in GLOBAL_CONFIG.CODE_NAMES:
        if code_name not in db_character_code_names:
            LoadingWindowControl.messageLoadingWindow(f"[database] character:{code_name}")
            db_reload_character_intro(code_name)


def db_get_character_intro(code_name=None, name=None):
    """
    return: introduction, hobby, emotions
    """
    if code_name:
        cha = Character.select().where(Character.code_name == code_name).first()

    elif name:
        cha = Character.select().where(Character.name == name).first()
    return {"introduction": cha.introduction, "hobby": cha.hobby, "emotions": cha.emotion}


def db_reload_AI_template(ai_name):
    config = load_json(f"AI/TEMPLATES/{ai_name}/config.json", to_string=True)
    AI_Templates.create(name=ai_name, config_dict=config)


def db_load_AI_templates(force_reload=False):
    if force_reload:
        AI_Templates.delete().execute()
    db_ai_names = [x.name for x in AI_Templates.select()]
    for ai_name in GLOBAL_CONFIG.AI_TEMPLATES:
        if ai_name not in db_ai_names:
            LoadingWindowControl.messageLoadingWindow(f"[database] AI:{ai_name}")
            db_reload_AI_template(ai_name)


def db_get_AI_templates_config(name: str) -> dict:
    from json import loads
    line_config = AI_Templates.select().where(AI_Templates.name == name).first()
    return loads(line_config.config_dict)


def db_create_AI_save(name: str, parameters, config_dict):
    from json import dumps
    from functions.cipher import encrypt_api_key

    # 加密
    parameters_copy = parameters.copy()
    for key, value in parameters.items():
        if type(config_dict['parameters'][key]) == dict:
            if config_dict['parameters'][key]['secret']:
                parameters_copy[key] = encrypt_api_key(value, parameters['NAME'])

    AI_Saves.create(name=name, inf_dict=dumps(parameters_copy), config_dict=dumps(config_dict), dateF=time.time())


def db_modify_AI_save(ori_name: str, new_name: str, parameters, config_dict):
    db_delete_AI_save(ori_name)
    db_create_AI_save(new_name, parameters, config_dict)

def db_delete_AI_save(name: str):
    AI_Saves.delete().where(AI_Saves.name == name).execute()

def db_get_AI_save_config(name: str) -> (dict, dict):
    from json import loads
    from functions.cipher import decrypt_api_key

    line_config = AI_Saves.select().where(AI_Saves.name == name).first()
    parameters = loads(line_config.inf_dict)
    config_dict = loads(line_config.config_dict)

    # 解密
    parameters_copy = parameters.copy()
    for key, value in parameters.items():
        if type(config_dict['parameters'][key]) == dict:
            if config_dict['parameters'][key]['secret']:
                parameters_copy[key] = decrypt_api_key(value, parameters['NAME'])

    return parameters_copy, config_dict


def db_add_conversation_record(**kwargs):
    """
    name, role, content, emotion, beginning, dateF, total_tokens
    """
    date = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(kwargs['dateF']))
    Conversation.create(**kwargs, date=date)


def db_get_conversation_record(character):
    records = []
    query = Conversation.select().where(Conversation.name == character).order_by(Conversation.dateF.desc())
    for record in query:
        if record.beginning:
            break
        content = f"{record.content}#{record.emotion}#" if record.emotion != '0' else record.content
        records.append({'role': record.role, 'content': content})

    records.reverse()
    return records


def db_delete_conversation_record(day, character='all'):
    Ddate = time.time() - day * 24 * 60 * 60
    if character == 'all':
        Conversation.delete().where(Conversation.dateF < Ddate).execute()
    else:
        Conversation.delete().where(Conversation.name == character, Conversation.dateF < Ddate).execute()


if not db.get_tables():
    # 创建表
    db.create_tables([Character, Conversation, AI_Saves, AI_Templates])
    db_load_character_intro()
    db_load_AI_templates()

if __name__ == "__main__":
    db_load_character_intro()
    db_load_AI_templates(True)
    db_load_AI_saves(True)
    db_delete_conversation_record(0)
    # for a in range(100):
    #    db_add_conversation_record(name='mika', role='assistant', content=f"就开始多少{a}", emotion='Happy', beginning=False, dateF=time.time(), total_tokens=123)
    r = db_get_conversation_record('mika')
    print(r)

###########################################################################
# File: windows\AI_settings_operate_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\AI_settings_operate_window.py
###########################################################################

from PySide6.QtCore import Qt
from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtWidgets import (QLabel,
                             QHBoxLayout,
                             QVBoxLayout,
                             QLineEdit,
                             QPushButton,
                             QCheckBox)
from typing import Literal

from getResources import GLOBAL_CONFIG
from functions.counter import counter
from database.database import db_get_AI_templates_config, db_create_AI_save, db_modify_AI_save, db_get_AI_save_config
from signal_bus import signal_bus

class OperateAIWindow(QDialog):
    counter = counter(len(GLOBAL_CONFIG.AI_TEMPLATES))

    def __init__(self, mode: Literal['create', 'modify'], modified_AI_name=''):
        super().__init__()
        self.mode = mode
        self.modified_AI_name = modified_AI_name

        if self.modified_AI_name:
            self.introduction = ""
            self.parameters, self.config = db_get_AI_save_config(self.modified_AI_name)

        else:
            self.config = db_get_AI_templates_config(GLOBAL_CONFIG.AI_TEMPLATES[OperateAIWindow.counter('get')])
            self.introduction = self.config.get('introduction', "")
            self.parameters = self.config['parameters']
        if self.mode == 'create':
            self.parameters['NAME'] = self.modified_AI_name

        self.setWindowTitle(self.mode + ' AI')
        self.setMinimumWidth(300)

        self.layout = QVBoxLayout()

        self.current_AI_label = QLabel()
        self.current_AI_label.setText(modified_AI_name if modified_AI_name else GLOBAL_CONFIG.AI_TEMPLATES[OperateAIWindow.counter('get')])
        self.current_AI_label.setAlignment(Qt.AlignCenter)
        self.layout.addWidget(self.current_AI_label)

        self.introduction_label = QLabel()
        self.introduction_label.setText(self.introduction)
        self.introduction_label.setAlignment(Qt.AlignCenter)
        self.layout.addWidget(self.introduction_label)

        self.boxes_layout = QVBoxLayout()
        self.boxes_init()

        button_layout = QHBoxLayout()

        if self.mode == 'create':
            last_button = QPushButton()
            last_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Last One", ''))
            last_button.clicked.connect(lambda: self.switch('last'))
            button_layout.addWidget(last_button)

        confirm_button = QPushButton()
        confirm_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Confirm", ''))
        confirm_button.setFixedWidth(120)
        confirm_button.clicked.connect(lambda: self.confirm())
        button_layout.addWidget(confirm_button)

        if self.mode == 'create':
            next_button = QPushButton()
            next_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Next One", ''))
            next_button.clicked.connect(lambda: self.switch('next'))
            button_layout.addWidget(next_button)

        self.layout.addLayout(button_layout)

        self.setLayout(self.layout)

    def boxes_init(self):
        # {key: [QLabel, QLineEdit]}
        self.boxes = {}

        for key, value in self.parameters.items():
            para_layout = QHBoxLayout()
            self.boxes[key] = []

            text_box = QLabel()
            text_box.setAlignment(Qt.AlignmentFlag.AlignCenter)  # 文本靠右
            text_box.setText(key)
            para_layout.addWidget(text_box)
            self.boxes[key].append(text_box)

            edit_box = QLineEdit()
            edit_box.setFixedWidth(220)
            if type(value) == str:
                edit_box.setText(value)
            para_layout.addWidget(edit_box)
            self.boxes[key].append(edit_box)

            self.boxes_layout.addLayout(para_layout)
        self.layout.addLayout(self.boxes_layout)

    def switch(self, type: Literal['last', 'next']):
        OperateAIWindow.counter(type)
        self.config = db_get_AI_templates_config(GLOBAL_CONFIG.AI_TEMPLATES[OperateAIWindow.counter('get')])
        self.introduction = self.config.get('introduction', "")
        self.parameters = self.config['parameters']
        self.parameters['NAME'] = ""

        # 修改text
        self.current_AI_label.setText(GLOBAL_CONFIG.AI_TEMPLATES[OperateAIWindow.counter('get')])
        self.introduction_label.setText(self.introduction)

        # 删除之前的self.boxes()
        for text_box, edit_box in self.boxes.values():
            text_box.deleteLater()
            edit_box.deleteLater()

        self.boxes_init()

    def confirm(self):
        para_dict = {text_box.text(): edit_box.text() for text_box, edit_box in self.boxes.values()}
        try:
            if self.mode == 'create':
                # 复制文件
                import shutil
                shutil.copytree(f"AI/TEMPLATES/{GLOBAL_CONFIG.AI_TEMPLATES[OperateAIWindow.counter('get')]}",
                                f"AI/{para_dict['NAME']}")

                db_create_AI_save(para_dict['NAME'], para_dict, self.config)
                signal_bus.AI_settings_signal.emit('', para_dict['NAME'], para_dict)
            elif self.mode == 'modify' and self.modified_AI_name:
                db_modify_AI_save(self.modified_AI_name, para_dict['NAME'], para_dict, self.config)
                if self.modified_AI_name != para_dict['NAME']:
                    # 重命名文件
                    import os
                    os.rename(f"AI/{self.modified_AI_name}", f"AI/{para_dict['NAME']}")
                signal_bus.AI_settings_signal.emit(self.modified_AI_name, para_dict['NAME'], para_dict)

        except FileExistsError:
            from PySide6.QtWidgets import QMessageBox
            QMessageBox.critical(None, "错误", "重复名称")
        else:
            self.close()


class DeleteAIWindow(QDialog):
    def __init__(self, ai_name):
        super().__init__()
        self.ai_name = ai_name

        layout = QVBoxLayout()

        text_label = QLabel()
        text_label.setText("你确定要删除吗?")
        layout.addWidget(text_label)

        self.delete_file_check = QCheckBox("同时删除文件", self)
        self.delete_file_check.setChecked(False)
        layout.addWidget(self.delete_file_check)

        button_layout = QHBoxLayout()

        button_layout.addStretch()

        cancel_button = QPushButton()
        cancel_button.setText("取消")
        cancel_button.setFixedWidth(120)
        button_layout.addWidget(cancel_button)

        confirm_button = QPushButton()
        confirm_button.setText("确认")
        confirm_button.setFixedWidth(120)
        button_layout.addWidget(confirm_button)

        button_layout.addStretch()

        layout.addLayout(button_layout)

        self.setLayout(layout)

        cancel_button.clicked.connect(lambda: self.close())
        confirm_button.clicked.connect(self.delete_AI)

    def delete_AI(self):
        from database.database import db_delete_AI_save
        db_delete_AI_save(self.ai_name)
        signal_bus.AI_settings_signal.emit(self.ai_name, "", {})

        if self.delete_file_check.checkState():
            import shutil
            import os
            if os.path.exists(f"AI/{self.ai_name}"):
                shutil.rmtree(f"AI/{self.ai_name}")

        self.close()

###########################################################################
# File: windows\AI_settings_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\AI_settings_window.py
###########################################################################

from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtWidgets import (QLabel,
                             QVBoxLayout,
                             QCheckBox,
                             QHBoxLayout,
                             QTableWidget,
                             QTableWidgetItem,
                             QAbstractItemView,
                             QFrame,
                             QSpinBox,
                             QPushButton)
from PySide6.QtGui import QColor
from communicator import Communicator

from getResources import GLOBAL_CONFIG
from database.database import db_load_character_intro, db_delete_conversation_record, db_get_AI_save_config
from signal_bus import signal_bus


class AISettingsWindow(QDialog):
    def __init__(self, CNAME: list):
        super().__init__()

        self.key_table_elements = []
        for save_name in GLOBAL_CONFIG.AI_SAVES:
            try:
                config, _ = db_get_AI_save_config(save_name)
            except Exception as e:
                print(f"[ERROR]AI Save Loading Error: {e}")
            else:
                from json import dumps
                self.key_table_elements.append({save_name: dumps(config)})
        self.setWindowTitle(GLOBAL_CONFIG.LANGUAGE.get("AI settings", ""))
        self.setFixedWidth(400)

        layout = QVBoxLayout()

        l1 = QHBoxLayout()

        l1.addStretch()

        start_button = QPushButton()
        start_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Start AI", ""))
        l1.addWidget(start_button)

        key_add_button = QPushButton()
        key_add_button.setText(GLOBAL_CONFIG.LANGUAGE.get('Add', ""))
        l1.addWidget(key_add_button)

        key_edit_button = QPushButton()
        key_edit_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Edit", ""))
        l1.addWidget(key_edit_button)

        key_delete_button = QPushButton()
        key_delete_button.setText(GLOBAL_CONFIG.LANGUAGE.get('Delete', ""))
        l1.addWidget(key_delete_button)

        layout.addLayout(l1)

        l2 = QHBoxLayout()
        self.key_table = QTableWidget(self)
        self.key_table.setRowCount(100)
        self.key_table.setColumnCount(2)
        self.key_table.setVerticalScrollMode(QAbstractItemView.ScrollPerPixel)
        self.key_table.setHorizontalScrollMode(QAbstractItemView.ScrollPerPixel)
        self.key_table.setHorizontalHeaderLabels([GLOBAL_CONFIG.LANGUAGE.get("Name", ""), GLOBAL_CONFIG.LANGUAGE.get("Information", "")])
        for x in [(0, 60), (1, 340)]:
            self.key_table.setColumnWidth(*x)
        for x in range(0, 100):
            self.key_table.setRowHeight(x, 10)

        self._update_key_table()

        self.key_table.setEditTriggers(QTableWidget.NoEditTriggers)
        self.key_table.setSelectionBehavior(QTableWidget.SelectRows)
        self.key_table.setSelectionMode(QTableWidget.SingleSelection)
        l2.addWidget(self.key_table)

        l21 = QVBoxLayout()

        l21.addSpacing(32)

        message1 = QLabel()
        message1.setText(GLOBAL_CONFIG.LANGUAGE.get("<-Using", ""))
        l21.addWidget(message1)

        l21.addStretch()

        key_change_button = QPushButton()
        key_change_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Change", ""))
        l21.addWidget(key_change_button)

        l21.addStretch()

        l2.addLayout(l21)
        layout.addLayout(l2)

        line = QFrame()
        line.setFrameShape(QFrame.HLine)
        line.setFrameShadow(QFrame.Sunken)
        line.setStyleSheet("color: gray;")
        line.setLineWidth(1)
        layout.addWidget(line)

        message2 = QLabel()
        message2.setText(GLOBAL_CONFIG.LANGUAGE.get("Current Character Settings", ""))
        layout.addWidget(message2)

        l3 = QHBoxLayout()

        #OTDcheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Offer to Dialogue", ""), self)
        #OTDcheck.setChecked(False)
        #l3.addWidget(OTDcheck)

        SDRcheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Save Dialog Record", ""), self)
        SDRcheck.setChecked(True)
        l3.addWidget(SDRcheck)

        layout.addLayout(l3)

        l5 = QHBoxLayout()

        message5 = QLabel()
        message5.setText(GLOBAL_CONFIG.LANGUAGE.get("Clean Dialog Record Before", ""))
        l5.addWidget(message5)

        CDRint = QSpinBox()
        CDRint.setMinimum(0)
        CDRint.setValue(30)
        l5.addWidget(CDRint)

        message6 = QLabel()
        message6.setText(GLOBAL_CONFIG.LANGUAGE.get("Days (0->clear)", ""))
        l5.addWidget(message6)

        CDR_button = QPushButton()
        CDR_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Confirm", ""))
        l5.addWidget(CDR_button)

        layout.addLayout(l5)

        l6 = QHBoxLayout()

        RCI_button = QPushButton()
        RCI_button.setText(GLOBAL_CONFIG.LANGUAGE.get("Refresh Characters", ""))
        l6.addWidget(RCI_button)

        layout.addLayout(l6)

        self.setLayout(layout)

        start_button.pressed.connect(lambda: self.start_AI())
        key_add_button.clicked.connect(lambda: self.create_AI())
        key_edit_button.clicked.connect(lambda: self.modify_AI())
        key_delete_button.clicked.connect(lambda: self.delete_AI())
        key_change_button.clicked.connect(lambda: self.change_AI())

        SDRcheck.stateChanged.connect(lambda: signal_bus.settings_signal.emit("AI_save_state", SDRcheck.checkState()))
        CDR_button.pressed.connect(lambda: db_delete_conversation_record(CDRint.value(), character=CNAME))
        RCI_button.pressed.connect(lambda: db_load_character_intro(force_reload=True))

        signal_bus.AI_settings_signal.connect(self.modify_key_table)

    def modify_key_table(self, ori_name, new_name, inf_dict):
        if ori_name:
            if new_name and inf_dict:
                # 修改
                for i, row in enumerate(self.key_table_elements):
                    if ori_name in row.keys():
                        self.key_table_elements[i] = {new_name: inf_dict}
                        for j, cell in enumerate((new_name, inf_dict)):
                            self.key_table.setItem(i, j, QTableWidgetItem(str(cell)))
            else:
                # 删除
                key_table_elements_keys = tuple(element.keys() for element in self.key_table_elements)
                for i, element in enumerate(key_table_elements_keys):
                    if ori_name in element:
                        del self.key_table_elements[i]
                self._update_key_table()

        else:
            # 新建
            self.key_table_elements.append({new_name: inf_dict})
            for j, cell in enumerate((new_name, inf_dict)):
                self.key_table.setItem(len(self.key_table_elements) - 1, j, QTableWidgetItem(str(cell)))

        self.key_table.horizontalScrollBar().setValue(0)

    def _update_key_table(self):
        # 填充元素
        self.key_table.clearContents()
        for i, row in enumerate(self.key_table_elements):
            row = next(iter(row.items()))
            for j, cell in enumerate(row):
                self.key_table.setItem(i, j, QTableWidgetItem(str(cell)))

        # 设置第一行颜色为灰色
        gray_color = QColor(211, 211, 211)
        for col in range(self.key_table.columnCount()):
            item = self.key_table.item(0, col)
            if not item:
                item = QTableWidgetItem()
                self.key_table.setItem(0, col, item)
            item.setBackground(gray_color)

        # 水平进度条左移
        self.key_table.horizontalScrollBar().setValue(0)

        self.default_start_AI()
    def default_start_AI(self):
        if GLOBAL_CONFIG.PREFERENCES["defaultInitAI"] and GLOBAL_CONFIG.PREFERENCES["defaultAI"] in GLOBAL_CONFIG.AI_SAVES:
            from json import loads
            for element in self.key_table_elements:
                key, value = list(element.items())[0]
                if key == GLOBAL_CONFIG.PREFERENCES["defaultAI"]:
                    signal_bus.AI_start_signal.emit(key, loads(value) if type(value) == str else value)

    def start_AI(self):
        if self.key_table_elements:
            from json import loads
            line0 = list(self.key_table_elements[0].items())[0]
            signal_bus.AI_start_signal.emit(line0[0], loads(line0[1]) if type(line0[1]) == str else line0[1])

    def create_AI(self):
        from windows.AI_settings_operate_window import OperateAIWindow
        create_AI_window = OperateAIWindow('create')
        create_AI_window.show()

    def modify_AI(self):
        if (self.key_table.currentRow() != -1 and
                self.key_table_elements and
                self.key_table.currentRow() < len(self.key_table_elements)):
            from windows.AI_settings_operate_window import OperateAIWindow
            modified_AI_name = next(iter(self.key_table_elements[self.key_table.currentRow()].keys()))
            modify_AI_window = OperateAIWindow('modify', modified_AI_name=modified_AI_name)
            modify_AI_window.show()

    def delete_AI(self):
        if (self.key_table.currentRow() != -1 and
                self.key_table_elements and
                self.key_table.currentRow() < len(self.key_table_elements)):
            from windows.AI_settings_operate_window import DeleteAIWindow
            deleted_AI_name = next(iter(self.key_table_elements[self.key_table.currentRow()].keys()))
            delete_AI_window = DeleteAIWindow(deleted_AI_name)
            delete_AI_window.show()

    def change_AI(self):
        if (self.key_table.currentRow() != -1 and
                self.key_table_elements and
                self.key_table.currentRow() < len(self.key_table_elements)):
            self.key_table_elements.insert(0, self.key_table_elements.pop(self.key_table.currentRow()))

            self._update_key_table()

###########################################################################
# File: windows\UI.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI.py
###########################################################################

from PySide6.QtWidgets import QVBoxLayout, QWidget, QLabel, QApplication, QMessageBox, QLineEdit, QHBoxLayout, QPushButton, QDialog
from PySide6.QtCore import Qt, QTimer
import functions.ImageQt
from getResources import PREFERENCES, setBirthdayDate
from animation_player import animation_player
from functions.generateUIImages import generateImage
from attachedWindows import Communicator
import sys

import time
import winreg
import subprocess
import threading













if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setQuitOnLastWindowClosed(True)
    c=UI_InputWindow_classic()
    c.show()
    sys.exit(app.exec_())

###########################################################################
# File: windows\UI_button_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_button_window.py
###########################################################################

from PySide6.QtWidgets import QVBoxLayout
from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtCore import Qt
from animation.animation_player import AnimationPlayer

import time
import threading

class UIButtonWindow(QDialog):
    def __init__(self, screenSize):
        super().__init__()
        self.layout=QVBoxLayout()
        # 设置无边框和透明背景
        self.setWindowModality(Qt.NonModal)
        self.setWindowFlags(Qt.FramelessWindowHint|Qt.ToolTip)
        self.setAttribute(Qt.WA_TranslucentBackground, True)

        self.buttonAnim=AnimationPlayer("UIAni_Button_Scale")
        self.canChange=True
        
        self.playable=False

    def frameUpdate(self):
        if hasattr(self, 'changeThread'):
            self.canChange=not self.changeThread.isAlive()

        if self.startt==0 and not self.playable:
            self.pos0 = (self.frameGeometry().topLeft().x(), self.frameGeometry().topLeft().y())
            self.centerpos0=[x+y//2 for x,y in zip(self.pos0, self.size0)]
        if self.order == 0:
            result, self.playable = self.buttonAnim.play_frame(time.time() - self.startt)
            if not self.playable:
                self.order += 1
                self.startt=time.time()
        if self.order == 1:
            result, self.playable = self.buttonAnim.play_frame(time.time() - self.startt, timeReverse=True)

        if self.playable: 
            size=tuple(x*y for x,y in zip(result['scale'], self.size0))
            currentPixmap=self.images[self.number].scaled(*size, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation)
            self.buttonLabel.setPixmap(currentPixmap)
            self.setGeometry(*[x-y//2 for x,y in zip(self.centerpos0, size)], *size)
            self.buttonLabel.setFixedSize(*size)
        else:
            self.buttonLabel.setPixmap(self.images[self.number])
            self.setGeometry(*self.pos0, *self.size0)
            self.buttonLabel.setFixedSize(*self.size0)
    
    def mousePressEvent(self, event):
        if self.canChange:
            self.change()
    #def whenClose(self):
    #    changeThread=threading.Thread(target=hideDesktopIcons, args=[0])
    #    changeThread.start()

###########################################################################
# File: windows\UI_change_character_mode_button_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_change_character_mode_button_window.py
###########################################################################

from PySide6.QtWidgets import QVBoxLayout, QLabel
from PySide6.QtCore import Qt, QTimer
import functions.ImageQt
from getResources import PREFERENCES
from functions.generateUIImages import generateImage

import time

from windows.UI_button_window import UIButtonWindow



class UI_ChangeCharacterModeButtonWindow(UIButtonWindow):
    def __init__(self, screenSize):
        images=generateImage("ChangeCharacterMode")
        self.images0=[i.resize(tuple(int(x*PREFERENCES["changeCharacterModeButtonProportion"]) for x in i.size)) for i in images]
        self.number=1
        self.border=PREFERENCES["changeCharacterModeButtonBorder"]

        super().__init__(screenSize)

        self.size0=self.images0[0].size
        self.images=[functions.ImageQt.toqpixmap(i) for i in self.images0]

        layout=QVBoxLayout()
        self.buttonLabel=QLabel(self)
        self.buttonLabel.setPixmap(self.images[self.number])
        self.buttonLabel.setGeometry(0, 0,  *self.size0)
        self.setGeometry(screenSize[0]-self.size0[0]-self.border[0], self.border[1], *self.size0)
        layout.addWidget(self.buttonLabel)

    def change(self):
        self.number= 0 if self.number == 1 else 1
        #changeThread=threading.Thread(target=hideDesktopIcons, args=[self.number])
        #self.canChange=False
        #changeThread.start()

        self.fixedupdate = QTimer(self)
        self.fixedupdate.timeout.connect(self.frameUpdate)
        self.startt=self.order=0
        self.fixedupdate.start(1000/30)

        self.buttonLabel.setPixmap(self.images[self.number])


###########################################################################
# File: windows\UI_dark_screen_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_dark_screen_window.py
###########################################################################

from PySide6.QtWidgets import QWidget
from PySide6.QtCore import Qt


class UI_DarkScreenWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowFlags(Qt.FramelessWindowHint|Qt.ToolTip)
        self.setStyleSheet("background-color: black;")
        size=self.screen().availableGeometry()
        self.setGeometry(0,0,size.width(),size.height())
        self.setWindowOpacity(0.6)

###########################################################################
# File: windows\UI_enter_birthday_date_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_enter_birthday_date_window.py
###########################################################################

from PySide6.QtWidgets import QVBoxLayout, QLabel, QLineEdit, QHBoxLayout, QPushButton
from PySide6.QtCore import Qt
from windows.UI_popup_window import UI_PopupWindow
from functions.birthday import setBirthdayDate

from windows.functions import verifyDate
from getResources import GLOBAL_CONFIG

class UI_EnterBirthdayDateWindow(UI_PopupWindow):
    def __init__(self, screenSize) -> None:
        super().__init__()
        self.setWindowTitle("Notice")
        self.setWindowFlag(Qt.WindowType.WindowMaximizeButtonHint, False)
        self.setFixedSize(400,210)
        center=self.screen().availableGeometry().center()
        self.move(center.x()-410/2, center.y()-210/2)
        #self.setStyleSheet("QMainWindow::titlebar {text-align: center;}")
        layout=QVBoxLayout()
        #layout.addStretch()

        h_layout1 = QHBoxLayout()
        h_layout1.addStretch()
        self.textbox=QLabel()
        self.textbox.setText(GLOBAL_CONFIG.LANGUAGE.get("Birthday", ""))
        self.textbox.setAlignment(Qt.AlignmentFlag.AlignCenter)  # 文本居中
        self.textbox.setFixedSize(210,20)           # 固定宽度200px
        self.textbox.setStyleSheet("background-color: #456397; padding: 1px; color: #ffffff;")
        h_layout1.addWidget(self.textbox)
        h_layout1.addStretch()

        h_layout2 = QHBoxLayout()
        h_layout2.addStretch()
        self.datebox = QLineEdit()
        self.datebox.setPlaceholderText("MMDDYYYY")
        self.datebox.setMaxLength(8)
        self.datebox.setFixedWidth(210)
        self.datebox.setStyleSheet("color: #456397;")
        self.datebox.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.datebox.setFocusPolicy(Qt.ClickFocus)
        h_layout2.addWidget(self.datebox)
        h_layout2.addStretch()

        h_layout3 = QHBoxLayout()
        h_layout3.addStretch()
        self.textbox=QLabel()
        self.textbox.setText(GLOBAL_CONFIG.LANGUAGE.get("BirthdayTip", ""))
        self.textbox.setStyleSheet("color: #456397;")
        self.textbox.setAlignment(Qt.AlignmentFlag.AlignCenter)  # 文本居中          # 固定宽度200px
        h_layout3.addWidget(self.textbox)
        h_layout3.addStretch()


        h_layout4 = QHBoxLayout()
        h_layout4.addStretch()
        self.button = QPushButton()
        self.button.setText("OK")
        self.button.setStyleSheet("color: #456397;")
        self.button.setFixedSize(120,40)
        self.button.clicked.connect(self.verify)
        h_layout4.addWidget(self.button)
        h_layout4.addStretch()

        layout.addLayout(h_layout1)
        layout.addLayout(h_layout2)
        layout.addLayout(h_layout3)
        layout.addLayout(h_layout4)
        self.setLayout(layout)

        self.closable=False

        self.play_anim()

    def verify(self):
        time=self.datebox.text()
        result=verifyDate(time)
        if result:
            setBirthdayDate(time[:2]+'-'+time[2:4])
            self.closable=True
            self.close()
        else:
            _=UI_EBSW_ErrorWindow()
class UI_EBSW_ErrorWindow(UI_PopupWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Notice")
        self.setWindowFlag(Qt.WindowType.WindowMaximizeButtonHint, False)
        self.setWindowModality(Qt.ApplicationModal)
        self.setFixedSize(250,120)
        center=self.screen().availableGeometry().center()
        self.move(center.x()-250/2, center.y()-120/2)

        layout=QVBoxLayout()
        #layout.addStretch()

        h_layout1 = QHBoxLayout()
        h_layout1.addStretch()
        self.textbox=QLabel()
        self.textbox.setText("Please enter your\n8-digit date of birth accurately.")
        self.textbox.setStyleSheet("color: #456397;")
        self.textbox.setAlignment(Qt.AlignmentFlag.AlignCenter)  # 文本居中          # 固定宽度200px
        h_layout1.addWidget(self.textbox)
        h_layout1.addStretch()


        h_layout2 = QHBoxLayout()
        h_layout2.addStretch()
        self.button = QPushButton()
        self.button.setText("OK")
        self.button.setStyleSheet("color: #456397;")
        self.button.setFixedSize(120,40)
        self.button.clicked.connect(lambda: self.close())
        h_layout2.addWidget(self.button)
        h_layout2.addStretch()

        layout.addLayout(h_layout1)
        layout.addLayout(h_layout2)
        self.setLayout(layout)

        self.play_anim()

###########################################################################
# File: windows\UI_fast_close_button_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_fast_close_button_window.py
###########################################################################

from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtWidgets import QHBoxLayout, QPushButton
from PySide6.QtCore import Qt
from getResources import GLOBAL_CONFIG
from signal_bus import signal_bus


class UI_FastCloseButtonWindow(QDialog):
    def __init__(self):
        super().__init__()
        # 设置无边框和透明背景
        self.setWindowFlags(Qt.FramelessWindowHint|Qt.WindowStaysOnTopHint|Qt.ToolTip)
        self.setAttribute(Qt.WA_TranslucentBackground, True)
        
        sw, sh = self.screen().geometry().width(), self.screen().geometry().height()
        button_size = (100, 42)
        button_border = GLOBAL_CONFIG.PREFERENCES["fastCloseButtonBorder"]
        self.setGeometry(sw-button_size[0]-10-button_border[0], 
                         sh-button_size[1]-10-button_border[1], *button_size)

        layout=QHBoxLayout()

        close_button=QPushButton()
        close_button.setText("CLOSE")
        close_button.setFixedSize(*button_size)
        close_button.setStyleSheet("font-size: 20px")
        layout.addWidget(close_button)
        
        self.setLayout(layout)

        close_button.pressed.connect(lambda: signal_bus.close_signal.emit())
        
if __name__ == '__main__':
    from PySide6.QtWidgets import QApplication
    import sys
    app = QApplication(sys.argv)
    app.setQuitOnLastWindowClosed(True)
    c=UI_FastCloseButtonWindow()
    c.show()
    sys.exit(app.exec_())

###########################################################################
# File: windows\UI_hide_desktop_icons_button_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_hide_desktop_icons_button_window.py
###########################################################################

import subprocess
import time
import winreg
from PySide6.QtWidgets import QVBoxLayout, QLabel
from PySide6.QtCore import QTimer
import functions.ImageQt
from getResources import PREFERENCES
from functions.generateUIImages import generateImage
import threading

from windows.UI_button_window import UIButtonWindow
from windows.functions import hideDesktopIcons



class UI_HideDesktopIconsButtonWindow(UIButtonWindow):
    def __init__(self, screenSize):
        images=generateImage("HideDesktopIcons")
        self.images0=[i.resize(tuple(int(x*PREFERENCES["hideDesktopIconsButtonProportion"]) for x in i.size)) for i in images]
        self.number=0 #visable
        self.border=PREFERENCES["hideDesktopIconsButtonBorder"]

        super().__init__(screenSize)

        self.size0=self.images0[0].size
        self.images=[functions.ImageQt.toqpixmap(i) for i in self.images0]

        layout=QVBoxLayout()
        self.buttonLabel=QLabel(self)
        self.buttonLabel.setPixmap(self.images[self.number])
        self.buttonLabel.setGeometry(0, 0,  *self.size0)
        self.setGeometry(screenSize[0]-self.size0[0]-self.border[0], self.border[1], *self.size0)
        layout.addWidget(self.buttonLabel)

    def change(self):
        self.number= 0 if self.number == 1 else 1
        self.changeThread=threading.Thread(target=hideDesktopIcons, args=[self.number])
        self.canChange=False
        self.changeThread.start()

        self.fixedupdate = QTimer(self)
        self.fixedupdate.timeout.connect(self.frameUpdate)
        self.startt=self.order=0
        self.fixedupdate.start(1000/30)

        self.buttonLabel.setPixmap(self.images[self.number])
        self.canChange=True

if __name__ == '__main__':
    _=UI_HideDesktopIconsButtonWindow()

###########################################################################
# File: windows\UI_input_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_input_window.py
###########################################################################

from PySide6.QtWidgets import QLineEdit, QHBoxLayout, QPushButton, QDialog
from PySide6.QtCore import Qt

from signal_bus import signal_bus

# TODO() 增加剧情式对话框
class UI_InputWindow_classic(QDialog):
    def __init__(self):
        super().__init__()
        self.setWindowFlags(Qt.Window | Qt.CustomizeWindowHint|Qt.WindowStaysOnTopHint)
        #self.setAttribute(Qt.WA_TranslucentBackground, True)
        sw, sh = self.screen().geometry().width(), self.screen().geometry().height()
        self.setFixedWidth(sw*0.95)
        self.move(sw*0.025-5, sh-110)

        layout=QHBoxLayout()

        self.textbox=QLineEdit()
        self.textbox.setFixedSize(sw*0.85, 35)
        self.textbox.setStyleSheet("font-size: 22px")
        layout.addWidget(self.textbox)

        confirmbutton=QPushButton()
        confirmbutton.setText("confirm")
        confirmbutton.setFixedHeight(35)
        layout.addWidget(confirmbutton)
        
        self.setLayout(layout)

        confirmbutton.pressed.connect(lambda: self.press())

    def press(self):
        content = self.textbox.text()
        print(f"[DEBUG]Input Content: {content}")
        self.textbox.setText("")
        self.hide()
        signal_bus.AI_dialog_input_signal.emit(content)

###########################################################################
# File: windows\UI_popup_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\UI_popup_window.py
###########################################################################

from PySide6.QtWidgets import QWidget
from PySide6.QtCore import Qt, Signal
from animation.pyside_animation_player import PysideAnimationPlayer

import time

from windows.UI_dark_screen_window import UI_DarkScreenWindow


class UI_PopupWindow(QWidget):
    anim_signal = Signal(dict)

    def __init__(self, darkScreen=True):
        super().__init__()
        self.setWindowFlags(Qt.WindowStaysOnTopHint)
        self.darkScreenWindow = None
        if darkScreen:
            self.darkScreenWindow = UI_DarkScreenWindow()
            self.darkScreenWindow.show()

    def play_anim(self, anim='UIAni_Popup_System', **kwargs):
        if anim == 'UIAni_Popup_System':
            kwargs.setdefault('path', 'Center/Popup')
            kwargs.setdefault('Pratio', (1, 0.5))

        self.position0 = (self.pos().x(), self.pos().y())
        self.move(10000, 10000)
        self.show()

        self.anim_signal.connect(self.anim_signal_received)
        self.animation_player = PysideAnimationPlayer(self.anim_signal, anim, kwargs.get('stop_time', None), **kwargs)
        self.animation_player.play()

    def anim_signal_received(self, dic):
        position = dic.get('position', (0, 0))
        self.move(*[int(x - y) for x, y in zip(self.position0, position)])

    def closeEvent(self, event):
        self.darkScreenWindow.close()

###########################################################################
# File: windows\background_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\background_window.py
###########################################################################

from PySide6.QtCore import Qt, QTimer
from PySide6.QtWidgets import QLabel, QVBoxLayout
from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtGui import QPixmap, QGuiApplication
from functions.set_background_layer import set_background_layer
class BackgroundWindow(QDialog):
    def __init__(self, app, offset):
        super().__init__()
        self.app = app
        self.offset = offset
        self.screen = QGuiApplication.primaryScreen()

        self.title = "Desktop Lobby Background"
        self.setWindowTitle(self.title)
        # 设置无边框和透明背景
        #self.setWindowFlags(Qt.FramelessWindowHint)
        #self.setAttribute(Qt.WA_TranslucentBackground, True)
        self.setWindowFlags(Qt.Window | Qt.CustomizeWindowHint)
        self.setStyleSheet("QDialog{background-color: black;}")
        screen_g = self.screen.geometry()
        self.screen_size = (screen_g.width(), screen_g.height())

        self.p_images = {}
        front_image = QPixmap('images/BG_MainOffice-16_9').scaled(*self.screen_size, Qt.AspectRatioMode.IgnoreAspectRatio, Qt.TransformationMode.SmoothTransformation)
        cloud_image = QPixmap('images/Lobby/Bg_Public_Cloud.png')
        self.p_images ['main_office'] = front_image
        self.p_images ['cloud'] = cloud_image
        layout = QVBoxLayout()

        self.main_office = QLabel()
        self.main_office.setPixmap(self.p_images['main_office'])
        self.main_office.setGeometry(0, 0, self.p_images['main_office'].width(), self.p_images['main_office'].height())
        self.main_office.setScaledContents(True)

        layout.addWidget(self.main_office)

        self.setLayout(layout)
        
        self.show()
        self.lower()
        
        QTimer.singleShot(100, self.set_pos)
        QTimer.singleShot(200, self.set_background_layer)
    def set_background_layer(self):
        set_background_layer(self.title)
    def set_pos(self):
        border_width_physical = self.get_border_width()
        offset_x, offset_y = self.offset
        self.setGeometry(-border_width_physical-offset_x, -border_width_physical-offset_y, *self.screen_size)
    def get_border_width(self):
        """获取窗口边框宽度（物理像素）"""
        frame_rect = self.frameGeometry()  # 包含边框的物理矩形
        client_rect = self.geometry()       # 客户区逻辑矩形

        # 计算左右边框总宽度（逻辑像素）
        border_width_logical = frame_rect.width() - client_rect.width()

        # 转换为物理像素（考虑 DPI 缩放）
        dpi_x = self.screen.physicalDotsPerInchX()
        dpi_y = self.screen.physicalDotsPerInchY()
        # Qt 的逻辑像素到物理像素的缩放因子
        scale_factor = dpi_x / 96.0  # 96 是 Qt 的默认 DPI
        border_width_physical = int(border_width_logical * scale_factor)

        return border_width_physical

def load_background_window(offset):
    from PySide6.QtWidgets import QApplication
    import sys
    app = QApplication(sys.argv)
    app.setQuitOnLastWindowClosed(True)
    c=BackgroundWindow(app, offset)
    sys.exit(app.exec_())


###########################################################################
# File: windows\debug_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\debug_window.py
###########################################################################

import sys
from PySide6.QtWidgets import QDialog, QVBoxLayout, QPlainTextEdit
from PySide6.QtGui import QTextCharFormat, QColor
from signal_bus import signal_bus

# 步骤1: 创建一个重定向输出的类
class PrintToSignal:
    def write(self, text):
        # 将文本追加到控件中
        signal_bus.print_signal.emit(text)

    def flush(self):
        # 兼容文件对象接口，这里可以什么都不做
        pass

class DebugWindow(QDialog):
    def __init__(self, font):
        super().__init__()
        self.font = font

        self.setWindowTitle("Debug Window")
        self.setGeometry(0, 0, 400, 200)
        layout = QVBoxLayout(self)

        # 创建用于显示print内容的控件
        self.log_output = QPlainTextEdit(self)
        self.log_output.setReadOnly(True)
        layout.addWidget(self.log_output)
        self.setLayout(layout)

        self.cursor = self.log_output.textCursor()

        # 将sys.stdout重定向到PrintToWidget实例
        signal_bus.print_signal.connect(self.print)
        self.redirector = PrintToSignal()
        sys.stdout = self.redirector

    def print(self, text):
        level_dict = {"DEBUG": "green", "ERROR": "red", "WARNING": "yellow", "": "black"}
        for level in level_dict.keys():
            if text.startswith(f"[{level}]"):
                self._write(text, QColor(level_dict[level]))

    def _write(self, text: str, color: QColor):
        fmt = QTextCharFormat()
        fmt.setForeground(color)
        fmt.setFont(self.font)

        self.cursor.movePosition(self.cursor.End)
        self.cursor.insertText(text + "\n", fmt)
        self.log_output.setTextCursor(self.cursor)
        self.log_output.ensureCursorVisible()

        signal_bus.debug_show_signal.connect(self._show_window)

    def _show_window(self, state):
        if state:
            self.show()
        else:
            self.hide()

###########################################################################
# File: windows\dialogbox_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\dialogbox_window.py
###########################################################################

from PySide6.QtCore import Qt, QTimer
from PySide6.QtWidgets import QLabel, QVBoxLayout
from custom_QDialog import CustomQDialog as QDialog
import functions.ImageQt
import pygame.mixer as mixer
import time
from getResources import PREFERENCES
from windows.functions import setopacity
from audios.sound import load_audio_file
from signal_bus import signal_bus
from getResources import GLOBAL_CONFIG


class DialogBoxWindow(QDialog):
    def __init__(self, name, dialogBoxImages, EMOTIONS, SETTINGS, k00, imageWindow):
        super().__init__()
        self.EMOTIONS = EMOTIONS
        self.SETTINGS = SETTINGS
        self.name = name
        self.dialogBoxImages = dialogBoxImages
        self.imageWindowP = imageWindow

        self.k = k00
        self.voiceVolume = PREFERENCES["defaultVoiceVolume"]
        self.aniName = None

        layout = QVBoxLayout()
        # 设置无边框和透明背景
        self.setWindowModality(Qt.NonModal)
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.ToolTip)
        self.setAttribute(Qt.WA_TranslucentBackground, True)
        self.setGeometry(SETTINGS["dialogBoxPos"][0] * self.k / GLOBAL_CONFIG.ZOOM_SCALE,
                         SETTINGS["dialogBoxPos"][1] * self.k / GLOBAL_CONFIG.ZOOM_SCALE, 1, 1)
        self.boxlabel = QLabel(self)
        self.boxlabel.setGeometry(0, 0, 1, 1)
        layout.addWidget(self.boxlabel)

        self.textlabel = QLabel(self)
        self.textlabel.setGeometry(0, 0, 1, 1)
        layout.addWidget(self.textlabel)

    def vvolumeChanged(self, data):
        self.voiceVolume = data / 100

    def showDB(self, indexes, emotions, custom=False, custom_dialogboxs=None, order=0, lasting_time=None):
        self.indexes = indexes
        self.emotions = emotions
        self.order = order
        index = self.indexes[self.order]
        if '|' in index:
            index, self.aniName = index.split('|')
        else:
            self.aniName = None
        self.emotion = self.emotions[self.order]
        if custom:
            self.dialogBox0 = custom_dialogboxs[self.order][0]
            dialogBox = self.dialogBox0.resize(
                tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogBox0.size))
            self.dialogText0 = custom_dialogboxs[self.order][1]
            dialogText = self.dialogText0.resize(
                tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogText0.size))
        else:
            self.dialogBox0 = self.dialogBoxImages[index][0]
            dialogBox = self.dialogBox0.resize(
                tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogBox0.size))
            self.dialogText0 = self.dialogBoxImages[index][1]
            dialogText = self.dialogText0.resize(
                tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogText0.size))
        PdialogBox = functions.ImageQt.toqpixmap(dialogBox)
        PdialogText = functions.ImageQt.toqpixmap(dialogText)
        self.order += 1
        if self.order == len(self.indexes):
            self.end = True
        else:
            self.end = False
        self.boxlabel.setPixmap(PdialogBox)
        self.boxlabel.setGeometry(0, 0, dialogBox.width, dialogBox.height)
        self.textlabel.setPixmap(PdialogText)
        self.textlabel.setGeometry(0, 0, dialogText.width, dialogText.height)
        if self.order == 1:
            setopacity(self.boxlabel, 0)
            setopacity(self.textlabel, 0)

        self.dialoging = self.emotionchange = True
        self.t0 = 0
        mixer.stop()

        namefile = self.name if self.name.isupper() else self.name.capitalize()
        if not custom:
            self.voice = load_audio_file(f"audios/JP_{namefile}/{self.name}_{index}.ogg")
            self.voice.set_volume(self.voiceVolume)
            self.voice.play()

        if lasting_time:
            self.length = lasting_time
        else:
            self.length = max(self.voice.get_length(), 1)
        self.fixedupdate = QTimer(self)
        self.fixedupdate.timeout.connect(self.frameUpdate)
        self.show()
        if self.aniName:
            signal_bus.dialog_anim_signal.emit(self.aniName)
        self.fixedupdate.start(1000 / 30)

    def frameUpdate(self, fadeIn=0.6, fadeOut=0.6):
        self.voice.set_volume(self.voiceVolume)
        if self.t0 == 0:
            self.t0 = time.time()
            t = 0
            self.sizeposChange(self.k)
            self.tempCanblink = getattr(self.imageWindowP.settings_parameters, 'blink')
            signal_bus.settings_signal.emit('blink', False)
            self.imageWindowP.update(self.emotion)
        else:
            t = time.time() - self.t0
        if self.dialoging and self.imageWindowP.settings_parameters.dialog:
            if 0 <= t and t <= fadeIn:
                if self.order == 1:
                    setopacity(self.boxlabel, t / fadeIn)
                else:
                    setopacity(self.boxlabel, 1)
                setopacity(self.textlabel, t / fadeIn)
            elif fadeIn < t and t <= self.length:
                setopacity(self.boxlabel, 1)
                setopacity(self.textlabel, 1)
            elif self.length < t and t <= self.length + fadeOut:
                if self.emotionchange and self.end:
                    self.imageWindowP.update(self.EMOTIONS[self.SETTINGS['defaultEmotionIndex']])
                    signal_bus.settings_signal.emit('blink', self.tempCanblink)
                    self.emotionchange = False
                if self.end:
                    setopacity(self.boxlabel, (self.length + fadeOut - t) / fadeOut)
                else:
                    setopacity(self.boxlabel, 1)
                setopacity(self.textlabel, (self.length + fadeOut - t) / fadeOut)
            else:
                setopacity(self.boxlabel, 0)
                setopacity(self.textlabel, 0)
                t = self.length + fadeOut + 1
                self.hide()
                self.dialoging = False
        elif not self.end:
            self.showDB(self.indexes, self.EMOTIONS, order=self.order)
        elif self.emotionchange:
            self.voice.stop()
            self.hide()
            setopacity(self.boxlabel, 0)
            setopacity(self.textlabel, 0)
            self.imageWindowP.update(self.EMOTIONS[self.SETTINGS['defaultEmotionIndex']])
            signal_bus.settings_signal.emit('blink', self.tempCanblink)
            self.emotionchange = self.dialoging = False

    def sizeposChange(self, data):
        self.k = data
        dialogBox = self.dialogBox0.resize(
            tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogBox0.size))
        dialogText = self.dialogText0.resize(
            tuple(int(x * self.k / GLOBAL_CONFIG.ZOOM_SCALE) for x in self.dialogText0.size))
        PdialogBox = functions.ImageQt.toqpixmap(dialogBox)
        PdialogText = functions.ImageQt.toqpixmap(dialogText)
        self.boxlabel.setPixmap(PdialogBox)
        self.textlabel.setPixmap(PdialogText)

        self.boxlabel.setFixedSize(dialogBox.width, dialogBox.height)
        self.textlabel.setFixedSize(dialogText.width, dialogText.height)

        charactercenter = self.imageWindowP.frameGeometry().center()
        self.setGeometry(charactercenter.x() + (self.SETTINGS["dialogBoxPos"][0] - self.SETTINGS['characterPos'][
            0]) * self.k / GLOBAL_CONFIG.ZOOM_SCALE - self.imageWindowP.size0[0] / 2 * self.k,
                         charactercenter.y() + (self.SETTINGS["dialogBoxPos"][1] - self.SETTINGS['characterPos'][
                             1]) * self.k / GLOBAL_CONFIG.ZOOM_SCALE - self.imageWindowP.size0[1] / 2 * self.k,
                         dialogBox.width, dialogBox.height)

    def closeEvent(self, event):
        event.ignore()

###########################################################################
# File: windows\functions.py
# Path: D:\Projects\DesktopLobby2.0\windows\functions.py
###########################################################################

import time
from typing import Dict

def get_fps(default_fps = 60):
    t = None
    def fps():
        nonlocal t
        if t:
            t0 = t
            t = time.time()
            return 1/(t - t0+0.000000001)
        else:
            t = time.time()
            return default_fps
    return fps

def convert_PIL_pictures_to_QPixmap(pictures: Dict):
    """把pillow的图片字典转换成QPixmap"""
    from functions import ImageQt
    return {x[0]: ImageQt.toqpixmap(x[1]) for x in pictures.items()}

def setopacity(label, opacity):
    """
    设置标签透明度
    """
    from PySide6.QtWidgets import QGraphicsOpacityEffect

    # 先移除旧 effect，避免重复添加
    if label.graphicsEffect():
        label.graphicsEffect().deleteLater()

    effect = QGraphicsOpacityEffect()
    label.setGraphicsEffect(effect)
    effect.setOpacity(opacity)

    # 👇 关键：将 effect 存为 label 的属性，防止被回收！
    label._opacity_effect = effect  # 保持引用


def verifyDate(date_str):
    """
    验证日期是否合法
    """
    import time
    try:
        # 将MMDDYYYY转换为MM/DD/YYYY格式以便strptime解析
        formatted_date = f"{date_str[:2]}/{date_str[2:4]}/{date_str[4:]}"
        t=time.strptime(formatted_date, "%m/%d/%Y")
        return True
    except ValueError:
        return False


def hideDesktopIcons(*args):
    """隐藏和显示桌面图标"""
    import ctypes
    import time

    user32 = ctypes.windll.user32
    try:
            # 1. 找到 Progman
        progman = user32.FindWindowW("Progman", None)
        if not progman:
            print("[ERROR]No Progman Found")
            return

        # 2. 发送 0x52C 消息，触发 WorkerW 创建（关键！）
        user32.SendMessageW(progman, 0x52C, 0, 0)

        workerw = None

        # 3. 枚举所有 WorkerW
        while True:
            workerw = user32.FindWindowExW(None, workerw, "WorkerW", None)
            if not workerw:
                break

            # 4. 在每个 WorkerW 下查找 SHELLDLL_DefView（用于判断是否是正确容器）
            defview = user32.FindWindowExW(workerw, None, "SHELLDLL_DefView", None)
            if defview:
                # 5. 在 SHELLDLL_DefView 下查找 SysListView32（真正的图标窗口）
                listview = user32.FindWindowExW(defview, None, "SysListView32", None)
                if listview:
                    # 找到了！隐藏或显示
                    user32.ShowWindow(listview, 0 if args[0] == 1 else 5)
                    break

        # 6. 隐藏/显示任务栏
        tray = user32.FindWindowW("Shell_TrayWnd", None)
        if tray:
            user32.ShowWindow(tray, 0 if args[0] == 1 else 5)
    except Exception as e:
        print("[ERROR]Hiding Failed: {e}")
    time.sleep(0.3)


###########################################################################
# File: windows\image_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\image_window.py
###########################################################################

from PySide6.QtWidgets import QApplication
from PySide6.QtCore import Qt, QTimer, Signal
from PySide6.QtWidgets import QLabel, QVBoxLayout, QMainWindow
import time
import pygame.mixer as mixer
from random import randrange
from math import sin

from windows.settings_window import SettingsWindow
from windows.dialogbox_window import DialogBoxWindow
from getResources import GLOBAL_CONFIG, global_variables
from renderDialogBox import *
from windows.UI_hide_desktop_icons_button_window import UI_HideDesktopIconsButtonWindow
from windows.functions import get_fps, convert_PIL_pictures_to_QPixmap
from signal_bus import signal_bus
from dataclasses_ import CharacterConfig, SettingsParameters
from animation.pyside_animation_player import PysideAnimationPlayer

class ImageWindow(QMainWindow):

    anim_signal = Signal(dict)

    def __init__(self, character_config: CharacterConfig):
        super().__init__()
        self.character_config = character_config
        self.settings_parameters = SettingsParameters(
            emotion=self.character_config.emotions[self.character_config.settings['defaultEmotionIndex']],
            blink=self.character_config.settings['defaultBlinkEyes'],
            dialog=self.character_config.settings['defaultDialog'],
            size=self.character_config.k0,
            voice_volume=GLOBAL_CONFIG.PREFERENCES["defaultVoiceVolume"]
        )

        self.layout = QVBoxLayout()
        # 设置无边框和透明背景
        self.setWindowFlags(Qt.FramelessWindowHint)
        self.setAttribute(Qt.WA_TranslucentBackground, True)

        self.haloPos = character_config.settings['halo']
        self.t = 0

        self.playable = False

        self.character_config.pictures = convert_PIL_pictures_to_QPixmap(self.character_config.pictures)

        self.image0 = self.character_config.pictures[self.settings_parameters.emotion]

        self.haloImageP = self.character_config.pictures['halo']

        self.halo = QLabel('halo', self)
        self.halo.setPixmap(self.haloImageP)
        self.halo.setFixedSize(self.haloImageP.width(), self.haloImageP.height())
        self.halo.move(self.haloPos[0], self.haloPos[1])
        self.layout.addWidget(self.halo)
        self.size0 = (self.image0.width(), self.image0.height() + self.character_config.halo_height)
        self.resize(self.size0[0], self.size0[1])

        self.body = QLabel('body', self)
        self.body.setPixmap(self.image0)
        self.body.setFixedSize(self.image0.width(), self.image0.height())
        self.body.move((self.width() - self.image0.width()) / 2,
                       (self.height() - self.image0.height() + self.character_config.halo_height) / 2)
        self.layout.addWidget(self.body)
        self.setLayout(self.layout)

        self.move(self.character_config.settings['characterPos'][0] * GLOBAL_CONFIG.k00 / GLOBAL_CONFIG.ZOOM_SCALE,
                  self.character_config.settings['characterPos'][1] * GLOBAL_CONFIG.k00 / GLOBAL_CONFIG.ZOOM_SCALE)
        self.sizeChange(GLOBAL_CONFIG.k00)

        self.fps = get_fps()

        self.fixedupdate = QTimer(self)
        self.fixedupdate.timeout.connect(self.frameUpdate)
        self.posHistory = []
        self.t0 = 0
        self.fixedupdate.start(1000 / GLOBAL_CONFIG.PREFERENCES['maxFPS'])

        self.dialogboxwindow = DialogBoxWindow(self.character_config.name, self.character_config.dialogBoxImages,
                                               self.character_config.emotions, self.character_config.settings,
                                               GLOBAL_CONFIG.k00, self)
        self.dialogboxwindow.show()

        if True:
            from windows.UI_input_window import UI_InputWindow_classic

            self.UI_InputWindow = UI_InputWindow_classic()
        if GLOBAL_CONFIG.PREFERENCES["fastCloseButton"]:
            from windows.UI_fast_close_button_window import UI_FastCloseButtonWindow
            self.UI_fastCloseButtonWindow = UI_FastCloseButtonWindow()
            self.UI_fastCloseButtonWindow.show()

        screen = QApplication.primaryScreen()
        self.UI_hideDesktopIconsButtonWindow = UI_HideDesktopIconsButtonWindow(
            (screen.size().width(), screen.size().height()))
        self.UI_hideDesktopIconsButtonWindow.show()
        # self.UI_ChangeCharacterModeButtonWindow = UI_ChangeCharacterModeButtonWindow((screen.size().width(), screen.size().height()))
        # self.UI_ChangeCharacterModeButtonWindow.show()

        self.settingwindow = SettingsWindow(
            GLOBAL_CONFIG.CONTRAST.get(self.character_config.name, self.character_config.name),
            self.character_config.emotions, self.character_config.settings, GLOBAL_CONFIG.k00)

        signal_bus.settings_signal.connect(self.settings_signal_received)
        signal_bus.close_signal.connect(lambda: self.closeEvent(None))
        signal_bus.dialog_anim_signal.connect(self.play_anim)
        signal_bus.AI_dialog_input_signal.connect(self.start_AI_generate)

        if self.settings_parameters.dialog:
            self.judgeEnterDialog()
        signal_bus.AI_generate_get_signal.connect(self.AI_generate)
        self.AI_firsttime = True
        self.canInput = True

        if self.character_config.firstTime:
            mixer.music.set_volume(GLOBAL_CONFIG.PREFERENCES["defaultBGMVolume"])
            signal_bus.debug_show_signal.emit(True)

    def functions_init(self, character_changed, init_AI):
        self.func_character_changed = character_changed
        self.func_init_AI = init_AI

    ######################################
    # 信号槽函数
    def settings_signal_received(self, key, value):
        if hasattr(self.settings_parameters, key):
            setattr(self.settings_parameters, key, value)

        if key == 'emotion':
            self.update(value)
        elif key == 'move':
            self.settingwindow.dialogCheck.setChecked(not self.settings_parameters.move)
            self.settingwindow.dialogCheck.setCheckable(not self.settings_parameters.move)
        elif key == 'size':
            self.sizeChange(self.settings_parameters.size)
            self.dialogboxwindow.sizeposChange(
                self.settings_parameters.size / self.character_config.settings.get('k', 1))
        elif key == 'top_level':
            if value:  # True
                # 将窗口置于顶层
                self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(Qt.FramelessWindowHint | Qt.Tool | Qt.WindowStaysOnTopHint)
                self.show()
            else:
                self.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.dialogboxwindow.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)
                self.show()

        elif key == 'bgm_volume':
            from pygame import mixer
            mixer.music.set_volume(value)
        elif key == 'voice_volume':
            self.dialogboxwindow.voiceVolume = value
        elif key == 'AI_open_new_topic' and global_variables.current_AI:
            global_variables.current_AI.b = True

        elif key == 'AI_save_state' and global_variables.current_AI:
            global_variables.current_AI.save = value
        elif key == 'character':
            self.characterChanged(value)

        # Custom
        elif key == 'terminate':
            signal_bus.close_signal.emit()
    def UI_windows_signal_received(self, key, value):
        if key == "close":
            self.hide()


    ######################################

    def update(self, data, changeCurrentEmotion=True):
        """emotion改变时运行"""
        # if changeCurrentEmotion:
        #    signal_bus.settings_signal.emit('emotion', data)
        if not data:
            data = self.character_config.emotions[0]
        self.image0 = self.character_config.pictures[data]
        self.image1 = self.image0.scaled(
            *(int(x * self.settings_parameters.size) for x in (self.image0.width(), self.image0.height())),
            Qt.AspectRatioMode.IgnoreAspectRatio, Qt.TransformationMode.SmoothTransformation)
        self.body.setPixmap(self.image1)

    def frameUpdate(self):
        """每帧运行一次"""
        blinkingtime = self.character_config.settings['blinkingTime']
        deltablinktime = self.character_config.settings['deltaBlinkTime']

        if self.t0 == 0:
            self.t0 = time.time()
            self.sblinktime = 0
        t = time.time() - self.t0
        dy = sin(t / 2) * 5 * self.settings_parameters.size / GLOBAL_CONFIG.ZOOM_SCALE
        self.halo.move(self.haloPos[0] * self.settings_parameters.size,
                       self.haloPos[1] * self.settings_parameters.size + dy)
        if self.settings_parameters.blink:
            if t - self.sblinktime > blinkingtime:
                self.update(self.settings_parameters.emotion)
                self.sblinktime = t + blinkingtime + 999999
            if t % deltablinktime < 1 / GLOBAL_CONFIG.PREFERENCES['maxFPS'] or t % deltablinktime > deltablinktime - 1 / \
                    GLOBAL_CONFIG.PREFERENCES['maxFPS']:
                self.update("eyeclose", changeCurrentEmotion=False)
                self.sblinktime = t

        currentpos = (self.pos().x(), self.pos().y())
        self.posHistory.append(currentpos)
        if any(x == 0 for x in currentpos):
            if not (self.posHistory[0] != self.posHistory[0] and self.posHistory[0] != self.posHistory[0]):
                self.move(*self.posHistory[1])
        if len(self.posHistory) > 3:
            self.posHistory.pop(0)

        # print(self.fps())

    def signalReceived(self, message):
        """接收到socket信号时的反应"""

        signal_bus.settings_signal.emit('dialog', False)
        signal_bus.settings_signal.emit('blink', False)

        indexType = {'fail': "emotionWhenFailingIndex"}[message]
        try:
            self.settingwindow.dialogCheck.setChecked(False)
            self.settingwindow.blinkCheck.setChecked(False)
            if indexType in self.character_config.settings.keys():
                self.settingwindow.emotionCombo.setCurrentIndex(self.character_config.settings[indexType])
        except Exception as e:
            print(f"[ERROR]Socket Received Error: {e}")
        self.update(self.character_config.emotions[self.character_config.settings[
            indexType]] if indexType in self.character_config.settings.keys() else self.settings_parameters.emotion)

        try:
            namefile = self.character_config.name if self.character_config.name.isupper() else self.character_config.name.capitalize()
            voice = mixer.Sound(f"audios/JP_{namefile}/{self.character_config.name}_battle_retire.ogg")
        except:
            voice = mixer.Sound("audios/mute.ogg")
        voice.set_volume(self.settings_parameters.voice_volume)
        voice.play()

    ######################################
    # AI函数

    def start_AI_generate(self, data: str):
        if self.AI_firsttime:
            global_variables.AI_thread.start()
            self.AI_firsttime = False
        exap = list(self.character_config.dialogBoxContent.values())[0]
        emo = next((s for s in self.character_config.emotions if s.startswith(exap[1])), None).split('_')[-1]
        example = ''.join(exap[0]) + '#' + emo + '#'
        signal_bus.AI_generate_send_signal.emit({'current_character': GLOBAL_CONFIG.CONTRAST.get(
            self.character_config.name.upper(), self.character_config.name), 'user_content': data, 'example': example})

    def AI_generate(self, data: dict):
        content_list, emotion = data['content_list'], data['emotion']
        emotion = [next((s for s in self.character_config.emotions if s.endswith(emotion)), None)]
        if not emotion:
            emotion = self.character_config.emotions[0]
        custom_dialogbox = render_Lobby_balloon(content_list)
        content = ''.join(content_list)
        self.dialogboxwindow.showDB([content], emotion, custom=True, custom_dialogboxs=[custom_dialogbox],
                                    lasting_time=len(content) * 0.2)
        self.canInput = True

    ######################################

    def dialog(self, indexes):
        index = indexes[randrange(0, len(indexes))]
        emotion = [next((s for s in self.character_config.emotions if
                         s.startswith(self.character_config.dialogBoxContent[inde.split('|')[0]][1])), None) for inde in
                   index]
        self.dialogboxwindow.showDB(index, emotion)

    def judgeEnterDialog(self):
        if self.character_config.today_is_birthday_sensei and "birthday_player" in self.character_config.settings.keys():
            self.dialog(self.character_config.settings["birthday_player"])
        else:
            self.dialog(self.character_config.settings["login"])


    def anim_signal_received(self, dic):
        position = dic.get('position', (0, 0))
        self.move(*[int(x - y) for x, y in zip(self.position0, position)])

    def play_anim(self, anim_name):
        """角色动画系统"""
        self.position0 = (self.pos().x(), self.pos().y())

        self.anim_signal.connect(self.anim_signal_received)
        self.animation_player = PysideAnimationPlayer(self.anim_signal, anim_name, stop_time=None, Pratio=(0.5, 0.5))
        self.animation_player.play()


    def sizeChange(self, data):
        self.settings_parameters.size = data * self.character_config.settings.get('k', 1)  # GLOBAL_CONFIG.ZOOM_SCALE
        fixedBody = self.image0.scaled(
            *(int(x * self.settings_parameters.size) for x in (self.image0.width(), self.image0.height())),
            Qt.AspectRatioMode.IgnoreAspectRatio, Qt.TransformationMode.SmoothTransformation)
        fixedHalo = self.haloImageP.scaled(
            *(int(x * self.settings_parameters.size) for x in (self.haloImageP.width(), self.haloImageP.height())),
            Qt.AspectRatioMode.IgnoreAspectRatio, Qt.TransformationMode.SmoothTransformation)
        self.resize(self.size0[0] * self.settings_parameters.size, self.size0[1] * self.settings_parameters.size)
        self.halo.setPixmap(fixedHalo)
        self.halo.setFixedSize(fixedHalo.width(), fixedHalo.height())
        self.halo.move(self.haloPos[0] * self.settings_parameters.size, self.haloPos[1] * self.settings_parameters.size)

        self.body.setPixmap(fixedBody)
        self.body.setFixedSize(fixedBody.width(), fixedBody.height())
        self.body.move(0, self.character_config.halo_height * self.settings_parameters.size)

    ######################################
    # 事件函数

    def mousePressEvent(self, event):
        if self.settings_parameters.dialog and event.button() == Qt.LeftButton:
            self.dialog(self.character_config.settings["lobby"])
        if self.settings_parameters.dialog and event.button() == Qt.RightButton:
            self.judgeEnterDialog()
        if self.settings_parameters.move and event.button() == Qt.LeftButton:
            self.dragging = True
            self.dragPosition = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()

    def mouseMoveEvent(self, event):
        if self.settings_parameters.move and Qt.LeftButton and self.dragging:
            self.move(event.globalPos() - self.dragPosition)
            event.accept()

    def mouseReleaseEvent(self, event):
        if self.settings_parameters.move and event.button() == Qt.LeftButton:
            self.dragging = False
            self.dialogboxwindow.sizeposChange(
                self.settings_parameters.size / self.character_config.settings.get('k', 1))
            event.accept()

    def keyPressEvent(self, event):
        if event.key() == 69:  # E
            self.settingwindow.show()
        elif event.key() == 67 and self.canInput and global_variables.current_AI:  # C
            self.UI_InputWindow.show()
            self.canInput = False

    def closeEvent(self, event):
        if event and not self.settings_parameters.close:
            event.ignore()
        else:
            self.hide()
            self.dialogboxwindow.fixedupdate.stop()
            self.fixedupdate.stop()
            self.settingwindow.close()
            self.dialogboxwindow.close()
            self.dialogboxwindow.voice.stop()
            if not event:
                mixer.music.stop()
                mixer.quit()
                global_variables.socket_thread.running = False
                global_variables.socket_thread.quit()
                global_variables.socket_thread.wait(100)
                QApplication.quit()

    ######################################

    def characterChanged(self, character_name):
        self.dialogboxwindow.fixedupdate.stop()
        self.fixedupdate.stop()
        self.settingwindow.hide()
        self.settingwindow.deleteLater()
        self.dialogboxwindow.voice.stop()
        self.dialogboxwindow.hide()
        self.dialogboxwindow.deleteLater()
        self.hide()
        self.deleteLater()

        self.func_character_changed(character_name.lower())
        del (self.dialogboxwindow, self.settingwindow, self)

###########################################################################
# File: windows\repeat_confirm_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\repeat_confirm_window.py
###########################################################################

from PySide6.QtWidgets import QMessageBox
def repeat_confirm(times: int):
    for x in range(times):
        msg=QMessageBox.question(None, "提示", "你确定要运行这个程序吗？"+"真的吗？"*x, QMessageBox.Yes|QMessageBox.No)
        if msg == QMessageBox.No:
            return False
    return True
        
    

###########################################################################
# File: windows\settings_window.py
# Path: D:\Projects\DesktopLobby2.0\windows\settings_window.py
###########################################################################

from PySide6.QtCore import Qt, QTimer
from custom_QDialog import CustomQDialog as QDialog
from PySide6.QtWidgets import (QLabel,
                            QVBoxLayout,
                            QComboBox,
                            QCheckBox,
                            QSlider,
                            QLineEdit,
                            QPushButton,
                            QHBoxLayout)
import pygame.mixer as mixer
from getResources import GLOBAL_CONFIG, getCurrentCharacter
from windows.AI_settings_window import AISettingsWindow
from signal_bus import signal_bus

class SettingsWindow(QDialog):
    def __init__(self, CNAME, EMOTIONS, SETTINGS, k00):
        super().__init__()
        self.setWindowTitle('Settings')
        self.setGeometry(100, 100, 200, 150)
        #self.setWindowFlags(Qt.Tool)

        layout=QVBoxLayout()

        self.emotionCombo = QComboBox()
        self.emotionCombo.addItems(EMOTIONS)
        self.emotionCombo.setCurrentIndex(SETTINGS['defaultEmotionIndex'])
        layout.addWidget(self.emotionCombo)

        self.blinkCheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Blinking eyes", ""), self)
        self.blinkCheck.setChecked(SETTINGS['defaultBlinkEyes'])
        layout.addWidget(self.blinkCheck)

        self.dialogCheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Dialog", ""), self)
        self.dialogCheck.setChecked(SETTINGS['defaultDialog'])
        layout.addWidget(self.dialogCheck)

        moveCheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Movable", ""), self)
        moveCheck.setChecked(False)
        layout.addWidget(moveCheck)

        layout.addStretch(1)

        l1=QHBoxLayout()

        sizemessage = QLabel(GLOBAL_CONFIG.LANGUAGE.get('Size', ""))
        l1.addWidget(sizemessage)

        self.Sslider = QSlider(Qt.Horizontal)
        self.Sslider.setMinimum(1000)
        self.Sslider.setMaximum(30000)
        self.Sslider.setSingleStep(1)
        self.Sslider.setValue(int(k00 *10000))
        l1.addWidget(self.Sslider)

        self.numbox = QLineEdit()
        self.numbox.setText(str(k00))
        self.numbox.setFixedWidth(38)
        l1.addWidget(self.numbox)

        layout.addLayout(l1)

        closeCheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Closable", ""), self)
        closeCheck.setChecked(True)
        layout.addWidget(closeCheck)

        levelCheck = QCheckBox(GLOBAL_CONFIG.LANGUAGE.get("Always at the Top Level", ""), self)
        levelCheck.setChecked(False)
        layout.addWidget(levelCheck)

        layout.addStretch(1)

        message1 = QLabel(GLOBAL_CONFIG.LANGUAGE.get('BGM volume', ""))
        layout.addWidget(message1)

        self.Bslider = QSlider(Qt.Horizontal)
        self.Bslider.setMinimum(0)
        self.Bslider.setMaximum(100)
        self.Bslider.setSingleStep(1)
        self.Bslider.setValue(GLOBAL_CONFIG.PREFERENCES["defaultBGMVolume"]*100)
        layout.addWidget(self.Bslider)

        message2 = QLabel(GLOBAL_CONFIG.LANGUAGE.get('Voice volume', ""))
        layout.addWidget(message2)

        self.Vslider = QSlider(Qt.Horizontal)
        self.Vslider.setMinimum(0)
        self.Vslider.setMaximum(100)
        self.Vslider.setSingleStep(1)
        self.Vslider.setValue(GLOBAL_CONFIG.PREFERENCES["defaultVoiceVolume"]*100)
        layout.addWidget(self.Vslider)

        characterCombo = QComboBox()
        fixedNames=[GLOBAL_CONFIG.CONTRAST.get(x, x) if GLOBAL_CONFIG.CONTRAST.get(x, x).isupper() else GLOBAL_CONFIG.CONTRAST.get(x, x).capitalize() for x in GLOBAL_CONFIG.CODE_NAMES]
        fixedNames=[GLOBAL_CONFIG.LANGUAGE.get(x, x) for x in fixedNames]
        characterCombo.addItems(fixedNames)
        currentcharacter=getCurrentCharacter()
        currentChar_eng=GLOBAL_CONFIG.CONTRAST.get(currentcharacter, currentcharacter).capitalize()
        characterCombo.setCurrentText(GLOBAL_CONFIG.LANGUAGE.get(currentChar_eng, currentChar_eng))
        layout.addWidget(characterCombo)

        sizemessage1 = QLabel(GLOBAL_CONFIG.LANGUAGE.get("Experimental Features", ""))
        layout.addWidget(sizemessage1)

        AIONTButton = QPushButton()
        AIONTButton.setText(GLOBAL_CONFIG.LANGUAGE.get("Start a New Topic", ""))
        layout.addWidget(AIONTButton)

        AIsettingsButton = QPushButton()
        AIsettingsButton.setText(GLOBAL_CONFIG.LANGUAGE.get("AI settings", ""))
        layout.addWidget(AIsettingsButton)

        self.setLayout(layout)

        self.AIsettingwindow=AISettingsWindow(CNAME)


        self.emotionCombo.currentIndexChanged.connect(lambda: self.send_signal('emotion', self.emotionCombo.currentText()))
        self.blinkCheck.stateChanged.connect(lambda state: self.send_signal('blink', state))
        self.dialogCheck.stateChanged.connect(lambda state: self.send_signal('dialog', state))
        moveCheck.stateChanged.connect(lambda state: self.send_signal('move', state))
        closeCheck.stateChanged.connect(lambda state: self.send_signal('close', state))
        levelCheck.stateChanged.connect(lambda state: self.send_signal('top_level', state))

        self.Sslider.valueChanged.connect(self.update_numbox)
        self.numbox.textChanged.connect(self.update_Sslider)

        self.Bslider.valueChanged.connect(lambda value: self.send_signal('bgm_volume', value/100))
        self.Vslider.valueChanged.connect(lambda value: self.send_signal('voice_volume', value/100))

        characterCombo.currentIndexChanged.connect(lambda: self.send_signal('character', GLOBAL_CONFIG.CODE_NAMES[characterCombo.currentIndex()]))

        AIONTButton.pressed.connect(lambda: self.send_signal('AI_open_new_topic', 1))
        AIsettingsButton.pressed.connect(lambda: self.AIsettingwindow.show())
        self.timer=QTimer(self)
        self.timer.timeout.connect(self.update_canchange)
        self.canchange=True
        self.timer.start(20)

    def send_signal(self, key: str, value):
        signal_bus.settings_signal.emit(key, value)

    def update_canchange(self): self.canchange=True

    def update_numbox(self, value):
        double_value = value / 10000.0
        self.numbox.setText(str(double_value))
        if self.canchange:
            self.send_signal('size', double_value)
            self.canchange=False

    def update_Sslider(self, value):
        if self.canchange:
            try:
                fvalue=min(max(float(value), 0.1), 3.0)
                int_value = int(fvalue * 10000)
                self.Sslider.setValue(int_value)
                self.numbox.setText(str(fvalue))
                #self.Sizecommunicator.data_signal.emit(fvalue)
            except ValueError:
                pass

